name: E2E (TUI Agent via tmux)

on:
  push:
    branches:
      - main
    paths:
      - "bin/**"
      - "profiles/**"
      - "tests/**"
      - ".github/workflows/e2e-agent-tui-macos.yml"
  pull_request:
    paths:
      - "bin/**"
      - "profiles/**"
      - "tests/**"
      - ".github/workflows/e2e-agent-tui-macos.yml"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref_name }}
  cancel-in-progress: true

jobs:
  e2e-tui-agent:
    runs-on: macos-latest

    steps:
      - name: Checkout branch
        uses: actions/checkout@v6

      - name: Prepare artifacts directory
        run: mkdir -p artifacts/e2e

      # ── Decide early whether live-LLM tests will run ──────────────
      - name: Check whether to run live LLM E2E checks
        id: live-llm-check
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ "${{ vars.SAFEHOUSE_E2E_LIVE }}" = "0" ]; then
            echo "enabled=false" >> "$GITHUB_OUTPUT"
          elif [ -n "${OPENAI_API_KEY}" ] || [ -n "${ANTHROPIC_API_KEY}" ]; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=false" >> "$GITHUB_OUTPUT"
          fi

      # ── Set up runtimes early so caching + install can overlap TUI ─
      - name: Set up Node (for pnpm-installed agent CLIs)
        if: steps.live-llm-check.outputs.enabled == 'true'
        uses: actions/setup-node@v6
        with:
          node-version: "lts/*"

      - name: Set up Python (for aider)
        if: steps.live-llm-check.outputs.enabled == 'true'
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: tests/e2e/agents/python/requirements.txt

      - name: Enable corepack (pnpm)
        if: steps.live-llm-check.outputs.enabled == 'true'
        run: corepack enable

      - name: Get pnpm store path
        if: steps.live-llm-check.outputs.enabled == 'true'
        id: pnpm-store
        run: echo "path=$(pnpm store path)" >> "$GITHUB_OUTPUT"

      - name: Cache pnpm store
        if: steps.live-llm-check.outputs.enabled == 'true'
        uses: actions/cache@v5
        with:
          path: ${{ steps.pnpm-store.outputs.path }}
          key: e2e-pnpm-${{ runner.os }}-${{ hashFiles('tests/e2e/agents/pnpm/package.json') }}
          restore-keys: |
            e2e-pnpm-${{ runner.os }}-

      # ── Install CLI tools via brew (single call, no auto-update) ──
      - name: Ensure tmux, rg, fd are available
        env:
          HOMEBREW_NO_AUTO_UPDATE: "1"
        run: |
          missing=()
          command -v tmux >/dev/null 2>&1 || missing+=(tmux)
          command -v rg   >/dev/null 2>&1 || missing+=(ripgrep)
          command -v fd   >/dev/null 2>&1 || missing+=(fd)
          if [ "${#missing[@]}" -gt 0 ]; then
            brew install "${missing[@]}"
          fi

      # ── Run TUI tests; install agents in background in parallel ───
      - name: Run TUI E2E checks (+ background agent install)
        env:
          SAFEHOUSE_E2E_TUI_JOBS: "4"
          # Cursor agent requires a separate Cursor login/API token and is not
          # testable with only OpenAI/Anthropic keys in CI.
          SAFEHOUSE_E2E_INSTALL_CURSOR_AGENT: "0"
        run: |
          set -o pipefail

          # Kick off agent-CLI install in the background while TUI tests run
          INSTALL_PID=""
          if [ "${{ steps.live-llm-check.outputs.enabled }}" = "true" ]; then
            ./tests/e2e/agents/install.sh > artifacts/e2e/install.log 2>&1 &
            INSTALL_PID=$!
          fi

          # TUI checks run in the foreground
          ./tests/e2e/run.sh 2>&1 | tee artifacts/e2e/tui.log

          # Wait for the background install (if any) to finish
          if [ -n "${INSTALL_PID}" ]; then
            if ! wait "${INSTALL_PID}"; then
              echo "::error::Agent CLI install failed. Log follows:"
              cat artifacts/e2e/install.log
              exit 1
            fi
          fi

      - name: Run live LLM E2E checks (optional, requires configured agent/auth)
        if: steps.live-llm-check.outputs.enabled == 'true'
        env:
          SAFEHOUSE_E2E_USE_PNPM_AGENTS: "1"
          SAFEHOUSE_E2E_ALLOW_GLOBAL_BIN: "0"
          SAFEHOUSE_E2E_LIVE_JOBS: "15"
          # In CI, unmet prerequisites should fail the job (auth/config/setup must be correct).
          SAFEHOUSE_E2E_LIVE_ALLOW_PREREQ_SKIP: "0"
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          AMP_API_KEY: ${{ secrets.AMP_API_KEY }}
          AUGMENT_API_TOKEN: ${{ secrets.AUGMENT_API_TOKEN }}
          AUGMENT_API_URL: ${{ secrets.AUGMENT_API_URL }}
          FACTORY_API_KEY: ${{ secrets.FACTORY_API_KEY }}
        run: |
          set -o pipefail
          ./tests/e2e/live/run.sh 2>&1 | tee artifacts/e2e/live.log

      - name: Write E2E summary
        if: always()
        run: ./tests/e2e/ci/gha-summary.sh artifacts/e2e/tui.log artifacts/e2e/live.log

      - name: Upload E2E logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: safehouse-e2e-logs
          path: artifacts/e2e
          if-no-files-found: ignore
