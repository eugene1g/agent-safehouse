(version 1)

;; ---------------------------------------------------------------------------
;; Agent Safehouse Static Policy (generated file)
;; Project: https://agent-safehouse.dev
;; Generated by: scripts/generate-dist.sh
;; ---------------------------------------------------------------------------

;; ---------------------------------------------------------------------------
;; Base Profile
;; Core definitions, HOME_DIR replacement token, and helper macros shared by all modules.
;; Source: 00-base.sb
;; ---------------------------------------------------------------------------

;; HOME_DIR starts as an explicit replacement placeholder.
;; Safehouse policy assembly (bin/safehouse.sh via bin/lib/policy.sh)
;; replaces this token with the resolved HOME path.
;;
;; Manual policy-only example (no generator):
;;   Replace the next line with:
;;     (define HOME_DIR "/Users/alice")
;;   and keep DATA_HOME_DIR unchanged.
(define HOME_DIR "/tmp/agent-safehouse-static-template/home")
(define DATA_HOME_DIR (string-append "/System/Volumes/Data" HOME_DIR))

(define (home-subpath rel) (subpath (string-append HOME_DIR rel)))
(define (home-literal rel) (literal (string-append HOME_DIR rel)))
(define (home-prefix rel) (prefix (string-append HOME_DIR rel)))
(define (data-home-subpath rel) (subpath (string-append DATA_HOME_DIR rel)))
(define (data-home-literal rel) (literal (string-append DATA_HOME_DIR rel)))

(deny default)

;; ---------------------------------------------------------------------------
;; System Runtime
;; Process execution, tmp/dev access, system binaries, and baseline mach services.
;; Source: 10-system-runtime.sb
;; ---------------------------------------------------------------------------

;; Agents spawn many subprocesses (shells, git, package managers, compilers), so runtime/process allowances are broad by default.

(allow file-read*
    (subpath "/usr")                                                  ;; Core system binaries and libraries required by most spawned tools.
    (subpath "/bin")                                                  ;; POSIX userland binaries used by shell/task orchestration.
    (subpath "/sbin")                                                 ;; System utilities some build/test flows invoke.
    (subpath "/opt")                                                  ;; Homebrew and other package-manager install roots.
    (subpath "/System")                                               ;; macOS runtime frameworks and system assets for dynamic linking.
    (subpath "/Library/Apple")                                        ;; Apple private frameworks touched by Node/Bun/JVM/native toolchains.
    (subpath "/Library/Frameworks")                                   ;; Global framework lookup path for language runtimes and CLIs.
    (subpath "/Library/Java")                                         ;; JVM runtime and helper assets.
    (subpath "/Library/Fonts")                                        ;; Font reads used by headless renderers/PDF/image tasks.
    (subpath "/Library/Filesystems/NetFSPlugins")                     ;; Path resolution may load NetFS plugins during filesystem lookups.
    (subpath "/Library/Preferences/Logging")                          ;; macOS logging stack reads prefs during process init.
    (literal "/Library/Preferences/.GlobalPreferences.plist")         ;; Locale/time/user defaults queried by runtimes.
    (literal "/Library/Preferences/com.apple.networkd.plist")         ;; DNS/network bootstrap reads networkd config.
    (literal "/dev")                                                  ;; /dev directory listing; shells enumerate it during initialization.
)

;; /etc and /var are symlinks into /private/* on macOS; keep this scoped to common runtime needs.
(allow file-read*
    (literal "/private")                                              ;; Required for symlink traversal under macOS /private namespace.
    (literal "/private/var")                                          ;; Required for symlink traversal to /var-backed paths.
    (subpath "/private/var/db/timezone")                              ;; Timezone DB reads used by language date/time formatting.
    (subpath "/private/var/run")                                      ;; Resolver/daemon sockets and pid files used by networking flows.
    (literal "/private/var/select/sh")                                ;; /bin/sh selector used by macOS shell launch behavior.
    (literal "/private/var/select/developer_dir")                     ;; xcode-select developer dir pointer used by build CLIs.
    (literal "/var/select/developer_dir")                             ;; Compatibility alias for developer dir pointer.
    (literal "/private/var/db/xcode_select_link")                     ;; xcode-select link lookup used by toolchain discovery.
    (literal "/var/db/xcode_select_link")                             ;; Compatibility alias for xcode-select link lookup.
    (literal "/private/etc/hosts")                                    ;; Host override file consulted by resolver stack.
    (literal "/private/etc/resolv.conf")                              ;; DNS resolver configuration used by network clients.
    (literal "/private/etc/services")                                 ;; Service name-to-port mappings used by libc lookups.
    (literal "/private/etc/protocols")                                ;; Protocol metadata used by socket/libc helpers.
    (literal "/private/etc/profile")                                  ;; Shell startup file read by login-shell invocations.
    (literal "/private/etc/bashrc")                                   ;; Bash startup file read by spawned bash sessions.
    (literal "/private/etc/zprofile")                                 ;; Zsh startup file read by login zsh sessions.
    (literal "/private/etc/zshrc")                                    ;; Zsh startup file read by interactive zsh sessions.
    (literal "/private/etc/paths")                                    ;; PATH defaults used by shell command resolution.
    (subpath "/private/etc/paths.d")                                  ;; Additional PATH fragment directory used by macOS shells.
    (literal "/private/etc/shells")                                   ;; Valid shell list read by shell/auth tooling.
    (subpath "/private/etc/ssl")                                      ;; TLS CA bundles/certs used by HTTP and package clients.
    (literal "/private/etc/localtime")                                ;; Localtime symlink read by date/time libraries.
    ;; (subpath "/private/etc")                      ;; Compatibility fallback if a tool needs broader /etc reads.
    (literal "/etc")                                                  ;; Compatibility symlink root for tools hardcoding /etc.
    (literal "/var")                                                  ;; Compatibility symlink root for tools hardcoding /var.
)

(allow file-read-metadata
    (literal "/home")                                                 ;; Probed during path resolution by some runtimes.
    (literal "/private/etc")                                          ;; Directory traversal for /etc path resolution.
    (subpath "/dev")                                                  ;; Metadata (stat) on /dev entries; readdir() on /dev triggers this for every node.
    (home-literal "/.config")                                         ;; XDG config root traversal needed by many tools (mise, gh, git, etc.).
    (home-literal "/.cache")                                          ;; XDG cache root traversal needed by tools probing cache locations.
    (home-literal "/.local")                                          ;; XDG data root traversal needed by tools probing ~/.local paths.
    (home-literal "/.local/share")                                    ;; XDG data share dir traversal needed by tools probing data locations.
    (home-literal "/.local/bin")                                      ;; Agents stat this before installing binaries into ~/.local/bin.
)

(allow file-read*
    (home-prefix "/Library/Preferences/.GlobalPreferences")           ;; User-level locale/defaults plist variants read by many frameworks.
    (home-prefix "/Library/Preferences/com.apple.GlobalPreferences")  ;; Apple namespaced variant of user GlobalPreferences.
    (home-subpath "/Library/Preferences/ByHost")                      ;; Per-host preferences read by security CLI and system frameworks.
    (home-literal "/.CFUserTextEncoding")                             ;; User text encoding prefs; read by many processes for correct string handling.
    (home-literal "/.zshenv")                                         ;; Zsh environment file read on every zsh invocation (incl. non-interactive).
    (home-literal "/.zprofile")                                       ;; Zsh profile file read by login zsh sessions.
    (home-literal "/.zshrc")                                          ;; Zsh interactive startup file read by interactive zsh sessions.
    (home-literal "/.zcompdump")                                      ;; Zsh completion dump cache used by compinit.
    (home-prefix "/.zcompdump")                                       ;; Versioned variants like .zcompdump-hostname-5.9.
    (home-literal "/.config")                                         ;; XDG config root directory listing for tool discovery.
    (home-literal "/.cache")                                          ;; XDG cache root directory listing for tool discovery.
)

;; We intentionally do NOT block broad process primitives by default: agent workflows frequently chain many subprocesses.
(allow process-exec)                                                  ;; Required to execute toolchain binaries, shells, and repo tools.
(allow process-fork)                                                  ;; Required for normal child-process trees in CLI agents.
(allow sysctl-read)                                                   ;; Runtime/process introspection used by many CLIs at startup.
(allow process-info-pidinfo)                                          ;; Process status polling for child supervision and cleanup.
(allow process-info-setcontrol)                                       ;; Process control metadata updates used by CLI runtimes.
(allow process-info* (target same-sandbox))                           ;; Allow process introspection within the same sandbox.
(allow signal (target same-sandbox))                                  ;; Allow signalling child processes for cancellation/termination.
(allow mach-priv-task-port (target same-sandbox))                     ;; Required by some runtimes for same-sandbox process controls.
(allow pseudo-tty)                                                    ;; Required for interactive terminal sessions and PTY allocation.

(allow file-read* file-write* file-ioctl
    (subpath "/tmp")                                                  ;; Primary temp dir for transient files and IPC sockets.
    (subpath "/private/tmp")                                          ;; macOS backing path for /tmp.
    (subpath "/var/folders")                                          ;; macOS per-user temp/cache roots used by many CLIs.
    (subpath "/private/var/folders")                                  ;; macOS backing path for /var/folders.
    (subpath "/dev/fd")                                               ;; Process substitution and file-descriptor access (bash <(...), /dev/fd/N).
    (literal "/dev/stdout")                                           ;; Standard output stream device.
    (literal "/dev/stderr")                                           ;; Standard error stream device.
    (literal "/dev/null")                                             ;; Null sink/source device used by scripts/tools.
    (literal "/dev/zero")                                             ;; Zero-filled device used by some runtimes/tests.
    (literal "/dev/tty")                                              ;; Controlling terminal device for interactive sessions.
    (literal "/dev/ptmx")                                             ;; PTY multiplexer required for pseudo-terminal allocation.
    (literal "/dev/autofs_nowait")                                    ;; Automount readiness check probed by most CLI processes at startup.
    (literal "/dev/dtracehelper")                                     ;; DTrace helper probed by dyld at process start; harmless read avoids log noise.
    (literal "/dev/urandom")                                          ;; Non-blocking entropy source used by crypto/token generation.
    (literal "/dev/random")                                           ;; Blocking entropy source used by some security-sensitive tools.
    (regex #"^/dev/tty")                                              ;; Dynamic tty device names created for terminal sessions.
    (regex #"^/dev/ttys")                                             ;; Alternate tty naming pattern on macOS.
    (regex #"^/dev/pty")                                              ;; Legacy PTY naming pattern used by some tools.
)

(allow mach-lookup
    (global-name "com.apple.system.notification_center")              ;; Notification center lookup done by some CLIs.
    (global-name "com.apple.system.opendirectoryd.libinfo")           ;; User/group resolution via opendirectory.
    (global-name "com.apple.logd")                                    ;; logd connection used by unified logging APIs.
    (global-name "com.apple.FSEvents")                                ;; File event stream access used by watchers.
    (global-name "com.apple.SystemConfiguration.configd")             ;; System network/config queries for resolver bootstrap.
    (global-name "com.apple.SystemConfiguration.DNSConfiguration")    ;; Node/c-ares DNS bootstrap XPC dependency.
    (global-name "com.apple.diagnosticd")                             ;; Unified logging diagnosticd backend used by many system frameworks.
    (global-name "com.apple.analyticsd")                              ;; Analytics subsystem queried during runtime initializations.
    (global-name "com.apple.dnssd.service")                           ;; DNS-SD (Bonjour) service used for DNS resolution by ssh, curl, etc.
    (global-name "com.apple.CoreServices.coreservicesd")              ;; Core Services daemon for UTI type resolution and file type identification.
    (global-name "com.apple.DiskArbitration.diskarbitrationd")        ;; Disk metadata queries probed by some frameworks during init.
    (global-name "com.apple.analyticsd.messagetracer")                ;; Analytics message tracer probed by frameworks during init.
    (global-name "com.apple.system.logger")                           ;; Legacy system logger endpoint used by some CLIs.
    (global-name "com.apple.coreservices.launchservicesd")            ;; Launch Services daemon for app registration and UTI resolution.
    (global-name "com.apple.pasteboard.1")                            ;; Pasteboard service used by pbcopy/pbpaste for clipboard access.
)

(allow system-socket)                                                 ;; AF_SYSTEM sockets used by network stack for kernel event monitoring.

(allow ipc-posix-shm-read-data
    (ipc-posix-name "apple.shm.notification_center")                  ;; Notification center shared memory segment read by system frameworks.
)

;; ---------------------------------------------------------------------------
;; Network
;; Network policy; intentionally fully open for reliable agent operation.
;; Source: 20-network.sb
;; ---------------------------------------------------------------------------

;; Threat-model note: blocking exfiltration/C2 is explicitly NOT a goal for this sandbox.
;; The goal here is reliable agent operation (package installs, API calls, web fetches, local servers).

(allow network*)  ;; Allow outbound + inbound traffic so agent tooling and localhost dev servers work by default.

;; Strict policy examples (disabled by default):
;; 1) Comment out `(allow network*)` above.
;; 2) Uncomment ONE block below.

;; Example A: outbound only (no listening sockets)
;; (allow network-outbound)                     ;; Tight mode: keep fetch/install/API access, block listening sockets.

;; Example B: outbound + localhost-only dev servers
;; (allow network-outbound)                     ;; Tight mode: keep outbound access.
;; (allow network-bind (local ip "localhost:*"))  ;; Tight mode: only allow binding local dev-server ports.
;; (allow network-inbound (local ip "localhost:*"))  ;; Tight mode: only allow localhost clients to connect.

;; ---------------------------------------------------------------------------
;; Toolchain: Bun
;; Bun runtime, installer, and cache paths.
;; Source: 30-toolchains/bun.sb
;; ---------------------------------------------------------------------------

;; Canonical Bun paths from docs:
;; - BUN_INSTALL defaults to ~/.bun
;; - install.cache.dir defaults to ~/.bun/install/cache
;; - install.globalDir defaults to ~/.bun/install/global
;; - install.globalBinDir defaults to ~/.bun/bin
;; - global bunfig path is ~/.bunfig.toml (or $XDG_CONFIG_HOME/.bunfig.toml)
;; Also include common cache/state variants seen on macOS.

(allow file-read* file-write*
    (home-subpath "/.bun")
    (home-subpath "/.cache/bun")
    (home-subpath "/.local/state/bun")
    (home-subpath "/.local/share/bun")
    (home-subpath "/Library/Caches/bun")
    (home-literal "/.bunfig.toml")
    (home-literal "/.config/bunfig.toml")
)

;; ---------------------------------------------------------------------------
;; Toolchain: Deno
;; Deno runtime, cache, and config paths.
;; Source: 30-toolchains/deno.sb
;; ---------------------------------------------------------------------------

(allow file-read* file-write*
    (home-subpath "/.deno")
    (home-subpath "/.cache/deno")
    (home-subpath "/Library/Caches/deno")
)

;; ---------------------------------------------------------------------------
;; Toolchain: Go
;; Go toolchain, module cache, and build cache paths.
;; Source: 30-toolchains/go.sb
;; ---------------------------------------------------------------------------

;; Adjust for your GOPATH/GOMODCACHE conventions as needed.
;; Defaults on many setups:
;; - GOPATH: ~/go
;; - GOCACHE: ~/.cache/go-build or ~/Library/Caches/go-build

(allow file-read* file-write*
    (home-subpath "/go")
    (home-subpath "/.cache/go-build")
    (home-subpath "/Library/Caches/go-build")
    (home-subpath "/.config/go")
    (home-subpath "/.cache/golangci-lint")
    (home-subpath "/Library/Caches/golangci-lint")
    (home-subpath "/.config/golangci-lint")
    (home-subpath "/.local/share/go")
    (home-subpath "/.goenv")
    (home-subpath "/.cache/gopls")
)

;; ---------------------------------------------------------------------------
;; Toolchain: Java
;; Java runtime, Maven, Gradle, SBT, and Coursier paths.
;; Source: 30-toolchains/java.sb
;; ---------------------------------------------------------------------------

;; Includes common Maven/Gradle/SBT/Coursier and Java runtime manager locations.

(allow file-read* file-write*
    (home-subpath "/.m2")
    (home-subpath "/.gradle")
    (home-subpath "/.ivy2")
    (home-subpath "/.sbt")
    (home-subpath "/.jenv")
    (home-subpath "/.sdkman")
    (home-subpath "/.cache/coursier")
    (home-subpath "/.coursier")
    (home-subpath "/Library/Application Support/Coursier")
    (home-subpath "/Library/Caches/Coursier")
    (home-subpath "/.java")
    (home-literal "/.mavenrc")
)

;; ---------------------------------------------------------------------------
;; Toolchain: Node.js
;; Node.js runtime with npm, yarn, pnpm, and corepack package manager paths.
;; Source: 30-toolchains/node.sb
;; ---------------------------------------------------------------------------

;; Keep writes scoped to Node-specific directories only.
;; Intentionally avoid broad RW grants like ~/.cache, ~/Library/Caches, ~/.local/share, ~/.local/state.
;; This list includes common + observed-on-machine Node ecosystem caches.

(allow file-read* file-write*
    ;; Node version managers.
    (home-subpath "/.nvm")
    (home-subpath "/.fnm")

    ;; npm
    (home-subpath "/.npm")
    (home-subpath "/.config/npm")
    (home-subpath "/.cache/npm")
    (home-subpath "/.cache/node")
    (home-subpath "/.cache/prisma")
    (home-subpath "/Library/Caches/npm")
    (home-literal "/.npmrc")

    ;; configstore (npm ecosystem config persistence)
    (home-subpath "/.config/configstore")

    ;; node-gyp
    (home-subpath "/.node-gyp")
    (home-subpath "/.cache/node-gyp")

    ;; pnpm
    (home-subpath "/.config/pnpm")
    (home-subpath "/.pnpm-state")
    (home-subpath "/.pnpm-store")
    (home-subpath "/.local/share/pnpm")
    (home-subpath "/.local/state/pnpm")
    (home-subpath "/Library/pnpm")
    (home-subpath "/Library/Caches/pnpm")
    (home-subpath "/Library/Preferences/pnpm")  ;; pnpm-managed global npmrc lives here.

    ;; yarn (classic + modern)
    (home-subpath "/.yarn")
    (home-literal "/.yarnrc")
    (home-literal "/.yarnrc.yml")
    (home-subpath "/.config/yarn")
    (home-subpath "/.cache/yarn")
    (home-subpath "/Library/Caches/Yarn")

    ;; corepack
    (home-subpath "/.cache/node/corepack")
    (home-subpath "/Library/Caches/node/corepack")

    ;; browser automation / test runners
    (home-subpath "/Library/Caches/ms-playwright")
    (home-subpath "/Library/Caches/Cypress")

    ;; Node ecosystem caches used by CLIs and language tooling
    (home-subpath "/Library/Caches/typescript")
    (home-subpath "/Library/Caches/prisma-nodejs")
    (home-subpath "/Library/Caches/checkpoint-nodejs")
    (home-subpath "/Library/Caches/claude-cli-nodejs")

    ;; Turborepo
    (home-subpath "/.cache/turbo")
    (home-subpath "/Library/Caches/turbo")
    (home-subpath "/Library/Application Support/turborepo")

)

;; ---------------------------------------------------------------------------
;; Toolchain: Perl
;; Perl runtime, cpan/cpanm, and version-manager paths.
;; Source: 30-toolchains/perl.sb
;; ---------------------------------------------------------------------------

;; Includes common Perl version managers and package/cache locations.

(allow file-read* file-write*
    (home-subpath "/.perlbrew")
    (home-subpath "/.plenv")
    (home-subpath "/.cpan")
    (home-subpath "/.cpanm")
    (home-subpath "/.perl-cpm")
    (home-subpath "/perl5")
    (home-subpath "/.local/lib/perl5")
    (home-subpath "/Library/Caches/cpanm")
    (home-literal "/.cpanrc")
)

;; ---------------------------------------------------------------------------
;; Toolchain: PHP
;; PHP runtime and Composer paths.
;; Source: 30-toolchains/php.sb
;; ---------------------------------------------------------------------------

;; Includes common Composer + PHP env/cache locations.

(allow file-read* file-write*
    (home-subpath "/.composer")
    (home-subpath "/.config/composer")
    (home-subpath "/.cache/composer")
    (home-subpath "/Library/Caches/composer")
    (home-subpath "/.local/share/composer")
    (home-subpath "/.phpenv")
    (home-subpath "/.config/php")
    (home-subpath "/.cache/php")
    (home-literal "/.pearrc")
)

;; ---------------------------------------------------------------------------
;; Toolchain: Python
;; Python runtime, pip, uv, and virtualenv paths.
;; Source: 30-toolchains/python.sb
;; ---------------------------------------------------------------------------

;; Covers common Python package/cache/config paths, plus uv binaries/state.
;; Do not grant blanket writes to ~/.local/bin; per-agent modules grant entrypoint-specific binary writes.

(allow file-read* file-write*
    (home-literal "/.local/bin/uv")            ;; uv binary observed in ~/.local/bin on this machine.
    (home-literal "/.local/bin/uvx")           ;; uvx companion binary observed in ~/.local/bin.
    (home-subpath "/.local/share/uv")          ;; uv tool metadata and installed tool/runtime state.
    (home-subpath "/.local/state/uv")          ;; uv state/cache metadata on XDG-style setups.
    (home-subpath "/.local/pipx")              ;; pipx-managed virtualenvs and shared python runtime.
    (home-subpath "/.cache/uv")                ;; uv download/build cache for fast repeated runs.
    (home-subpath "/Library/Caches/uv")        ;; macOS cache variant used by some uv installs.
    (home-subpath "/.config/uv")               ;; uv config reads/writes during tool resolution.
    (home-subpath "/.cache/pip")               ;; pip cache writes used by Python package installs.
    (home-subpath "/.config/pip")              ;; pip config reads for index/auth/behavior settings.
    (home-subpath "/Library/Caches/pip")       ;; macOS pip cache location used by some Python setups.
    (home-subpath "/.cache/pypoetry")          ;; Poetry dependency cache for Python project tasks.
    (home-subpath "/.config/pypoetry")         ;; Poetry config used during install/publish operations.
    (home-subpath "/.local/share/pypoetry")    ;; Poetry local state and virtualenv metadata.
    (home-subpath "/Library/Caches/pypoetry")  ;; macOS Poetry cache variant.
    (home-subpath "/.cache/pdm")               ;; PDM dependency/cache data.
    (home-subpath "/.config/pdm")              ;; PDM config files.
    (home-subpath "/.local/share/pdm")         ;; PDM local metadata/state.
    (home-subpath "/.cache/pre-commit")        ;; pre-commit hook environment cache.
    (home-subpath "/.cache/mypy")              ;; mypy incremental/type cache.
    (home-subpath "/.cache/ruff")              ;; Ruff lint/format cache.
    (home-subpath "/.virtualenvs")             ;; virtualenvwrapper default location.
    (home-subpath "/.ipython")                 ;; IPython history/profile data.
    (home-subpath "/.jupyter")                 ;; Jupyter runtime/config paths in home.
    (home-subpath "/.pyenv")                   ;; pyenv interpreter shims/versions used by many repos.
    (home-literal "/.pypirc")                  ;; Python package index credentials/config file path.
    (home-literal "/.python_history")          ;; REPL history file touched by Python subprocess sessions.
    ;; conda / miniconda / miniforge
    (home-subpath "/.conda")
    (home-subpath "/miniconda3")
    (home-subpath "/miniforge3")
    (home-literal "/.condarc")
    ;; hatch
    (home-subpath "/.cache/hatch")
    (home-subpath "/.config/hatch")
    (home-subpath "/.local/share/hatch")
)

;; ---------------------------------------------------------------------------
;; Toolchain: Ruby
;; Ruby runtime, gem, and bundler cache paths.
;; Source: 30-toolchains/ruby.sb
;; ---------------------------------------------------------------------------

;; Covers common Ruby managers and gem/bundler caches.

(allow file-read* file-write*
    (home-subpath "/.rbenv")
    (home-subpath "/.rvm")
    (home-subpath "/.rubies")
    (home-subpath "/.bundle")
    (home-subpath "/.gem")
    (home-subpath "/.cache/bundler")
    (home-subpath "/.cache/rubygems")
    (home-subpath "/Library/Caches/bundle")
    (home-literal "/.gemrc")
    (home-literal "/.irbrc")
    (home-literal "/.irb_history")
    (home-literal "/.pryrc")
    (home-literal "/.pry_history")
)

;; ---------------------------------------------------------------------------
;; Toolchain: Runtime Managers
;; Cross-language version managers (mise, asdf, proto, pkgx).
;; Source: 30-toolchains/runtime-managers.sb
;; ---------------------------------------------------------------------------

;; Keep these separate from node.sb so Node toolchain policy stays focused.

(allow file-read* file-write*
    ;; mise
    (home-subpath "/.config/mise")
    (home-subpath "/.local/share/mise")
    (home-subpath "/.local/state/mise")
    (home-subpath "/.cache/mise")
    (home-subpath "/Library/Caches/mise")
    (home-literal "/.mise.toml")

    ;; volta
    (home-subpath "/.volta")

    ;; asdf
    (home-subpath "/.asdf")
    (home-subpath "/.config/asdf")
    (home-subpath "/.local/share/asdf")
    (home-subpath "/.local/state/asdf")
    (home-subpath "/.cache/asdf")
    (home-subpath "/Library/Caches/asdf")
    (home-literal "/.asdfrc")
    (home-literal "/.tool-versions")

    ;; proto
    (home-subpath "/.proto")
    (home-literal "/.prototools")

    ;; pkgx
    (home-subpath "/.pkgx")
    (home-subpath "/.local/share/pkgx")
    (home-subpath "/.cache/pkgx")
    (home-subpath "/Library/Caches/pkgx")
    (home-subpath "/Library/Packages")
)

;; ---------------------------------------------------------------------------
;; Toolchain: Rust
;; Rust toolchain via rustup/cargo, including config, cache, and optional sccache.
;; Source: 30-toolchains/rust.sb
;; ---------------------------------------------------------------------------

;; Includes common cargo config/cache locations and optional sccache.

(allow file-read* file-write*
    (home-subpath "/.cargo")
    (home-subpath "/.config/cargo")
    (home-subpath "/.rustup")
    (home-subpath "/.cache/cargo")
    (home-subpath "/Library/Caches/cargo")
    (home-subpath "/.cache/sccache")
    (home-subpath "/Library/Caches/sccache")
    (home-subpath "/Library/Application Support/Mozilla.sccache")
)

;; ---------------------------------------------------------------------------
;; Category: Shared Agent Context
;; Shared permissions for skills, agents, and guidance files.
;; Source: 40-shared/agent-common.sb
;; ---------------------------------------------------------------------------

;; Shared authoring context:
;; - ~/.skills/ (full access)
;; - ~/.agents/ (full access)
;; - ~/AGENTS.md (full access)

(allow file-read* file-write*
    (home-subpath "/.skills")         ;; Shared skill instructions/scripts that agents may read or update.
    (data-home-subpath "/.skills")    ;; Same skill access on macOS Data volume path aliases.
    (home-subpath "/.agents")         ;; Agent config/skills directory (alternate location alongside ~/.skills).
    (data-home-subpath "/.agents")
    (home-literal "/AGENTS.md")       ;; Shared agent policy/instructions file read+write for local workflows.
    (data-home-literal "/AGENTS.md")  ;; Same AGENTS.md access on macOS Data volume path aliases.
)

;; Opt-in integrations not enabled: docker macos-gui electron
;; Use --enable=<feature> (comma-separated) to include them.
;; Note: --enable=electron also enables macos-gui.

;; Threat-model note: blocking exfiltration/C2 is explicitly NOT a goal for this sandbox.

;; ---------------------------------------------------------------------------
;; Integration: 1Password
;; 1Password desktop app and CLI agent socket access.
;; Source: 50-integrations-core/1password.sb
;; ---------------------------------------------------------------------------

(allow file-read* file-write*
    (home-subpath "/.config/op")                               ;; 1Password CLI (op) config and session tokens.
    (home-subpath "/.1password")                               ;; 1Password SSH agent symlink dir (includes ~/.1password/agent.sock).
    (subpath "/Users/Shared/.1password")                       ;; Some installs use shared path for SSH agent socket.
    (regex (string-append "^" HOME_DIR "/Library/Group Containers/[A-Za-z0-9]+\\.com\\.1password/t(/.*)?$"))       ;; 1Password SSH agent socket directory (team prefix varies).
    (regex (string-append "^" DATA_HOME_DIR "/Library/Group Containers/[A-Za-z0-9]+\\.com\\.1password/t(/.*)?$"))  ;; Data-volume variant for APFS firmlink traversal.
)

;; 1Password SSH agent config
(allow file-read*
    (home-subpath "/.config/1Password")  ;; ssh/agent.toml — controls which keys are offered.
)

(allow mach-lookup
    (global-name-regex #"^([A-Z0-9]+\\.)?com\\.1password\\.")  ;; 1Password app/service IPC endpoints.
    (global-name-regex #"^com\\.agilebits\\.")                 ;; Legacy AgileBits service names still used by some installs.
)

;; ---------------------------------------------------------------------------
;; Integration: Browser Native Messaging
;; Browser native messaging host registration (Chromium + Firefox) and Chromium extension detection.
;; Source: 50-integrations-core/browser-native-messaging.sb
;; ---------------------------------------------------------------------------

;; Three things are needed per Chromium browser:
;;   1. Directory listing on the browser root (check if browser is installed)
;;   2. Read+write on NativeMessagingHosts (register/update the native messaging manifest)
;;   3. Read on Default/Extensions (check if a specific extension is installed)
;; Firefox support only needs NativeMessagingHosts registration paths.
;; Extensions dir only contains publicly-available extension source/manifests — no browsing data.
;; No access to cookies, passwords, history, bookmarks, or profile data.

(allow file-read*
    (home-literal "/Library/Application Support/Google/Chrome")
    (home-literal "/Library/Application Support/BraveSoftware/Brave-Browser")
    (home-literal "/Library/Application Support/Arc/User Data")
    (home-literal "/Library/Application Support/Microsoft Edge")
    (home-literal "/Library/Application Support/Chromium")
    (home-literal "/Library/Application Support/Vivaldi")
    (home-literal "/Library/Application Support/com.operasoftware.Opera")
    (home-literal "/Library/Application Support/Firefox")
    (home-literal "/Library/Application Support/Mozilla")
    (data-home-literal "/Library/Application Support/Google/Chrome")
    (data-home-literal "/Library/Application Support/BraveSoftware/Brave-Browser")
    (data-home-literal "/Library/Application Support/Arc/User Data")
    (data-home-literal "/Library/Application Support/Microsoft Edge")
    (data-home-literal "/Library/Application Support/Chromium")
    (data-home-literal "/Library/Application Support/Vivaldi")
    (data-home-literal "/Library/Application Support/com.operasoftware.Opera")
    (data-home-literal "/Library/Application Support/Firefox")
    (data-home-literal "/Library/Application Support/Mozilla")
    (home-subpath "/Library/Application Support/Google/Chrome/Default/Extensions")
    (home-subpath "/Library/Application Support/BraveSoftware/Brave-Browser/Default/Extensions")
    (home-subpath "/Library/Application Support/Arc/User Data/Default/Extensions")
    (home-subpath "/Library/Application Support/Microsoft Edge/Default/Extensions")
    (home-subpath "/Library/Application Support/Chromium/Default/Extensions")
    (home-subpath "/Library/Application Support/Vivaldi/Default/Extensions")
    (home-subpath "/Library/Application Support/com.operasoftware.Opera/Default/Extensions")
    (data-home-subpath "/Library/Application Support/Google/Chrome/Default/Extensions")
    (data-home-subpath "/Library/Application Support/BraveSoftware/Brave-Browser/Default/Extensions")
    (data-home-subpath "/Library/Application Support/Arc/User Data/Default/Extensions")
    (data-home-subpath "/Library/Application Support/Microsoft Edge/Default/Extensions")
    (data-home-subpath "/Library/Application Support/Chromium/Default/Extensions")
    (data-home-subpath "/Library/Application Support/Vivaldi/Default/Extensions")
    (data-home-subpath "/Library/Application Support/com.operasoftware.Opera/Default/Extensions")
)

(allow file-read* file-write*
    (home-subpath "/Library/Application Support/Google/Chrome/NativeMessagingHosts")
    (home-subpath "/Library/Application Support/BraveSoftware/Brave-Browser/NativeMessagingHosts")
    (home-subpath "/Library/Application Support/Arc/User Data/NativeMessagingHosts")
    (home-subpath "/Library/Application Support/Microsoft Edge/NativeMessagingHosts")
    (home-subpath "/Library/Application Support/Chromium/NativeMessagingHosts")
    (home-subpath "/Library/Application Support/Vivaldi/NativeMessagingHosts")
    (home-subpath "/Library/Application Support/com.operasoftware.Opera/NativeMessagingHosts")
    (home-subpath "/Library/Application Support/Mozilla/NativeMessagingHosts")
    (data-home-subpath "/Library/Application Support/Google/Chrome/NativeMessagingHosts")
    (data-home-subpath "/Library/Application Support/BraveSoftware/Brave-Browser/NativeMessagingHosts")
    (data-home-subpath "/Library/Application Support/Arc/User Data/NativeMessagingHosts")
    (data-home-subpath "/Library/Application Support/Microsoft Edge/NativeMessagingHosts")
    (data-home-subpath "/Library/Application Support/Chromium/NativeMessagingHosts")
    (data-home-subpath "/Library/Application Support/Vivaldi/NativeMessagingHosts")
    (data-home-subpath "/Library/Application Support/com.operasoftware.Opera/NativeMessagingHosts")
    (data-home-subpath "/Library/Application Support/Mozilla/NativeMessagingHosts")
)

;; ---------------------------------------------------------------------------
;; Integration: CleanShot
;; Read access to CleanShot screenshot/recording media for pasting into agents.
;; Source: 50-integrations-core/cleanshot.sb
;; ---------------------------------------------------------------------------

(allow file-read*
    (home-subpath "/Library/Application Support/CleanShot/media")       ;; Screenshot and recording files saved by CleanShot X.
    (data-home-subpath "/Library/Application Support/CleanShot/media")  ;; Data-volume variant for APFS firmlink traversal.
)

;; ---------------------------------------------------------------------------
;; Integration: Cloud Credentials
;; Cloud provider CLI/SDK credential, config, and cache access.
;; Source: 50-integrations-core/cloud-credentials.sb
;; ---------------------------------------------------------------------------

;; Threat-model note: preventing exfiltration/C2 is NOT a goal; this keeps cloud tooling usable when needed.
;; Use --append-profile to selectively deny specific providers (e.g. block ~/.aws reads).

(allow file-read* file-write*
    (home-subpath "/.aws")            ;; AWS profiles/sso/cache files needed for aws cli and SDK auth flows.
    (home-subpath "/.config/gcloud")  ;; gcloud account/config/token files needed for CLI auth and project commands.
    (home-subpath "/.azure")          ;; Azure CLI config, credentials, and token cache.
    (home-subpath "/.azd")            ;; Azure Developer CLI environment/auth state.
)

;; ---------------------------------------------------------------------------
;; Integration: Git
;; Git client configuration and XDG config directory access.
;; Source: 50-integrations-core/git.sb
;; ---------------------------------------------------------------------------

(allow file-read*
    (home-prefix "/.gitconfig")    ;; User gitconfig and variants (.gitconfig.local, etc.) read by git CLI.
    (home-subpath "/.config/git")  ;; XDG-style git config directory (config, ignore, attributes).
    (home-literal "/.gitattributes")  ;; Global gitattributes file.
)

;; ---------------------------------------------------------------------------
;; Integration: Keychain
;; macOS Keychain and Security framework for agent authentication and TLS.
;; Source: 50-integrations-core/keychain.sb
;; ---------------------------------------------------------------------------

;; Most agents (Claude Code, Amp, etc.) store login/auth tokens in the macOS Keychain.
;; Without this, agents cannot authenticate and will fail to start.
;; Read+write access is needed for credential storage, retrieval, and TLS certificate validation.

(allow file-read* file-write*
    (home-subpath "/Library/Keychains")                        ;; Keychain DB/files for CLI login sessions using macOS credentials.
    (data-home-subpath "/Library/Keychains")                   ;; Same keychain access on macOS Data volume path aliases.
)

(allow file-read-metadata
    (home-literal "/Library")                                  ;; Restrict home traversal to the Library root only.
    (home-literal "/Library/Keychains")                        ;; User keychain directory metadata for login/session lookups.
    (data-home-literal "/Library")                             ;; Same traversal on macOS Data volume path aliases.
    (data-home-literal "/Library/Keychains")                   ;; Same keychain metadata on macOS Data volume path aliases.
    (literal "/Library")                                       ;; System Library traversal for system keychain access.
    (literal "/Library/Keychains")                             ;; System keychain directory metadata.
)

(allow file-read* file-write*
    (home-literal "/Library/Preferences/com.apple.security.plist")   ;; User security preferences touched by some auth flows.
    (data-home-literal "/Library/Preferences/com.apple.security.plist") ;; Same preferences path on macOS Data volume aliases.
    (literal "/Library/Preferences/com.apple.security.plist")  ;; Security preferences read/written by security CLI.
)

(allow file-read*
    (literal "/Library/Keychains/System.keychain")             ;; System keychain read for security CLI operations.
)

(allow mach-lookup
    (global-name "com.apple.SecurityServer")                   ;; Keychain operations depend on SecurityServer IPC.
    (global-name "com.apple.security.agent")                   ;; Login prompts/token unlock dialogs route through this service.
    (global-name "com.apple.securityd.xpc")                    ;; securityd backend needed for certificate/key queries.
    (global-name "com.apple.security.authhost")                ;; Auth host service for interactive credential flows.
    (global-name "com.apple.secd")                             ;; Secure enclave/credential mediation used by macOS security APIs.
    (global-name "com.apple.trustd.agent")                     ;; Certificate trust evaluation for HTTPS/API clients.
    (global-name "com.apple.trustd")                           ;; trustd backend used by TLS validation during network calls.
)

(allow ipc-posix-shm-read-data ipc-posix-shm-write-create ipc-posix-shm-write-data
    (ipc-posix-name "com.apple.AppleDatabaseChanged")          ;; Keychain database change notifications via shared memory.
)

;; ---------------------------------------------------------------------------
;; Integration: SCM CLIs
;; GitHub CLI (gh) and GitLab CLI (glab) config, cache, and state access.
;; Source: 50-integrations-core/scm-clis.sb
;; ---------------------------------------------------------------------------

;; Threat-model note: preventing exfiltration/C2 is NOT a goal; this keeps SCM workflows available to agents.

(allow file-read* file-write*
    (home-subpath "/.config/gh")             ;; gh auth tokens/config for repo and PR automation.
    (home-subpath "/.cache/gh")              ;; gh cache for API and command acceleration.
    (home-subpath "/.local/share/gh")        ;; gh persistent state and extensions.
    (home-subpath "/.local/state/gh")        ;; gh runtime state files.
    (home-subpath "/.config/glab-cli")       ;; glab auth tokens/config for GitLab automation.
    (home-subpath "/.cache/glab-cli")        ;; glab cache for API and command acceleration.
    (home-subpath "/.local/share/glab-cli")  ;; glab persistent state.
    (home-subpath "/.local/state/glab-cli")  ;; glab runtime state files.
)

;; ---------------------------------------------------------------------------
;; Integration: Spotlight
;; Spotlight search via mdfind/mdls/mdutil for filesystem indexing.
;; Source: 50-integrations-core/spotlight.sb
;; ---------------------------------------------------------------------------

(allow file-read* file-write*
    (subpath "/private/var/db/mds")                    ;; Spotlight metadata store; also hosts se_SecurityMessages used by keychain.
)

(allow mach-lookup
    (global-name "com.apple.metadata.mds")             ;; Primary Spotlight metadata server used by mdfind/mdls queries.
    (global-name "com.apple.metadata.mds.legacy")      ;; Legacy Spotlight query interface still used by some tools.
    (global-name "com.apple.PowerManagement.control")  ;; Power state queries used by spotlightknowledged helper.
)

;; ---------------------------------------------------------------------------
;; Integration: SSH
;; SSH agent sockets, system config, key deny rules, and safe config access.
;; Source: 50-integrations-core/ssh.sb
;; ---------------------------------------------------------------------------

;; Consolidates agent socket access, system config reads, key deny rules, and safe config allowances.

;; Defense-in-depth: block private key reads/writes by default.
(deny file-read* file-write*
    (home-subpath "/.ssh")                                          ;; Block SSH key reads and tampering from any jailed agent process.
    (data-home-subpath "/.ssh")                                     ;; Same deny for macOS Data volume path aliases.
)

;; Directory traversal so specific-file allows below can resolve through ~/.ssh.
(allow file-read-metadata
    (home-literal "/.ssh")
    (data-home-literal "/.ssh")
)

;; Allow non-sensitive SSH metadata that agents need for git/remote operations.
(allow file-read*
    (home-literal "/.ssh/known_hosts")                              ;; Host verification for GitHub/remote connections.
    (home-literal "/.ssh/config")                                   ;; Custom host definitions used by git-ssh and scp.
    (home-subpath "/.ssh/config.d")                                 ;; Include-based SSH config fragments.
    (home-literal "/.ssh/allowed_signers")                          ;; SSH signature verification (git commit signing).
    (literal "/private/etc/ssh/ssh_config")                         ;; System SSH client config read during ssh/git-ssh connections.
    (subpath "/private/etc/ssh/ssh_config.d")                       ;; SSH config.d drop-in directory read by modern ssh clients.
    (literal "/private/etc/ssh/crypto.conf")                        ;; System-wide SSH crypto policy (ciphers, MACs, KEX algorithms).
    (subpath "/private/etc/ssh/crypto")                             ;; SSH crypto config subdirectory (e.g. apple.conf).
)

;; Allow writing known_hosts so first-connect host key acceptance persists.
(allow file-write*
    (home-literal "/.ssh/known_hosts")                              ;; Persist host keys on first connection.
    (home-literal "/.ssh/known_hosts.old")                          ;; Rotated during host key updates.
)

;; SSH agent socket access via launchd-managed SSH_AUTH_SOCK.
(allow file-read* file-write*
    (regex #"^/private/tmp/com\.apple\.launchd\.[^/]+/Listeners$")  ;; launchd-managed SSH_AUTH_SOCK path on macOS.
    (regex #"^/tmp/com\.apple\.launchd\.[^/]+/Listeners$")          ;; symlinked tmp variant of SSH_AUTH_SOCK path.
)

;; ---------------------------------------------------------------------------
;; Agent: Aider
;; Aider CLI binary, state, and config paths.
;; Source: 60-agents/aider.sb
;; ---------------------------------------------------------------------------

;; - pipx-style binary location: ~/.local/bin/aider
;; - local state/config
;; - package updates are package-manager driven via python toolchain paths

(allow file-read* file-write*
    (home-prefix "/.local/bin/aider")
    (home-prefix "/.local/bin/aider-install")
    (home-prefix "/.aider")
    (home-subpath "/.config/aider")
    (home-subpath "/.cache/aider")
    (home-subpath "/.local/share/aider")
)

;; ---------------------------------------------------------------------------
;; Agent: Amp
;; Amp CLI binary, state, and config paths.
;; Source: 60-agents/amp.sb
;; ---------------------------------------------------------------------------

;; - install script binary locations:
;;   - ~/.amp/bin/amp
;;   - ~/.local/bin/amp (symlink target)
;; - local state/config

(allow file-read* file-write*
    (home-prefix "/.amp/bin/amp")
    (home-prefix "/.local/bin/amp")
    (home-subpath "/.amp")
    (home-subpath "/.config/amp")
    (home-subpath "/.cache/amp")
    (home-subpath "/.local/share/amp")
    (home-subpath "/.local/state/amp")
)

;; ---------------------------------------------------------------------------
;; Agent: Auggie
;; Auggie CLI binary, state, and config paths.
;; Source: 60-agents/auggie.sb
;; ---------------------------------------------------------------------------

;; - npm global install path follows package-manager prefix/bin
;; - ~/.local/bin is the common user-level target and fallback
;; - canonical Auggie state/config root is ~/.augment

(allow file-read* file-write*
    (home-prefix "/.local/bin/auggie")
    (home-subpath "/.augment")  ;; session.json, settings.json, oauth-state.json, commands/, skills/, agents/, rules/.
)

;; ---------------------------------------------------------------------------
;; Agent: Claude Desktop App
;; Claude for Desktop (Electron) app bundle, preferences, and data paths.
;; Source: 60-agents/claude-app.sb
;; ---------------------------------------------------------------------------

;; Requires: 55-integrations-optional/macos-gui.sb   (window server, AppKit, input, accessibility)
;;           55-integrations-optional/electron.sb     (GPU, Metal, crashpad, WebView)

(allow file-read* file-write*
    (home-subpath "/Library/Application Support/Claude")
    (home-subpath "/Library/Logs/Claude")
    (home-subpath "/Library/HTTPStorages/com.anthropic.claudefordesktop")
    (home-subpath "/Library/Caches/Claude")
    (home-prefix "/Library/Caches/com.anthropic.claudefordesktop")
    (home-subpath "/Library/Saved Application State/com.anthropic.claudefordesktop.savedState")
)

(allow file-read*
    (subpath "/Applications/Claude.app")
    (home-literal "/Library/Preferences/com.anthropic.claudefordesktop.plist")
)

;; Claude Desktop persists app preferences via cfprefsd under its own domain.
(allow user-preference-read user-preference-write
    (preference-domain "com.anthropic.claudefordesktop")
)

;; Background Task Management: login item status query (SMAppService.mainApp.status).
;; Without this, SMAppService silently returns .notFound, causing the
;; "isStartupOnLoginEnabled failed to pass validation" Electron IPC error.
;; File chooser/open panel dialogs use this AppKit XPC service.
;; powerlog logger service is probed by Claude Desktop on startup.
;; File coordination and syspolicy services are queried by AppKit/LaunchServices
;; flows during file operations and app trust checks.
(allow mach-lookup
    (global-name "com.apple.backgroundtaskmanagementagent")
    (global-name "com.apple.appkit.xpc.openAndSavePanelService")
    (global-name "com.apple.powerlog.plxpclogger.xpc")
    (global-name "com.apple.FileCoordination")
    (global-name "com.apple.security.syspolicy")
    (global-name "com.apple.security.syspolicy.exec")
)

;; HFSIOC_SET_HOTFILE_STATE is occasionally probed during Desktop app file flows.
(allow system-fsctl
    (fsctl-command (_IO "h" 47))
)

;; Electron MachPortRendezvousServer IPC (PID-suffixed, app-specific bundle ID)
(allow mach-lookup
    (global-name-regex #"^com\.anthropic\.claudefordesktop\.MachPortRendezvousServer\.")
)

(allow mach-register
    (global-name-regex #"^com\.anthropic\.claudefordesktop\.MachPortRendezvousServer\.")
)

;; ---------------------------------------------------------------------------
;; Agent: Claude Code
;; Claude Code CLI binary, state, config, and MCP integration paths.
;; Source: 60-agents/claude-code.sb
;; ---------------------------------------------------------------------------

;; - installer-managed binary path: ~/.local/bin/claude (symlink target under ~/.local/share/claude/versions/*)
;; - local state/config under ~/.claude and ~/.claude.json
;; - macOS managed policy files under /Library/Application Support/ClaudeCode
;; - optional Claude Desktop MCP import source in ~/Library/Application Support/Claude
;; - optional user-level guidance file at ~/CLAUDE.md

(allow file-read* file-write*
    (home-prefix "/.local/bin/claude")
    (home-subpath "/.cache/claude")
    (home-prefix "/.claude") ; this include .claude folder, as well as .claude.json and .claude.lock.json etc files
    (home-subpath "/.local/state/claude")
    (home-subpath "/.local/share/claude")
    (home-literal "/CLAUDE.md")
    (data-home-literal "/CLAUDE.md")
)

(allow file-read*
    (home-prefix "/.claude.json.")
    (home-literal "/Library/Application Support/Claude/claude_desktop_config.json")
    (data-home-literal "/Library/Application Support/Claude/claude_desktop_config.json")
    (subpath "/Library/Application Support/ClaudeCode/.claude")
    (literal "/Library/Application Support/ClaudeCode/managed-settings.json")
    (literal "/Library/Application Support/ClaudeCode/managed-mcp.json")
    (literal "/Library/Application Support/ClaudeCode/CLAUDE.md")
)

;; ---------------------------------------------------------------------------
;; Agent: Cline
;; Cline CLI binary, state, and config paths.
;; Source: 60-agents/cline.sb
;; ---------------------------------------------------------------------------

;; - no official standalone CLI install path documented; keep ~/.local/bin fallback
;; - local state/config

(allow file-read* file-write*
    (home-prefix "/.local/bin/cline")
    (home-subpath "/.cline")
    (home-subpath "/.config/cline")
    (home-subpath "/.cache/cline")
    (home-subpath "/.local/share/cline")
    (home-subpath "/.local/state/cline")
    (home-subpath "/Documents/Cline")               ;; Cline MCP servers, rules, workflows, hooks.
)

;; ---------------------------------------------------------------------------
;; Agent: Codex
;; Codex CLI binary, state, and config paths.
;; Source: 60-agents/codex.sb
;; ---------------------------------------------------------------------------

;; - npm/bun global installs place binaries under package-manager prefix/bin
;; - ~/.local/bin is the common user-level target and fallback
;; - local state/config
;; - package updates are package-manager driven via node toolchain paths

(allow file-read* file-write*
    (home-prefix "/.local/bin/codex")
    (home-subpath "/.codex")
    (home-subpath "/.cache/codex")
)

(allow file-read*
    (home-literal "/Library/Preferences/com.openai.codex.plist")  ;; Codex macOS preferences plist.
)

;; ---------------------------------------------------------------------------
;; Agent: Cursor
;; Cursor CLI binary, state, config, and app bundle paths.
;; Source: 60-agents/cursor-agent.sb
;; ---------------------------------------------------------------------------

;; - official cursor-agent install/update manages:
;;   - ~/.local/bin/agent and ~/.local/bin/cursor-agent symlinks
;;   - ~/.local/bin/cursor shim
;;   - ~/.local/share/cursor-agent/versions/<version>/cursor-agent binary + .install.lock
;; - local state/config defaults to ~/.cursor (including project state under ~/.cursor/projects)
;; - wrapper sets NODE_COMPILE_CACHE under ~/Library/Caches/cursor-compile-cache on macOS
;; - CLI reads Cursor IDE workspace metadata under ~/Library/Application Support/Cursor/User/workspaceStorage

(allow file-read* file-write*
    (home-prefix "/.local/bin/agent")
    (home-prefix "/.local/bin/cursor-agent")
    (home-prefix "/.local/bin/cursor")
    (home-subpath "/.local/share/cursor-agent")
    (home-subpath "/.cursor")
    (home-subpath "/.config/cursor")
    (home-subpath "/.cache/cursor-compile-cache")
    (home-subpath "/Library/Caches/cursor-compile-cache")
)

(allow file-read*
    (home-subpath "/Library/Application Support/Cursor")
    (literal "/Applications")
    (literal "/usr/local/bin/cursor")
    (literal "/opt/homebrew/bin/cursor")
    (subpath "/Applications/Cursor.app")
)

;; ---------------------------------------------------------------------------
;; Agent: Droid
;; Droid CLI binary, Factory helpers, state, and config paths.
;; Source: 60-agents/droid.sb
;; ---------------------------------------------------------------------------

;; - install script binary location: ~/.local/bin/droid
;; - installer also manages helper binaries under ~/.factory/bin
;; - local state/config (Factory CLI root)

(allow file-read* file-write*
    (home-prefix "/.local/bin/droid")
    (home-subpath "/.factory")
)

;; ---------------------------------------------------------------------------
;; Agent: Gemini
;; Gemini CLI binary, state, and config paths.
;; Source: 60-agents/gemini.sb
;; ---------------------------------------------------------------------------

;; - npm global install path follows package-manager prefix/bin
;; - ~/.local/bin is the common user-level target and fallback
;; - local state/config
;; - package updates are package-manager or built-in update driven via entrypoint

(allow file-read* file-write*
    (home-prefix "/.local/bin/gemini")
    (home-subpath "/.gemini")
    (home-subpath "/.cache/gemini")
)

;; Enterprise managed settings
(allow file-read*
    (subpath "/Library/Application Support/GeminiCli")
)

;; ---------------------------------------------------------------------------
;; Agent: openCode
;; openCode CLI binary, state, and config paths.
;; Source: 60-agents/opencode.sb
;; ---------------------------------------------------------------------------

;; - install script binary locations:
;;   - ~/.opencode/bin/opencode
;;   - $XDG_BIN_DIR/opencode (commonly ~/.local/bin/opencode)
;;   - ~/bin/opencode
;; - local state/config

(allow file-read* file-write*
    (home-prefix "/.opencode/bin/opencode")
    (home-prefix "/.local/bin/opencode")
    (home-prefix "/bin/opencode")
    (home-subpath "/.opencode")
    (home-subpath "/.config/opencode")
    (home-subpath "/.cache/opencode")
    (home-subpath "/.local/share/opencode")
    (home-subpath "/.local/share/opentui")
    (home-subpath "/.local/state/opencode")
    (home-literal "/.opencode.json")                ;; Home-dir config file.
)

;; GitHub Copilot token read for auth
(allow file-read*
    (home-subpath "/.config/github-copilot")
)

;; ---------------------------------------------------------------------------
;; Agent: PI
;; PI CLI binary, state, and config paths.
;; Source: 60-agents/pi.sb
;; ---------------------------------------------------------------------------

;; - npm global install path follows package-manager prefix/bin
;; - ~/.local/bin is the common user-level target and fallback
;; - local state/config
;; - package updates are package-manager driven via node toolchain paths

(allow file-read* file-write*
    (home-prefix "/.local/bin/pi")
    (home-subpath "/.pi")
)

;; #safehouse-test-id:workdir-grant# Allow read/write access to the selected workdir.
;; Generated ancestor directory literals for selected workdir: /tmp/agent-safehouse-static-template/workspace
;;
;; Why file-read* (not file-read-metadata) with literal (not subpath):
;; Agents (notably Claude Code) call readdir() on every ancestor of the working
;; directory during startup. If only file-read-metadata (stat) is granted, the
;; agent cannot list directory contents, which causes it to blank PATH and break.
;; Using 'literal' (not 'subpath') keeps this safe: it grants read access to the
;; directory entry itself (i.e. listing its immediate children), but does NOT
;; grant recursive read access to files or subdirectories under it.
(allow file-read*
    (literal "/")
    (literal "/tmp")
    (literal "/tmp/agent-safehouse-static-template")
    (literal "/tmp/agent-safehouse-static-template/workspace")
)

(allow file-read* file-write* (subpath "/tmp/agent-safehouse-static-template/workspace"))

