#!/usr/bin/env bash
# ---------------------------------------------------------------------------
# Agent Safehouse Dist Binary (generated file)
# Project: https://agent-safehouse.dev
# Embedded Profiles Last Modified (UTC): 2026-02-12T17:57:28Z
# Generated by: scripts/generate-dist.sh
# ---------------------------------------------------------------------------
set -euo pipefail

PROFILE_KEYS=(
  "profiles/00-base.sb"
  "profiles/10-system-runtime.sb"
  "profiles/20-network.sb"
  "profiles/30-toolchains/bun.sb"
  "profiles/30-toolchains/deno.sb"
  "profiles/30-toolchains/go.sb"
  "profiles/30-toolchains/java.sb"
  "profiles/30-toolchains/node.sb"
  "profiles/30-toolchains/perl.sb"
  "profiles/30-toolchains/php.sb"
  "profiles/30-toolchains/python.sb"
  "profiles/30-toolchains/ruby.sb"
  "profiles/30-toolchains/runtime-managers.sb"
  "profiles/30-toolchains/rust.sb"
  "profiles/40-shared/agent-common.sb"
  "profiles/50-integrations-core/container-runtime-default-deny.sb"
  "profiles/50-integrations-core/git.sb"
  "profiles/50-integrations-core/scm-clis.sb"
  "profiles/55-integrations-optional/1password.sb"
  "profiles/55-integrations-optional/browser-native-messaging.sb"
  "profiles/55-integrations-optional/cleanshot.sb"
  "profiles/55-integrations-optional/cloud-credentials.sb"
  "profiles/55-integrations-optional/docker.sb"
  "profiles/55-integrations-optional/electron.sb"
  "profiles/55-integrations-optional/keychain.sb"
  "profiles/55-integrations-optional/kubectl.sb"
  "profiles/55-integrations-optional/macos-gui.sb"
  "profiles/55-integrations-optional/spotlight.sb"
  "profiles/55-integrations-optional/ssh.sb"
  "profiles/60-agents/aider.sb"
  "profiles/60-agents/amp.sb"
  "profiles/60-agents/auggie.sb"
  "profiles/60-agents/claude-code.sb"
  "profiles/60-agents/cline.sb"
  "profiles/60-agents/codex.sb"
  "profiles/60-agents/cursor-agent.sb"
  "profiles/60-agents/droid.sb"
  "profiles/60-agents/gemini.sb"
  "profiles/60-agents/goose.sb"
  "profiles/60-agents/kilo-code.sb"
  "profiles/60-agents/opencode.sb"
  "profiles/60-agents/pi.sb"
  "profiles/65-apps/claude-app.sb"
  "profiles/65-apps/vscode-app.sb"
)

embedded_profile_body() {
  case "$1" in
    "profiles/00-base.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_00_base_sb__'
(version 1)

;; ---------------------------------------------------------------------------
;; Base Profile
;; Core definitions, HOME_DIR replacement token, and helper macros shared by all modules.
;; Source: 00-base.sb
;; ---------------------------------------------------------------------------

;; HOME_DIR starts as an explicit replacement placeholder.
;; Safehouse policy assembly (bin/safehouse.sh via bin/lib/policy.sh)
;; replaces this token with the resolved HOME path.
;;
;; Manual policy-only example (no generator):
;;   Replace the next line with:
;;     (define HOME_DIR "/Users/alice")
(define HOME_DIR "__SAFEHOUSE_REPLACE_ME_WITH_ABSOLUTE_HOME_DIR__")

(define (home-subpath rel) (subpath (string-append HOME_DIR rel)))
(define (home-literal rel) (literal (string-append HOME_DIR rel)))
(define (home-prefix rel) (prefix (string-append HOME_DIR rel)))

(deny default)
__SAFEHOUSE_EMBEDDED_profiles_00_base_sb__
      ;;
    "profiles/10-system-runtime.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_10_system_runtime_sb__'
;; ---------------------------------------------------------------------------
;; System Runtime
;; Process execution, tmp/dev access, system binaries, and baseline mach services.
;; Source: 10-system-runtime.sb
;; ---------------------------------------------------------------------------

;; Agents spawn many subprocesses (shells, git, package managers, compilers), so runtime/process allowances are broad by default.

(allow file-read*
    (subpath "/usr")                                                  ;; Core system binaries and libraries required by most spawned tools.
    (subpath "/bin")                                                  ;; POSIX userland binaries used by shell/task orchestration.
    (subpath "/sbin")                                                 ;; System utilities some build/test flows invoke.
    (subpath "/opt")                                                  ;; Homebrew and other package-manager install roots.
    (subpath "/System/Library")                                       ;; macOS runtime frameworks/resources; excludes broader /System/Volumes data paths.
    (subpath "/System/Volumes/Preboot")                               ;; system libraries and frameworks may resolve through this path
    (subpath "/Library/Apple")                                        ;; Apple private frameworks touched by Node/Bun/JVM/native toolchains.
    (subpath "/Library/Frameworks")                                   ;; Global framework lookup path for language runtimes and CLIs.
    (subpath "/Library/Java")                                         ;; JVM runtime and helper assets.
    (subpath "/Library/Fonts")                                        ;; Font reads used by headless renderers/PDF/image tasks.
    (subpath "/Library/Filesystems/NetFSPlugins")                     ;; Path resolution may load NetFS plugins during filesystem lookups.
    (subpath "/Library/Preferences/Logging")                          ;; macOS logging stack reads prefs during process init.
    (literal "/Library/Preferences/.GlobalPreferences.plist")         ;; Locale/time/user defaults queried by runtimes.
    (literal "/Library/Preferences/com.apple.networkd.plist")         ;; DNS/network bootstrap reads networkd config.
    (literal "/dev")                                                  ;; /dev directory listing; shells enumerate it during initialization.
)

(allow file-read-metadata
   (subpath "/System")
)

;; /etc and /var are symlinks into /private/* on macOS; keep this scoped to common runtime needs.
(allow file-read*
    (literal "/private")                                              ;; Required for symlink traversal under macOS /private namespace.
    (literal "/private/var")                                          ;; Required for symlink traversal to /var-backed paths.
    (subpath "/private/var/db/timezone")                              ;; Timezone DB reads used by language date/time formatting.
    (subpath "/private/var/run")                                      ;; Resolver/daemon sockets and pid files used by networking flows.
    (literal "/private/var/select/sh")                                ;; /bin/sh selector used by macOS shell launch behavior.
    (literal "/private/var/select/developer_dir")                     ;; xcode-select developer dir pointer used by build CLIs.
    (literal "/var/select/developer_dir")                             ;; Compatibility alias for developer dir pointer.
    (literal "/private/var/db/xcode_select_link")                     ;; xcode-select link lookup used by toolchain discovery.
    (literal "/var/db/xcode_select_link")                             ;; Compatibility alias for xcode-select link lookup.
    (literal "/private/etc/hosts")                                    ;; Host override file consulted by resolver stack.
    (literal "/private/etc/resolv.conf")                              ;; DNS resolver configuration used by network clients.
    (literal "/private/etc/services")                                 ;; Service name-to-port mappings used by libc lookups.
    (literal "/private/etc/protocols")                                ;; Protocol metadata used by socket/libc helpers.
    (literal "/private/etc/profile")                                  ;; Shell startup file read by login-shell invocations.
    (literal "/private/etc/bashrc")                                   ;; Bash startup file read by spawned bash sessions.
    (literal "/private/etc/zprofile")                                 ;; Zsh startup file read by login zsh sessions.
    (literal "/private/etc/zshrc")                                    ;; Zsh startup file read by interactive zsh sessions.
    (literal "/private/etc/paths")                                    ;; PATH defaults used by shell command resolution.
    (subpath "/private/etc/paths.d")                                  ;; Additional PATH fragment directory used by macOS shells.
    (literal "/private/etc/shells")                                   ;; Valid shell list read by shell/auth tooling.
    (subpath "/private/etc/ssl")                                      ;; TLS CA bundles/certs used by HTTP and package clients.
    (literal "/private/etc/localtime")                                ;; Localtime symlink read by date/time libraries.
    ;; (subpath "/private/etc")                      ;; Compatibility fallback if a tool needs broader /etc reads.
    (literal "/etc")                                                  ;; Compatibility symlink root for tools hardcoding /etc.
    (literal "/var")                                                  ;; Compatibility symlink root for tools hardcoding /var.
)

(allow file-read-metadata
    (literal "/home")                                                 ;; Probed during path resolution by some runtimes.
    (literal "/private/etc")                                          ;; Directory traversal for /etc path resolution.
    (subpath "/dev")                                                  ;; Metadata (stat) on /dev entries; readdir() on /dev triggers this for every node.
    (home-literal "/.config")                                         ;; XDG config root traversal needed by many tools (mise, gh, git, etc.).
    (home-literal "/.cache")                                          ;; XDG cache root traversal needed by tools probing cache locations.
    (home-literal "/.local")                                          ;; XDG data root traversal needed by tools probing ~/.local paths.
    (home-literal "/.local/share")                                    ;; XDG data share dir traversal needed by tools probing data locations.
    (home-literal "/.local/bin")                                      ;; Agents stat this before installing binaries into ~/.local/bin.
)

(allow file-read*
    (home-prefix "/Library/Preferences/.GlobalPreferences")           ;; User-level locale/defaults plist variants read by many frameworks.
    (home-prefix "/Library/Preferences/com.apple.GlobalPreferences")  ;; Apple namespaced variant of user GlobalPreferences.
    (home-subpath "/Library/Preferences/ByHost")                      ;; Per-host preferences read by security CLI and system frameworks.
    (home-literal "/.CFUserTextEncoding")                             ;; User text encoding prefs; read by many processes for correct string handling.
    (home-literal "/.zshenv")                                         ;; Zsh environment file read on every zsh invocation (incl. non-interactive).
    (home-literal "/.zprofile")                                       ;; Zsh profile file read by login zsh sessions.
    (home-literal "/.zshrc")                                          ;; Zsh interactive startup file read by interactive zsh sessions.
    (home-literal "/.zcompdump")                                      ;; Zsh completion dump cache used by compinit.
    (home-prefix "/.zcompdump")                                       ;; Versioned variants like .zcompdump-hostname-5.9.
    (home-literal "/.config")                                         ;; XDG config root directory listing for tool discovery.
    (home-literal "/.cache")                                          ;; XDG cache root directory listing for tool discovery.
)

;; We intentionally do NOT block broad process primitives by default: agent workflows frequently chain many subprocesses.
(allow process-exec)                                                  ;; Required to execute toolchain binaries, shells, and repo tools.
(allow process-fork)                                                  ;; Required for normal child-process trees in CLI agents.
(allow sysctl-read)                                                   ;; Runtime/process introspection used by many CLIs at startup.
(allow process-info-pidinfo)                                          ;; Process status polling for child supervision and cleanup.
(allow process-info-setcontrol)                                       ;; Process control metadata updates used by CLI runtimes.
(allow process-info* (target same-sandbox))                           ;; Allow process introspection within the same sandbox.
(allow signal (target same-sandbox))                                  ;; Allow signalling child processes for cancellation/termination.
(allow mach-priv-task-port (target same-sandbox))                     ;; Required by some runtimes for same-sandbox process controls.
(allow pseudo-tty)                                                    ;; Required for interactive terminal sessions and PTY allocation.

(allow file-read* file-write*
    (subpath "/tmp")                                                  ;; Primary temp dir for transient files and IPC sockets.
    (subpath "/private/tmp")                                          ;; macOS backing path for /tmp.
    (subpath "/var/folders")                                          ;; macOS per-user temp/cache roots used by many CLIs.
    (subpath "/private/var/folders")                                  ;; macOS backing path for /var/folders.
)

;; Defense-in-depth: keep launchd-managed user socket endpoints opt-in by integration profile.
(deny file-read* file-write*
    (regex #"^/private/tmp/com\.apple\.launchd\.[^/]+/Listeners$")
    (regex #"^/tmp/com\.apple\.launchd\.[^/]+/Listeners$")
)

(allow file-read* file-write*
    (subpath "/dev/fd")                                               ;; Process substitution and file-descriptor access (bash <(...), /dev/fd/N).
    (literal "/dev/stdout")                                           ;; Standard output stream device.
    (literal "/dev/stderr")                                           ;; Standard error stream device.
    (literal "/dev/null")                                             ;; Null sink/source device used by scripts/tools.
    (literal "/dev/tty")                                              ;; Controlling terminal device for interactive sessions.
    (literal "/dev/ptmx")                                             ;; PTY multiplexer required for pseudo-terminal allocation.
    (literal "/dev/dtracehelper")                                             
    (regex #"^/dev/tty")                                              ;; Dynamic tty device names created for terminal sessions.
    (regex #"^/dev/ttys")                                             ;; Alternate tty naming pattern on macOS.
    (regex #"^/dev/pty")                                              ;; Legacy PTY naming pattern used by some tools.
)

(allow file-read*
    (literal "/dev/zero")                                             ;; Zero-filled source used by some runtimes/tests.
    (literal "/dev/autofs_nowait")                                    ;; Automount readiness check probed by most CLI processes at startup.
    (literal "/dev/dtracehelper")                                     ;; DTrace helper probed by dyld at process start; harmless read avoids log noise.
    (literal "/dev/urandom")                                          ;; Non-blocking entropy source used by crypto/token generation.
    (literal "/dev/random")                                           ;; Blocking entropy source used by some security-sensitive tools.
)

;; Restrict ioctl to terminal-related devices needed for interactive shell behavior.
(allow file-ioctl
    (literal "/dev/dtracehelper")                                             
    (literal "/dev/tty")
    (literal "/dev/ptmx")
    (regex #"^/dev/tty")
    (regex #"^/dev/ttys")
    (regex #"^/dev/pty")
)

(allow mach-lookup
    (global-name "com.apple.system.notification_center")              ;; Notification center lookup done by some CLIs.
    (global-name "com.apple.system.opendirectoryd.libinfo")           ;; User/group resolution via opendirectory.
    (global-name "com.apple.logd")                                    ;; logd connection used by unified logging APIs.
    (global-name "com.apple.FSEvents")                                ;; File event stream access used by watchers.
    (global-name "com.apple.SystemConfiguration.configd")             ;; System network/config queries for resolver bootstrap.
    (global-name "com.apple.SystemConfiguration.DNSConfiguration")    ;; Node/c-ares DNS bootstrap XPC dependency.
    (global-name "com.apple.trustd.agent")                            ;; Baseline trust evaluation service for CFNetwork/URLSession HTTPS.
    (global-name "com.apple.diagnosticd")                             ;; Unified logging diagnosticd backend used by many system frameworks.
    (global-name "com.apple.analyticsd")                              ;; Analytics subsystem queried during runtime initializations.
    (global-name "com.apple.dnssd.service")                           ;; DNS-SD (Bonjour) service used for DNS resolution by ssh, curl, etc.
    (global-name "com.apple.CoreServices.coreservicesd")              ;; Core Services daemon for UTI type resolution and file type identification.
    (global-name "com.apple.DiskArbitration.diskarbitrationd")        ;; Disk metadata queries probed by some frameworks during init.
    (global-name "com.apple.analyticsd.messagetracer")                ;; Analytics message tracer probed by frameworks during init.
    (global-name "com.apple.system.logger")                           ;; Legacy system logger endpoint used by some CLIs.
    (global-name "com.apple.coreservices.launchservicesd")            ;; Launch Services daemon for app registration and UTI resolution.
    (global-name "com.apple.pasteboard.1")                            ;; Pasteboard service used by pbcopy/pbpaste for clipboard access.
)

(allow system-socket)                                                 ;; AF_SYSTEM sockets used by network stack for kernel event monitoring.

(allow ipc-posix-shm-read-data
    (ipc-posix-name "apple.shm.notification_center")                  ;; Notification center shared memory segment read by system frameworks.
)
__SAFEHOUSE_EMBEDDED_profiles_10_system_runtime_sb__
      ;;
    "profiles/20-network.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_20_network_sb__'
;; ---------------------------------------------------------------------------
;; Network
;; Network policy; intentionally fully open for reliable agent operation.
;; Source: 20-network.sb
;; ---------------------------------------------------------------------------

;; Threat-model note: blocking exfiltration/C2 is explicitly NOT a goal for this sandbox.
;; The goal here is reliable agent operation (package installs, API calls, web fetches, local servers).

(allow network*)  ;; Allow outbound + inbound traffic so agent tooling and localhost dev servers work by default.

;; Strict policy examples (disabled by default):
;; 1) Comment out `(allow network*)` above.
;; 2) Uncomment ONE block below.

;; Example A: outbound only (no listening sockets)
;; (allow network-outbound)                     ;; Tight mode: keep fetch/install/API access, block listening sockets.

;; Example B: outbound + localhost-only dev servers
;; (allow network-outbound)                     ;; Tight mode: keep outbound access.
;; (allow network-bind (local ip "localhost:*"))  ;; Tight mode: only allow binding local dev-server ports.
;; (allow network-inbound (local ip "localhost:*"))  ;; Tight mode: only allow localhost clients to connect.
__SAFEHOUSE_EMBEDDED_profiles_20_network_sb__
      ;;
    "profiles/30-toolchains/bun.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_30_toolchains_bun_sb__'
;; ---------------------------------------------------------------------------
;; Toolchain: Bun
;; Bun runtime, installer, and cache paths.
;; Source: 30-toolchains/bun.sb
;; ---------------------------------------------------------------------------

;; Canonical Bun paths from docs:
;; - BUN_INSTALL defaults to ~/.bun
;; - install.cache.dir defaults to ~/.bun/install/cache
;; - install.globalDir defaults to ~/.bun/install/global
;; - install.globalBinDir defaults to ~/.bun/bin
;; - global bunfig path is ~/.bunfig.toml (or $XDG_CONFIG_HOME/.bunfig.toml)
;; Also include common cache/state variants seen on macOS.

(allow file-read* file-write*
    (home-subpath "/.bun")
    (home-subpath "/.cache/bun")
    (home-subpath "/.local/state/bun")
    (home-subpath "/.local/share/bun")
    (home-subpath "/Library/Caches/bun")
    (home-literal "/.bunfig.toml")
    (home-literal "/.config/bunfig.toml")
)
__SAFEHOUSE_EMBEDDED_profiles_30_toolchains_bun_sb__
      ;;
    "profiles/30-toolchains/deno.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_30_toolchains_deno_sb__'
;; ---------------------------------------------------------------------------
;; Toolchain: Deno
;; Deno runtime, cache, and config paths.
;; Source: 30-toolchains/deno.sb
;; ---------------------------------------------------------------------------

(allow file-read* file-write*
    (home-subpath "/.deno")
    (home-subpath "/.cache/deno")
    (home-subpath "/Library/Caches/deno")
)
__SAFEHOUSE_EMBEDDED_profiles_30_toolchains_deno_sb__
      ;;
    "profiles/30-toolchains/go.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_30_toolchains_go_sb__'
;; ---------------------------------------------------------------------------
;; Toolchain: Go
;; Go toolchain, module cache, and build cache paths.
;; Source: 30-toolchains/go.sb
;; ---------------------------------------------------------------------------

;; Adjust for your GOPATH/GOMODCACHE conventions as needed.
;; Defaults on many setups:
;; - GOPATH: ~/go
;; - GOCACHE: ~/.cache/go-build or ~/Library/Caches/go-build

(allow file-read* file-write*
    (home-subpath "/go")
    (home-subpath "/.cache/go-build")
    (home-subpath "/Library/Caches/go-build")
    (home-subpath "/.config/go")
    (home-subpath "/.cache/golangci-lint")
    (home-subpath "/Library/Caches/golangci-lint")
    (home-subpath "/.config/golangci-lint")
    (home-subpath "/.local/share/go")
    (home-subpath "/.goenv")
    (home-subpath "/.cache/gopls")
)
__SAFEHOUSE_EMBEDDED_profiles_30_toolchains_go_sb__
      ;;
    "profiles/30-toolchains/java.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_30_toolchains_java_sb__'
;; ---------------------------------------------------------------------------
;; Toolchain: Java
;; Java runtime, Maven, Gradle, SBT, and Coursier paths.
;; Source: 30-toolchains/java.sb
;; ---------------------------------------------------------------------------

;; Includes common Maven/Gradle/SBT/Coursier and Java runtime manager locations.

(allow file-read* file-write*
    (home-subpath "/.m2")
    (home-subpath "/.gradle")
    (home-subpath "/.ivy2")
    (home-subpath "/.sbt")
    (home-subpath "/.jenv")
    (home-subpath "/.sdkman")
    (home-subpath "/.cache/coursier")
    (home-subpath "/.coursier")
    (home-subpath "/Library/Application Support/Coursier")
    (home-subpath "/Library/Caches/Coursier")
    (home-subpath "/.java")
    (home-literal "/.mavenrc")
)
__SAFEHOUSE_EMBEDDED_profiles_30_toolchains_java_sb__
      ;;
    "profiles/30-toolchains/node.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_30_toolchains_node_sb__'
;; ---------------------------------------------------------------------------
;; Toolchain: Node.js
;; Node.js runtime with npm, yarn, pnpm, and corepack package manager paths.
;; Source: 30-toolchains/node.sb
;; ---------------------------------------------------------------------------

;; Keep writes scoped to Node-specific directories only.
;; Intentionally avoid broad RW grants like ~/.cache, ~/Library/Caches, ~/.local/share, ~/.local/state.
;; This list includes common + observed-on-machine Node ecosystem caches.

(allow file-read* file-write*
    ;; Node version managers.
    (home-subpath "/.nvm")
    (home-subpath "/.fnm")

    ;; npm
    (home-subpath "/.npm")
    (home-subpath "/.config/npm")
    (home-subpath "/.cache/npm")
    (home-subpath "/.cache/node")
    (home-subpath "/.cache/prisma")
    (home-subpath "/Library/Caches/npm")
    (home-literal "/.npmrc")

    ;; configstore (npm ecosystem config persistence)
    (home-subpath "/.config/configstore")

    ;; node-gyp
    (home-subpath "/.node-gyp")
    (home-subpath "/.cache/node-gyp")

    ;; pnpm
    (home-subpath "/.config/pnpm")
    (home-subpath "/.pnpm-state")
    (home-subpath "/.pnpm-store")
    (home-subpath "/.local/share/pnpm")
    (home-subpath "/.local/state/pnpm")
    (home-subpath "/Library/pnpm")
    (home-subpath "/Library/Caches/pnpm")
    (home-subpath "/Library/Preferences/pnpm")  ;; pnpm-managed global npmrc lives here.

    ;; yarn (classic + modern)
    (home-subpath "/.yarn")
    (home-literal "/.yarnrc")
    (home-literal "/.yarnrc.yml")
    (home-subpath "/.config/yarn")
    (home-subpath "/.cache/yarn")
    (home-subpath "/Library/Caches/Yarn")

    ;; corepack
    (home-subpath "/.cache/node/corepack")
    (home-subpath "/Library/Caches/node/corepack")

    ;; browser automation / test runners
    (home-subpath "/Library/Caches/ms-playwright")
    (home-subpath "/Library/Caches/Cypress")

    ;; Node ecosystem caches used by CLIs and language tooling
    (home-subpath "/Library/Caches/typescript")
    (home-subpath "/Library/Caches/prisma-nodejs")
    (home-subpath "/Library/Caches/checkpoint-nodejs")
    (home-subpath "/Library/Caches/claude-cli-nodejs")

    ;; Turborepo
    (home-subpath "/.cache/turbo")
    (home-subpath "/Library/Caches/turbo")
    (home-subpath "/Library/Application Support/turborepo")

)
__SAFEHOUSE_EMBEDDED_profiles_30_toolchains_node_sb__
      ;;
    "profiles/30-toolchains/perl.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_30_toolchains_perl_sb__'
;; ---------------------------------------------------------------------------
;; Toolchain: Perl
;; Perl runtime, cpan/cpanm, and version-manager paths.
;; Source: 30-toolchains/perl.sb
;; ---------------------------------------------------------------------------

;; Includes common Perl version managers and package/cache locations.

(allow file-read* file-write*
    (home-subpath "/.perlbrew")
    (home-subpath "/.plenv")
    (home-subpath "/.cpan")
    (home-subpath "/.cpanm")
    (home-subpath "/.perl-cpm")
    (home-subpath "/perl5")
    (home-subpath "/.local/lib/perl5")
    (home-subpath "/Library/Caches/cpanm")
    (home-literal "/.cpanrc")
)
__SAFEHOUSE_EMBEDDED_profiles_30_toolchains_perl_sb__
      ;;
    "profiles/30-toolchains/php.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_30_toolchains_php_sb__'
;; ---------------------------------------------------------------------------
;; Toolchain: PHP
;; PHP runtime and Composer paths.
;; Source: 30-toolchains/php.sb
;; ---------------------------------------------------------------------------

;; Includes common Composer + PHP env/cache locations.

(allow file-read* file-write*
    (home-subpath "/.composer")
    (home-subpath "/.config/composer")
    (home-subpath "/.cache/composer")
    (home-subpath "/Library/Caches/composer")
    (home-subpath "/.local/share/composer")
    (home-subpath "/.phpenv")
    (home-subpath "/.config/php")
    (home-subpath "/.cache/php")
    (home-literal "/.pearrc")
)
__SAFEHOUSE_EMBEDDED_profiles_30_toolchains_php_sb__
      ;;
    "profiles/30-toolchains/python.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_30_toolchains_python_sb__'
;; ---------------------------------------------------------------------------
;; Toolchain: Python
;; Python runtime, pip, uv, and virtualenv paths.
;; Source: 30-toolchains/python.sb
;; ---------------------------------------------------------------------------

;; Covers common Python package/cache/config paths, plus uv binaries/state.
;; Do not grant blanket writes to ~/.local/bin; per-agent modules grant entrypoint-specific binary writes.

(allow file-read* file-write*
    (home-literal "/.local/bin/uv")            ;; uv binary observed in ~/.local/bin on this machine.
    (home-literal "/.local/bin/uvx")           ;; uvx companion binary observed in ~/.local/bin.
    (home-subpath "/.local/share/uv")          ;; uv tool metadata and installed tool/runtime state.
    (home-subpath "/.local/state/uv")          ;; uv state/cache metadata on XDG-style setups.
    (home-subpath "/.local/pipx")              ;; pipx-managed virtualenvs and shared python runtime.
    (home-subpath "/.cache/uv")                ;; uv download/build cache for fast repeated runs.
    (home-subpath "/Library/Caches/uv")        ;; macOS cache variant used by some uv installs.
    (home-subpath "/.config/uv")               ;; uv config reads/writes during tool resolution.
    (home-subpath "/.cache/pip")               ;; pip cache writes used by Python package installs.
    (home-subpath "/.config/pip")              ;; pip config reads for index/auth/behavior settings.
    (home-subpath "/Library/Caches/pip")       ;; macOS pip cache location used by some Python setups.
    (home-subpath "/.cache/pypoetry")          ;; Poetry dependency cache for Python project tasks.
    (home-subpath "/.config/pypoetry")         ;; Poetry config used during install/publish operations.
    (home-subpath "/.local/share/pypoetry")    ;; Poetry local state and virtualenv metadata.
    (home-subpath "/Library/Caches/pypoetry")  ;; macOS Poetry cache variant.
    (home-subpath "/.cache/pdm")               ;; PDM dependency/cache data.
    (home-subpath "/.config/pdm")              ;; PDM config files.
    (home-subpath "/.local/share/pdm")         ;; PDM local metadata/state.
    (home-subpath "/.cache/pre-commit")        ;; pre-commit hook environment cache.
    (home-subpath "/.cache/mypy")              ;; mypy incremental/type cache.
    (home-subpath "/.cache/ruff")              ;; Ruff lint/format cache.
    (home-subpath "/.virtualenvs")             ;; virtualenvwrapper default location.
    (home-subpath "/.ipython")                 ;; IPython history/profile data.
    (home-subpath "/.jupyter")                 ;; Jupyter runtime/config paths in home.
    (home-subpath "/.pyenv")                   ;; pyenv interpreter shims/versions used by many repos.
    (home-literal "/.pypirc")                  ;; Python package index credentials/config file path.
    (home-literal "/.python_history")          ;; REPL history file touched by Python subprocess sessions.
    ;; conda / miniconda / miniforge
    (home-subpath "/.conda")
    (home-subpath "/miniconda3")
    (home-subpath "/miniforge3")
    (home-literal "/.condarc")
    ;; hatch
    (home-subpath "/.cache/hatch")
    (home-subpath "/.config/hatch")
    (home-subpath "/.local/share/hatch")
)
__SAFEHOUSE_EMBEDDED_profiles_30_toolchains_python_sb__
      ;;
    "profiles/30-toolchains/ruby.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_30_toolchains_ruby_sb__'
;; ---------------------------------------------------------------------------
;; Toolchain: Ruby
;; Ruby runtime, gem, and bundler cache paths.
;; Source: 30-toolchains/ruby.sb
;; ---------------------------------------------------------------------------

;; Covers common Ruby managers and gem/bundler caches.

(allow file-read* file-write*
    (home-subpath "/.rbenv")
    (home-subpath "/.rvm")
    (home-subpath "/.rubies")
    (home-subpath "/.bundle")
    (home-subpath "/.gem")
    (home-subpath "/.cache/bundler")
    (home-subpath "/.cache/rubygems")
    (home-subpath "/Library/Caches/bundle")
    (home-literal "/.gemrc")
    (home-literal "/.irbrc")
    (home-literal "/.irb_history")
    (home-literal "/.pryrc")
    (home-literal "/.pry_history")
)
__SAFEHOUSE_EMBEDDED_profiles_30_toolchains_ruby_sb__
      ;;
    "profiles/30-toolchains/runtime-managers.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_30_toolchains_runtime_managers_sb__'
;; ---------------------------------------------------------------------------
;; Toolchain: Runtime Managers
;; Cross-language version managers (mise, asdf, proto, pkgx).
;; Source: 30-toolchains/runtime-managers.sb
;; ---------------------------------------------------------------------------

;; Keep these separate from node.sb so Node toolchain policy stays focused.

(allow file-read* file-write*
    ;; mise
    (home-subpath "/.config/mise")
    (home-subpath "/.local/share/mise")
    (home-subpath "/.local/state/mise")
    (home-subpath "/.cache/mise")
    (home-subpath "/Library/Caches/mise")
    (home-literal "/.mise.toml")

    ;; volta
    (home-subpath "/.volta")

    ;; asdf
    (home-subpath "/.asdf")
    (home-subpath "/.config/asdf")
    (home-subpath "/.local/share/asdf")
    (home-subpath "/.local/state/asdf")
    (home-subpath "/.cache/asdf")
    (home-subpath "/Library/Caches/asdf")
    (home-literal "/.asdfrc")
    (home-literal "/.tool-versions")

    ;; proto
    (home-subpath "/.proto")
    (home-literal "/.prototools")

    ;; pkgx
    (home-subpath "/.pkgx")
    (home-subpath "/.local/share/pkgx")
    (home-subpath "/.cache/pkgx")
    (home-subpath "/Library/Caches/pkgx")
    (home-subpath "/Library/Packages")
)
__SAFEHOUSE_EMBEDDED_profiles_30_toolchains_runtime_managers_sb__
      ;;
    "profiles/30-toolchains/rust.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_30_toolchains_rust_sb__'
;; ---------------------------------------------------------------------------
;; Toolchain: Rust
;; Rust toolchain via rustup/cargo, including config, cache, and optional sccache.
;; Source: 30-toolchains/rust.sb
;; ---------------------------------------------------------------------------

;; Includes common cargo config/cache locations and optional sccache.

(allow file-read* file-write*
    (home-subpath "/.cargo")
    (home-subpath "/.config/cargo")
    (home-subpath "/.rustup")
    (home-subpath "/.cache/cargo")
    (home-subpath "/Library/Caches/cargo")
    (home-subpath "/.cache/sccache")
    (home-subpath "/Library/Caches/sccache")
    (home-subpath "/Library/Application Support/Mozilla.sccache")
)
__SAFEHOUSE_EMBEDDED_profiles_30_toolchains_rust_sb__
      ;;
    "profiles/40-shared/agent-common.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_40_shared_agent_common_sb__'
;; ---------------------------------------------------------------------------
;; Category: Shared Agent Context
;; Shared permissions for skills, agents, and guidance files.
;; Source: 40-shared/agent-common.sb
;; ---------------------------------------------------------------------------

;; Shared authoring context:
;; - ~/.skills/ (full access)
;; - ~/.agents/ (full access)
;; - ~/AGENTS.md (full access)
;; - ~/.claude/agents, ~/.claude/skills, ~/CLAUDE.md (read-only)

(allow file-read* file-write*
    (home-subpath "/.skills")         ;; Shared skill instructions/scripts that agents may read or update.
    (home-subpath "/.agents")         ;; Agent config/skills directory (alternate location alongside ~/.skills).
    (home-literal "/AGENTS.md")       ;; Shared agent policy/instructions file read+write for local workflows.
)

(allow file-read*
    (home-subpath "/.claude/agents")  ;; Cross-agent convention: shared Claude agents directory.
    (home-subpath "/.claude/skills")  ;; Cross-agent convention: shared Claude skills directory.
    (home-literal "/CLAUDE.md")       ;; Cross-agent convention: repository/user guidance file.
)
__SAFEHOUSE_EMBEDDED_profiles_40_shared_agent_common_sb__
      ;;
    "profiles/50-integrations-core/container-runtime-default-deny.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_50_integrations_core_container_runtime_default_deny_sb__'
;; ---------------------------------------------------------------------------
;; Integration: Container Runtime Default Deny
;; Default-deny local container daemon sockets; docker integration can re-open later.
;; Source: 50-integrations-core/container-runtime-default-deny.sb
;; ---------------------------------------------------------------------------

;; #safehouse-test-id:container-runtime-socket-deny# Keep container daemon access opt-in.
;; This core deny profile is loaded before optional integrations. When --enable=docker is set,
;; profiles/55-integrations-optional/docker.sb is appended later and can re-open these paths.

(deny file-read* file-write*
    (literal "/var/run/docker.sock")
    (literal "/private/var/run/docker.sock")
    (literal "/var/run/podman/podman.sock")
    (literal "/private/var/run/podman/podman.sock")
    (home-literal "/.docker/run/docker.sock")
    (home-literal "/.rd/docker.sock")
    (home-literal "/.orbstack/run/docker.sock")
    (regex (string-append "^" HOME_DIR "/\\.colima/docker\\.sock$"))
    (regex (string-append "^" HOME_DIR "/\\.colima/[^/]+/docker\\.sock$"))
    (regex (string-append "^" HOME_DIR "/\\.local/share/containers/podman/machine/podman\\.sock$"))
    (regex (string-append "^" HOME_DIR "/\\.local/share/containers/podman/machine/[^/]+/podman\\.sock$"))
    (regex (string-append "^" HOME_DIR "/\\.config/containers/podman/machine/podman\\.sock$"))
    (regex (string-append "^" HOME_DIR "/\\.config/containers/podman/machine/[^/]+/podman\\.sock$"))
)
__SAFEHOUSE_EMBEDDED_profiles_50_integrations_core_container_runtime_default_deny_sb__
      ;;
    "profiles/50-integrations-core/git.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_50_integrations_core_git_sb__'
;; ---------------------------------------------------------------------------
;; Integration: Git
;; Git client configuration and XDG config directory access.
;; Source: 50-integrations-core/git.sb
;; ---------------------------------------------------------------------------

(allow file-read*
    (home-prefix "/.gitconfig")    ;; User gitconfig and variants (.gitconfig.local, etc.) read by git CLI.
    (home-subpath "/.config/git")  ;; XDG-style git config directory (config, ignore, attributes).
    (home-literal "/.gitattributes")  ;; Global gitattributes file.
)
__SAFEHOUSE_EMBEDDED_profiles_50_integrations_core_git_sb__
      ;;
    "profiles/50-integrations-core/scm-clis.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_50_integrations_core_scm_clis_sb__'
;; ---------------------------------------------------------------------------
;; Integration: SCM CLIs
;; GitHub CLI (gh) and GitLab CLI (glab) config, cache, and state access.
;; Source: 50-integrations-core/scm-clis.sb
;; ---------------------------------------------------------------------------

;; Threat-model note: preventing exfiltration/C2 is NOT a goal; this keeps SCM workflows available to agents.

(allow file-read* file-write*
    (home-subpath "/.config/gh")             ;; gh auth tokens/config for repo and PR automation.
    (home-subpath "/.cache/gh")              ;; gh cache for API and command acceleration.
    (home-subpath "/.local/share/gh")        ;; gh persistent state and extensions.
    (home-subpath "/.local/state/gh")        ;; gh runtime state files.
    (home-subpath "/.config/glab-cli")       ;; glab auth tokens/config for GitLab automation.
    (home-subpath "/.cache/glab-cli")        ;; glab cache for API and command acceleration.
    (home-subpath "/.local/share/glab-cli")  ;; glab persistent state.
    (home-subpath "/.local/state/glab-cli")  ;; glab runtime state files.
)
__SAFEHOUSE_EMBEDDED_profiles_50_integrations_core_scm_clis_sb__
      ;;
    "profiles/55-integrations-optional/1password.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_55_integrations_optional_1password_sb__'
;; ---------------------------------------------------------------------------
;; Integration: 1Password
;; 1Password desktop app and CLI agent socket access.
;; Source: 55-integrations-optional/1password.sb
;; ---------------------------------------------------------------------------

(allow file-read* file-write*
    (home-subpath "/.config/op")                               ;; 1Password CLI (op) config and session tokens.
    (home-subpath "/.1password")                               ;; 1Password SSH agent symlink dir (includes ~/.1password/agent.sock).
    (subpath "/Users/Shared/.1password")                       ;; Some installs use shared path for SSH agent socket.
    (regex (string-append "^" HOME_DIR "/Library/Group Containers/[A-Za-z0-9]+\\.com\\.1password/t(/.*)?$"))       ;; 1Password SSH agent socket directory (team prefix varies).
)

;; 1Password Desktop settings probe (read-only)
;; Newer op builds read settings.json here to detect Desktop integration state.
(allow file-read*
    (regex (string-append "^" HOME_DIR "/Library/Group Containers/[A-Za-z0-9]+\\.com\\.1password/Library/Application Support/1Password/Data/settings(/.*)?$"))      ;; Desktop settings dir (includes settings.json).
)

;; 1Password op binary reads are covered by system-runtime (/usr, /opt).

;; 1Password SSH agent config
(allow file-read*
    (home-subpath "/.config/1Password")  ;; ssh/agent.toml — controls which keys are offered.
)

(allow mach-lookup
    (global-name-regex #"^([A-Za-z0-9]+\.)?com\.1password(\..*)?$")  ;; 1Password app/service IPC endpoints (including team-prefixed browser-helper names).
    (global-name-regex #"^com\.agilebits(\..*)?$")                    ;; Legacy AgileBits service names still used by some installs.
)
__SAFEHOUSE_EMBEDDED_profiles_55_integrations_optional_1password_sb__
      ;;
    "profiles/55-integrations-optional/browser-native-messaging.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_55_integrations_optional_browser_native_messaging_sb__'
;; ---------------------------------------------------------------------------
;; Integration: Browser Native Messaging
;; Browser native messaging host registration (Chromium + Firefox) and Chromium extension detection.
;; Source: 55-integrations-optional/browser-native-messaging.sb
;; ---------------------------------------------------------------------------

;; Three things are needed per Chromium browser:
;;   1. Directory listing on the browser root (check if browser is installed)
;;   2. Read+write on NativeMessagingHosts (register/update the native messaging manifest)
;;   3. Read on Default/Extensions (check if a specific extension is installed)
;; Firefox support only needs NativeMessagingHosts registration paths.
;; Extensions dir only contains publicly-available extension source/manifests — no browsing data.
;; No access to cookies, passwords, history, bookmarks, or profile data.

(allow file-read*
    (home-literal "/Library/Application Support/Google/Chrome")
    (home-literal "/Library/Application Support/BraveSoftware/Brave-Browser")
    (home-literal "/Library/Application Support/Arc/User Data")
    (home-literal "/Library/Application Support/Microsoft Edge")
    (home-literal "/Library/Application Support/Chromium")
    (home-literal "/Library/Application Support/Vivaldi")
    (home-literal "/Library/Application Support/com.operasoftware.Opera")
    (home-literal "/Library/Application Support/Firefox")
    (home-literal "/Library/Application Support/Mozilla")
    (home-subpath "/Library/Application Support/Google/Chrome/Default/Extensions")
    (home-subpath "/Library/Application Support/BraveSoftware/Brave-Browser/Default/Extensions")
    (home-subpath "/Library/Application Support/Arc/User Data/Default/Extensions")
    (home-subpath "/Library/Application Support/Microsoft Edge/Default/Extensions")
    (home-subpath "/Library/Application Support/Chromium/Default/Extensions")
    (home-subpath "/Library/Application Support/Vivaldi/Default/Extensions")
    (home-subpath "/Library/Application Support/com.operasoftware.Opera/Default/Extensions")
)

(allow file-read* file-write*
    (home-subpath "/Library/Application Support/Google/Chrome/NativeMessagingHosts")
    (home-subpath "/Library/Application Support/BraveSoftware/Brave-Browser/NativeMessagingHosts")
    (home-subpath "/Library/Application Support/Arc/User Data/NativeMessagingHosts")
    (home-subpath "/Library/Application Support/Microsoft Edge/NativeMessagingHosts")
    (home-subpath "/Library/Application Support/Chromium/NativeMessagingHosts")
    (home-subpath "/Library/Application Support/Vivaldi/NativeMessagingHosts")
    (home-subpath "/Library/Application Support/com.operasoftware.Opera/NativeMessagingHosts")
    (home-subpath "/Library/Application Support/Mozilla/NativeMessagingHosts")
)
__SAFEHOUSE_EMBEDDED_profiles_55_integrations_optional_browser_native_messaging_sb__
      ;;
    "profiles/55-integrations-optional/cleanshot.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_55_integrations_optional_cleanshot_sb__'
;; ---------------------------------------------------------------------------
;; Integration: CleanShot
;; Read access to CleanShot screenshot/recording media for pasting into agents.
;; Source: 55-integrations-optional/cleanshot.sb
;; ---------------------------------------------------------------------------

(allow file-read*
    (home-subpath "/Library/Application Support/CleanShot/media")       ;; Screenshot and recording files saved by CleanShot X.
)
__SAFEHOUSE_EMBEDDED_profiles_55_integrations_optional_cleanshot_sb__
      ;;
    "profiles/55-integrations-optional/cloud-credentials.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_55_integrations_optional_cloud_credentials_sb__'
;; ---------------------------------------------------------------------------
;; Integration: Cloud Credentials
;; Cloud provider CLI/SDK credential, config, and cache access.
;; Source: 55-integrations-optional/cloud-credentials.sb
;; ---------------------------------------------------------------------------

;; Threat-model note: preventing exfiltration/C2 is NOT a goal; this keeps cloud tooling usable when needed.
;; Use --append-profile to selectively deny specific providers (e.g. block ~/.aws reads).

(allow file-read*
    (home-subpath "/.aws")            ;; AWS profiles/sso/cache files needed for aws cli and SDK auth flows.
    (home-subpath "/.config/gcloud")  ;; gcloud account/config/token files needed for CLI auth and project commands.
    (home-subpath "/.azure")          ;; Azure CLI config, credentials, and token cache.
    (home-subpath "/.azd")            ;; Azure Developer CLI environment/auth state.
)
__SAFEHOUSE_EMBEDDED_profiles_55_integrations_optional_cloud_credentials_sb__
      ;;
    "profiles/55-integrations-optional/docker.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_55_integrations_optional_docker_sb__'
;; ---------------------------------------------------------------------------
;; Integration: Docker
;; Docker daemon socket access for container operations. High-risk.
;; Source: 55-integrations-optional/docker.sb
;; ---------------------------------------------------------------------------

(allow file-read* file-write*
    (literal "/var/run/docker.sock")                                       ;; Standard Docker daemon socket path.
    (literal "/private/var/run/docker.sock")                               ;; macOS backing path for /var/run/docker.sock.
    (home-literal "/.docker/run/docker.sock")                              ;; Docker Desktop user-scoped socket path.
    (home-literal "/.orbstack/run/docker.sock")                            ;; OrbStack user-scoped daemon socket path.
    (home-subpath "/.docker")                                              ;; Docker CLI config, contexts, plugins, buildx state.
    (home-subpath "/.colima")                                              ;; Colima socket (Docker Desktop alternative).
    (home-literal "/.rd/docker.sock")                                      ;; Rancher Desktop socket.
)

;; OrbStack (Docker Desktop alternative) — shell completions and CLI helpers.
(allow file-read*
    (subpath "/Applications/OrbStack.app/Contents/Resources/completions")  ;; Zsh/bash completions sourced during shell init.
)
__SAFEHOUSE_EMBEDDED_profiles_55_integrations_optional_docker_sb__
      ;;
    "profiles/55-integrations-optional/electron.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_55_integrations_optional_electron_sb__'
;; ---------------------------------------------------------------------------
;; Integration: Electron
;; Chromium/Electron runtime: GPU, Metal shaders, crashpad, and WebView.
;; Source: 55-integrations-optional/electron.sb
;; $$require=55-integrations-optional/macos-gui.sb$$
;; #safehouse-test-id:electron-integration#
;; ---------------------------------------------------------------------------

;; Chromium/Electron attempts to initialize an internal sandbox for helper
;; processes (GPU, Renderer, Utility, Network). Under safehouse, the process
;; tree is already inside macOS Seatbelt via sandbox-exec.
;;
;; Re-initializing Seatbelt from inside an existing Seatbelt sandbox is blocked
;; by the OS (sandbox_init returns EPERM / "Operation not permitted"). This is
;; not fixable with additional allow rules in this profile.
;;
;; Primary workaround under Safehouse: launch Electron with --no-sandbox.
;; Compatibility fallback: ELECTRON_DISABLE_SANDBOX=1.
;; Safehouse's outer sandbox still applies to the full process tree.

;; -- GPU / Metal shader compilation --------------------------------------------
;; #safehouse-test-id:electron-gpu-metal#

(allow mach-lookup
    (global-name "com.apple.MTLCompilerService")
    (global-name "com.apple.SafariPlatformSupport.Helper")
)

(allow iokit-open
    (iokit-user-client-class "IOSurfaceRootUserClient")
    (iokit-user-client-class "AGXDeviceUserClient")
)

(allow file-read-metadata
    (literal "/private/var/db/.AppleSetupDone")
)

;; -- Chromium crashpad crash reporting -----------------------------------------
;; #safehouse-test-id:electron-crashpad#
;; #safehouse-test-id:electron-crashpad-lookup#

(allow mach-lookup
    (global-name-regex #"^org\.chromium\.crashpad\.child_port_handshake\.")
)

;; #safehouse-test-id:electron-crashpad-register#
(allow mach-register
    (global-name-regex #"^org\.chromium\.crashpad\.child_port_handshake\.")
)
__SAFEHOUSE_EMBEDDED_profiles_55_integrations_optional_electron_sb__
      ;;
    "profiles/55-integrations-optional/keychain.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_55_integrations_optional_keychain_sb__'
;; ---------------------------------------------------------------------------
;; Integration: Keychain
;; macOS Keychain and Security framework for agent authentication/credential storage.
;; Source: 55-integrations-optional/keychain.sb
;; ---------------------------------------------------------------------------

;; Auto-injected when a selected app/agent profile declares $$require=55-integrations-optional/keychain.sb$$.

(allow file-read* file-write*
    (home-subpath "/Library/Keychains")                        ;; Keychain DB/files for CLI login sessions using macOS credentials.
    (home-literal "/Library/Preferences/com.apple.security.plist")   ;; User security preferences read by some auth flows.
)

(allow file-read*
    (literal "/Library/Preferences/com.apple.security.plist")  ;; Security preferences read by security CLI.
    (literal "/Library/Keychains/System.keychain")             ;; System keychain read for security CLI operations.
    (subpath "/private/var/db/mds")                            ;; MDS message store; hosts se_SecurityMessages used by securityd IPC.
)

(allow file-read-metadata
    (home-literal "/Library")                                  ;; Restrict home traversal to the Library root only.
    (home-literal "/Library/Keychains")                        ;; User keychain directory metadata for login/session lookups.
    (literal "/Library")                                       ;; System Library traversal for system keychain access.
    (literal "/Library/Keychains")                             ;; System keychain directory metadata.
)

(allow mach-lookup
    (global-name "com.apple.SecurityServer")                   ;; Keychain operations depend on SecurityServer IPC.
    (global-name "com.apple.security.agent")                   ;; Login prompts/token unlock dialogs route through this service.
    (global-name "com.apple.securityd.xpc")                    ;; securityd backend needed for certificate/key queries.
    (global-name "com.apple.security.authhost")                ;; Auth host service for interactive credential flows.
    (global-name "com.apple.secd")                             ;; Secure enclave/credential mediation used by macOS security APIs.
    (global-name "com.apple.trustd")                           ;; Additional trustd backend used by some keychain/security flows.
)

(allow ipc-posix-shm-read-data ipc-posix-shm-write-create ipc-posix-shm-write-data
    (ipc-posix-name "com.apple.AppleDatabaseChanged")          ;; Keychain database change notifications via shared memory.
)
__SAFEHOUSE_EMBEDDED_profiles_55_integrations_optional_keychain_sb__
      ;;
    "profiles/55-integrations-optional/kubectl.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_55_integrations_optional_kubectl_sb__'
;; ---------------------------------------------------------------------------
;; Integration: kubectl
;; Kubernetes CLI config, cache, and plugin-manager state.
;; Source: 55-integrations-optional/kubectl.sb
;; #safehouse-test-id:kubectl-integration#
;; ---------------------------------------------------------------------------

;; Canonical kubectl defaults:
;; - kubeconfig: $HOME/.kube/config
;; - cache-dir:  $HOME/.kube/cache
;; - kuberc:     $HOME/.kube/kuberc
;; Canonical krew default install root:
;; - KREW_ROOT defaults to $HOME/.krew

(allow file-read*
    (home-subpath "/.kube")                                         ;; kubeconfig, cert/key refs, and kubectl preference data.
    (home-subpath "/.krew")                                         ;; krew index/manifests and installed plugin binaries.
)

(allow file-write*
    (home-literal "/.kube")                                         ;; allow creating cache/config sidecar files under ~/.kube.
    (home-literal "/.kube/config")                                  ;; kubectl config set-context/set-credentials updates.
    (home-literal "/.kube/kuberc")                                  ;; kuberc preference updates.
    (home-subpath "/.kube/cache")                                   ;; default kubectl discovery/http cache writes.
    (home-subpath "/.kube/http-cache")                              ;; explicit http-cache path variants.
    (home-literal "/.krew")                                         ;; allow initializing krew root.
    (home-subpath "/.krew")                                         ;; krew plugin install/upgrade/uninstall state changes.
)
__SAFEHOUSE_EMBEDDED_profiles_55_integrations_optional_kubectl_sb__
      ;;
    "profiles/55-integrations-optional/macos-gui.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_55_integrations_optional_macos_gui_sb__'
;; ---------------------------------------------------------------------------
;; Integration: macOS GUI
;; Window server, AppKit, accessibility, input, and framework services
;; needed by any graphical macOS application running under sandbox.
;; Source: 55-integrations-optional/macos-gui.sb
;; ---------------------------------------------------------------------------

;; -- System preferences and framework data -------------------------------------

(allow file-read*
    (literal "/private/etc")
    (literal "/private/var/db/eligibilityd/eligibility.plist")
    (literal "/private/var/db/nsurlstoraged/dafsaData.bin")
    (literal "/Library/Application Support/Apple/Spotlight/MailUsesCoreSpotlight")
    (home-literal "/Library/Preferences/com.apple.universalaccess.plist")
    (home-literal "/Library/Preferences/com.apple.Accessibility.plist")
    (home-literal "/Library/Preferences/com.apple.CoreGraphics.plist")
    (home-literal "/Library/Preferences/com.apple.symbolichotkeys.plist")
    (home-literal "/Library/Preferences/com.apple.ServicesMenu.Services.plist")
    (home-literal "/Library/Preferences/com.apple.speech.recognition.AppleSpeechRecognition.prefs.plist")
    (home-literal "/Library/Preferences/com.apple.SpeakSelection.plist")
    (home-literal "/Library/Preferences/com.apple.assistant.support.plist")
    (home-literal "/Library/Preferences/com.apple.assistant.backedup.plist")
    (home-literal "/Library/Preferences/pbs.plist")
    (home-literal "/Library/Preferences/com.apple.HIToolbox.plist")
    (literal "/Library/Preferences/com.apple.HIToolbox.plist")
    (home-subpath "/Library/Preferences/com.apple.LaunchServices")
    (home-subpath "/Library/Application Support/CrashReporter")
    (home-subpath "/Library/Spelling")
    (home-literal "/Library/Keyboard Layouts")
    (home-literal "/Library/Input Methods")
)

(allow file-read* file-write*
    (home-subpath "/Library/Accessibility")
)

;; Directory metadata (stat/readdir) for standard user and system paths
(allow file-read-metadata
    (literal "/private/var/db")
    (literal "/Volumes")
    (subpath "/Volumes")
    (home-literal "/Desktop")
    (home-literal "/Documents")
    (home-literal "/Downloads")
    (home-literal "/Applications")
    (home-literal "/Library")
    (home-literal "/Library/Application Support")
    (home-literal "/Library/Caches")
    (home-literal "/Library/CloudStorage")
    (home-literal "/Library/Containers")
    (home-literal "/Library/HTTPStorages")
    (home-literal "/Library/Logs")
    (home-literal "/Library/Mobile Documents")
    (home-subpath "/Library/Mobile Documents")
    (home-literal "/Library/Spelling")
    (home-literal "/.Trash")
)

(allow user-preference-read
    (preference-domain "com.apple.hitoolbox")
)

;; -- Mach services -------------------------------------------------------------

(allow mach-lookup
    ;; Font services
    (global-name "com.apple.fonts")
    (global-name "com.apple.FontObjectsServer")
    ;; Core rendering and window management
    (global-name "com.apple.CARenderServer")
    (global-name "com.apple.windowserver.active")
    (global-name "com.apple.windowmanager.server")
    (global-name "com.apple.window_proxies")
    (global-name "com.apple.dock.server")
    (global-name "com.apple.dock.fullscreen")
    ;; TCC (permission) and security
    (global-name "com.apple.tccd")
    (global-name "com.apple.tccd.system")
    (global-name "com.apple.universalaccessAuthWarn")
    ;; Launch Services, Core Services, and icon resolution
    (global-name "com.apple.lsd.mapdb")
    (global-name "com.apple.lsd.modifydb")
    (global-name "com.apple.lsd.advertisingidentifiers")
    (global-name "com.apple.iconservices")
    (global-name "com.apple.coreservices.appleevents")
    (global-name "com.apple.coreservices.sharedfilelistd.xpc")
    (global-name "com.apple.coreservices.quarantine-resolver")
    ;; HI services, input, and accessibility
    (global-name "com.apple.hiservices-xpcservice")
    (global-name "com.apple.iohideventsystem")
    (global-name "com.apple.tsm.uiserver")
    (global-name "com.apple.touchbarserver.mig")
    (global-name "com.apple.accessibility.voices")
    (global-name "com.apple.backboard.hid-services.xpc")
    (global-name "com.apple.backboard.BKSEndpointProviderService")
    (global-name "com.apple.TextInputUI.xpc.CursorUIViewService")
    (global-name "com.apple.inputmethodkit.launchagent")
    (global-name "com.apple.inputmethodkit.launcher")
    (global-name "com.apple.inputmethodkit.getxpcendpoint")
    ;; AppKit and UI framework services
    (global-name "com.apple.ViewBridgeAuxiliary")
    (global-name "com.apple.appkit.restoration_storage")
    (global-name "com.apple.pbs.fetch_services")
    (global-name "com.apple.uiintelligencesupport.agent")
    (global-name "com.apple.controlcenter.statusitems")
    (global-name "com.apple.sidecar-relay")            ;; Sidecar/AirPlay display menu probing in AppKit.
    (global-name "com.apple.storekitagent")
    (global-name "com.apple.scopedbookmarksagent.xpc")
    ;; XPC, directory, and system services
    (global-name "com.apple.xpc.smd")
    (global-name "com.apple.bsd.dirhelper")
    (global-name "com.apple.system.opendirectoryd.membership")
    (global-name "com.apple.logd.events")
    (global-name "com.apple.usymptomsd")
    (global-name "com.apple.spotlight.IndexAgent")
    ;; Location services
    (global-name "com.apple.CoreLocation.agent")
    (global-name "com.apple.locationd.desktop.registration")
    ;; Notifications and audio
    (global-name "com.apple.usernotifications.listener")
    (global-name "com.apple.audio.SystemSoundServer-OSX")
    (global-name "com.apple.audio.audiohald")
    (global-name "com.apple.cmio.registerassistantservice.system-extensions")
    ;; Spell checking, grammar, and natural language
    (global-name "mul-xpc (Apple)_OpenStep")
    (global-name "com.apple.naturallanguaged")
    (global-name "com.apple.inputanalyticsd")
    ;; Backup
    (global-name "com.apple.backupd.sandbox.xpc")
    ;; SSO and Siri
    (global-name "com.apple.AppSSO.service-xpc")
    (global-name "com.apple.siri.VoiceShortcuts.xpc")
    (global-name "com.apple.proactive.app-client.donation")
    ;; Distributed notifications (per-user suffix varies)
    (global-name-prefix "com.apple.distributed_notifications@")
)

;; Per-pid mach port registrations for accessibility, text input, and drag-and-drop
(allow mach-register
    (local-name "com.apple.axserver")
    (local-name "com.apple.tsm.portname")
    (local-name "com.apple.coredrag")
)

;; -- IOKit (power management, HID input, storage) ------------------------------

(allow iokit-open
    (iokit-user-client-class "RootDomainUserClient")
    (iokit-user-client-class "IOHIDParamUserClient")
    (iokit-user-client-class "AppleNVMeEANUC")
)
__SAFEHOUSE_EMBEDDED_profiles_55_integrations_optional_macos_gui_sb__
      ;;
    "profiles/55-integrations-optional/spotlight.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_55_integrations_optional_spotlight_sb__'
;; ---------------------------------------------------------------------------
;; Integration: Spotlight
;; Spotlight search via mdfind/mdls/mdutil for filesystem indexing.
;; Source: 55-integrations-optional/spotlight.sb
;; ---------------------------------------------------------------------------

(allow mach-lookup
    (global-name "com.apple.metadata.mds")             ;; Primary Spotlight metadata server used by mdfind/mdls queries.
    (global-name "com.apple.metadata.mds.legacy")      ;; Legacy Spotlight query interface still used by some tools.
    (global-name "com.apple.PowerManagement.control")  ;; Power state queries used by spotlightknowledged helper.
)
__SAFEHOUSE_EMBEDDED_profiles_55_integrations_optional_spotlight_sb__
      ;;
    "profiles/55-integrations-optional/ssh.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_55_integrations_optional_ssh_sb__'
;; ---------------------------------------------------------------------------
;; Integration: SSH
;; SSH agent sockets, system config, key deny rules, and safe config access.
;; Source: 55-integrations-optional/ssh.sb
;; ---------------------------------------------------------------------------

;; Consolidates agent socket access, system config reads, key deny rules, and safe config allowances.

;; Defense-in-depth: block private key reads/writes by default.
(deny file-read* file-write*
    (home-subpath "/.ssh")                                          ;; Block SSH key reads and tampering from any jailed agent process.
)

;; Directory traversal so specific-file allows below can resolve through ~/.ssh.
(allow file-read-metadata
    (home-literal "/.ssh")
)

;; Allow non-sensitive SSH metadata that agents need for git/remote operations.
(allow file-read*
    (home-literal "/.ssh/known_hosts")                              ;; Host verification for GitHub/remote connections.
    (home-literal "/.ssh/config")                                   ;; Custom host definitions used by git-ssh and scp.
    (home-subpath "/.ssh/config.d")                                 ;; Include-based SSH config fragments.
    (home-literal "/.ssh/allowed_signers")                          ;; SSH signature verification (git commit signing).
    (literal "/private/etc/ssh/ssh_config")                         ;; System SSH client config read during ssh/git-ssh connections.
    (subpath "/private/etc/ssh/ssh_config.d")                       ;; SSH config.d drop-in directory read by modern ssh clients.
    (literal "/private/etc/ssh/crypto.conf")                        ;; System-wide SSH crypto policy (ciphers, MACs, KEX algorithms).
    (subpath "/private/etc/ssh/crypto")                             ;; SSH crypto config subdirectory (e.g. apple.conf).
)

;; Allow writing known_hosts so first-connect host key acceptance persists.
(allow file-write*
    (home-literal "/.ssh/known_hosts")                              ;; Persist host keys on first connection.
    (home-literal "/.ssh/known_hosts.old")                          ;; Rotated during host key updates.
)

;; SSH agent socket access via launchd-managed SSH_AUTH_SOCK.
(allow file-read* file-write*
    (regex #"^/private/tmp/com\.apple\.launchd\.[^/]+/Listeners$")  ;; launchd-managed SSH_AUTH_SOCK path on macOS.
    (regex #"^/tmp/com\.apple\.launchd\.[^/]+/Listeners$")          ;; symlinked tmp variant of SSH_AUTH_SOCK path.
)
__SAFEHOUSE_EMBEDDED_profiles_55_integrations_optional_ssh_sb__
      ;;
    "profiles/60-agents/aider.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_60_agents_aider_sb__'
;; ---------------------------------------------------------------------------
;; Agent: Aider
;; Aider CLI binary, state, and config paths.
;; Source: 60-agents/aider.sb
;; ---------------------------------------------------------------------------

;; - pipx-style binary location: ~/.local/bin/aider
;; - local state/config
;; - package updates are package-manager driven via python toolchain paths

(allow file-read* file-write*
    (home-prefix "/.local/bin/aider")
    (home-prefix "/.local/bin/aider-install")
    (home-prefix "/.aider")
    (home-literal "/.aider.conf.yml")
    (home-literal "/.aider.model.settings.yml")
    (home-literal "/.aider.model.metadata.json")
    (home-literal "/.env")
    (home-subpath "/.config/aider")
    (home-subpath "/.cache/aider")
    (home-subpath "/.local/share/aider")
)
__SAFEHOUSE_EMBEDDED_profiles_60_agents_aider_sb__
      ;;
    "profiles/60-agents/amp.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_60_agents_amp_sb__'
;; ---------------------------------------------------------------------------
;; Agent: Amp
;; Amp CLI binary, state, and config paths.
;; Source: 60-agents/amp.sb
;; ---------------------------------------------------------------------------

;; - install script binary locations:
;;   - ~/.amp/bin/amp
;;   - ~/.local/bin/amp (symlink target)
;; - local state/config
;; - auth storage: Amp CLI stores encrypted credentials in ~/.local/share/amp/secrets.json
;;   (not macOS Keychain)

(allow file-read* file-write*
    (home-prefix "/.amp/bin/amp")
    (home-prefix "/.local/bin/amp")
    (home-subpath "/.amp")
    (home-subpath "/.config/amp")
    (home-subpath "/.cache/amp")
    (home-subpath "/.local/share/amp")
    (home-subpath "/.local/state/amp")
)
__SAFEHOUSE_EMBEDDED_profiles_60_agents_amp_sb__
      ;;
    "profiles/60-agents/auggie.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_60_agents_auggie_sb__'
;; ---------------------------------------------------------------------------
;; Agent: Auggie
;; Auggie CLI binary, state, and config paths.
;; Source: 60-agents/auggie.sb
;; ---------------------------------------------------------------------------

;; - npm global install path follows package-manager prefix/bin
;; - ~/.local/bin is the common user-level target and fallback
;; - canonical Auggie state/config root is ~/.augment

(allow file-read* file-write*
    (home-prefix "/.local/bin/auggie")
    (home-subpath "/.augment")  ;; session.json, settings.json, oauth-state.json, commands/, skills/, agents/, rules/.
)
__SAFEHOUSE_EMBEDDED_profiles_60_agents_auggie_sb__
      ;;
    "profiles/60-agents/claude-code.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_60_agents_claude_code_sb__'
;; ---------------------------------------------------------------------------
;; Agent: Claude Code
;; Claude Code CLI binary, state, config, and MCP integration paths.
;; Source: 60-agents/claude-code.sb
;; $$require=55-integrations-optional/keychain.sb$$
;; ---------------------------------------------------------------------------

;; - installer-managed binary path: ~/.local/bin/claude (symlink target under ~/.local/share/claude/versions/*)
;; - local state/config under ~/.claude and ~/.claude.json
;; - macOS managed policy files under /Library/Application Support/ClaudeCode
;; - optional Claude Desktop MCP import source in ~/Library/Application Support/Claude
;; - optional user-level guidance file at ~/CLAUDE.md (granted via shared profile)

(allow file-read* file-write*
    (home-prefix "/.local/bin/claude")
    (home-subpath "/.cache/claude")
    (home-prefix "/.claude") ; this include .claude folder, as well as .claude.json and .claude.lock.json etc files
    (home-subpath "/.config/claude")
    (home-subpath "/.local/state/claude")
    (home-subpath "/.local/share/claude")
    (home-literal "/.mcp.json")
)

(allow file-read*
    (home-prefix "/.claude.json.")
    (home-literal "/Library/Application Support/Claude/claude_desktop_config.json")
    (subpath "/Library/Application Support/ClaudeCode/.claude")
    (literal "/Library/Application Support/ClaudeCode/managed-settings.json")
    (literal "/Library/Application Support/ClaudeCode/managed-mcp.json")
    (literal "/Library/Application Support/ClaudeCode/CLAUDE.md")
)
__SAFEHOUSE_EMBEDDED_profiles_60_agents_claude_code_sb__
      ;;
    "profiles/60-agents/cline.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_60_agents_cline_sb__'
;; ---------------------------------------------------------------------------
;; Agent: Cline
;; Cline CLI binary, state, and config paths.
;; Source: 60-agents/cline.sb
;; $$require=55-integrations-optional/keychain.sb$$
;; ---------------------------------------------------------------------------

;; - no official standalone CLI install path documented; keep ~/.local/bin fallback
;; - local state/config

(allow file-read* file-write*
    (home-prefix "/.local/bin/cline")
    (home-subpath "/.cline")
    (home-subpath "/.config/cline")
    (home-subpath "/.cache/cline")
    (home-subpath "/.local/share/cline")
    (home-subpath "/.local/state/cline")
    (home-subpath "/Documents/Cline")               ;; Cline MCP servers, rules, workflows, hooks.
    (home-subpath "/Library/Application Support/Code/User/globalStorage/saoudrizwan.claude-dev")
    (home-literal "/.qwen/oauth_creds.json")
)

(allow file-read*
    (home-literal "/.oca/config.json")
)
__SAFEHOUSE_EMBEDDED_profiles_60_agents_cline_sb__
      ;;
    "profiles/60-agents/codex.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_60_agents_codex_sb__'
;; ---------------------------------------------------------------------------
;; Agent: Codex
;; Codex CLI binary, state, and config paths.
;; Source: 60-agents/codex.sb
;; $$require=55-integrations-optional/keychain.sb$$
;; ---------------------------------------------------------------------------

;; - npm/bun global installs place binaries under package-manager prefix/bin
;; - ~/.local/bin is the common user-level target and fallback
;; - local state/config
;; - package updates are package-manager driven via node toolchain paths

(allow file-read* file-write*
    (home-prefix "/.local/bin/codex")
    (home-subpath "/.codex")
    (home-subpath "/.cache/codex")
)

(allow file-read*
    (home-literal "/Library/Preferences/com.openai.codex.plist")  ;; Codex user-level preferences plist.
    (literal "/Library/Preferences/com.openai.codex.plist")       ;; Codex system preferences plist (managed setups).
    (literal "/Library/Managed Preferences/com.openai.codex.plist") ;; Codex MDM-managed preferences payload.
    (subpath "/etc/codex")                                         ;; System-wide config and requirements layers.
)
__SAFEHOUSE_EMBEDDED_profiles_60_agents_codex_sb__
      ;;
    "profiles/60-agents/cursor-agent.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_60_agents_cursor_agent_sb__'
;; ---------------------------------------------------------------------------
;; Agent: Cursor
;; Cursor CLI binary, state, config, and app bundle paths.
;; Source: 60-agents/cursor-agent.sb
;; ---------------------------------------------------------------------------

;; - official cursor-agent install/update manages:
;;   - ~/.local/bin/agent and ~/.local/bin/cursor-agent symlinks
;;   - ~/.local/bin/cursor shim
;;   - ~/.local/share/cursor-agent/versions/<version>/cursor-agent binary + .install.lock
;; - local state/config defaults to ~/.cursor (including project state under ~/.cursor/projects)
;; - wrapper sets NODE_COMPILE_CACHE under ~/Library/Caches/cursor-compile-cache on macOS
;; - CLI reads Cursor IDE workspace metadata under ~/Library/Application Support/Cursor/User/workspaceStorage

(allow file-read* file-write*
    (home-prefix "/.local/bin/agent")
    (home-prefix "/.local/bin/cursor-agent")
    (home-prefix "/.local/bin/cursor")
    (home-subpath "/.local/share/cursor-agent")
    (home-subpath "/.cursor")
    (home-subpath "/.config/cursor")
    (home-subpath "/.cache/cursor-compile-cache")
    (home-subpath "/Library/Caches/cursor-compile-cache")
)

(allow file-read*
    (home-subpath "/Library/Application Support/Cursor")
    (literal "/Applications")
    (literal "/usr/local/bin/cursor")
    (literal "/opt/homebrew/bin/cursor")
    (subpath "/Applications/Cursor.app")
)
__SAFEHOUSE_EMBEDDED_profiles_60_agents_cursor_agent_sb__
      ;;
    "profiles/60-agents/droid.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_60_agents_droid_sb__'
;; ---------------------------------------------------------------------------
;; Agent: Droid
;; Droid CLI binary, Factory helpers, state, and config paths.
;; Source: 60-agents/droid.sb
;; ---------------------------------------------------------------------------

;; - install script binary location: ~/.local/bin/droid
;; - installer also manages helper binaries under ~/.factory/bin
;; - local state/config (Factory CLI root)

(allow file-read* file-write*
    (home-prefix "/.local/bin/droid")
    (home-subpath "/.factory")
)
__SAFEHOUSE_EMBEDDED_profiles_60_agents_droid_sb__
      ;;
    "profiles/60-agents/gemini.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_60_agents_gemini_sb__'
;; ---------------------------------------------------------------------------
;; Agent: Gemini
;; Gemini CLI binary, state, and config paths.
;; Source: 60-agents/gemini.sb
;; $$require=55-integrations-optional/keychain.sb$$
;; ---------------------------------------------------------------------------

;; - npm global install path follows package-manager prefix/bin
;; - ~/.local/bin is the common user-level target and fallback
;; - local state/config
;; - package updates are package-manager or built-in update driven via entrypoint

(allow file-read* file-write*
    (home-prefix "/.local/bin/gemini")
    (home-subpath "/.gemini")
    (home-subpath "/.cache/gemini")
)

;; Enterprise managed settings
(allow file-read*
    (subpath "/Library/Application Support/GeminiCli")
)
__SAFEHOUSE_EMBEDDED_profiles_60_agents_gemini_sb__
      ;;
    "profiles/60-agents/goose.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_60_agents_goose_sb__'
;; ---------------------------------------------------------------------------
;; Agent: Goose
;; Goose CLI binary, state, and config paths.
;; Source: 60-agents/goose.sb
;; $$require=55-integrations-optional/keychain.sb$$
;; ---------------------------------------------------------------------------

;; - install script and package-manager installs commonly place `goose` under ~/.local/bin
;; - local state/config paths (XDG + legacy home root)
;; - package updates are package-manager or self-update driven via entrypoint

(allow file-read* file-write*
    (home-prefix "/.local/bin/goose")
    (home-subpath "/.goose")
    (home-subpath "/.config/goose")
    (home-subpath "/.cache/goose")
    (home-subpath "/.local/share/goose")
    (home-subpath "/.local/state/goose")
    (home-subpath "/Library/Application Support/Block.goose")
)
__SAFEHOUSE_EMBEDDED_profiles_60_agents_goose_sb__
      ;;
    "profiles/60-agents/kilo-code.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_60_agents_kilo_code_sb__'
;; ---------------------------------------------------------------------------
;; Agent: Kilo Code
;; Kilo Code CLI binary, state, and config paths.
;; Source: 60-agents/kilo-code.sb
;; $$require=55-integrations-optional/keychain.sb$$
;; ---------------------------------------------------------------------------

;; - npm package @kilocode/cli installs `kilocode` and `kilo` executables
;; - ~/.local/bin is the common user-level target and fallback for npm/pnpm shims
;; - Kilo CLI stores config, logs, sessions, and commands under ~/.kilocode (and legacy ~/.roo)
;; - CLI uses VS Code extension global storage for tasks/sessions/settings/cache
;; - MDM config is read from /Library/Application Support/RooCode
;; - macOS MCP server directory may live under ~/Documents/Kilo-Code/MCP

(allow file-read* file-write*
    (home-prefix "/.local/bin/kilo")
    (home-prefix "/.local/bin/kilocode")
    (home-subpath "/.kilocode")
    (home-subpath "/.roo")
    (home-subpath "/Documents/Kilo-Code/MCP")
    (home-subpath "/Library/Application Support/Code/User/globalStorage/kilocode.kilo-code")
)

(allow file-read*
    (subpath "/Library/Application Support/RooCode")
)
__SAFEHOUSE_EMBEDDED_profiles_60_agents_kilo_code_sb__
      ;;
    "profiles/60-agents/opencode.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_60_agents_opencode_sb__'
;; ---------------------------------------------------------------------------
;; Agent: openCode
;; openCode CLI binary, state, and config paths.
;; Source: 60-agents/opencode.sb
;; ---------------------------------------------------------------------------

;; - install script binary locations:
;;   - ~/.opencode/bin/opencode
;;   - $XDG_BIN_DIR/opencode (commonly ~/.local/bin/opencode)
;;   - ~/bin/opencode
;; - local state/config

(allow file-read* file-write*
    (home-prefix "/.opencode/bin/opencode")
    (home-prefix "/.local/bin/opencode")
    (home-prefix "/bin/opencode")
    (home-subpath "/.opencode")
    (home-subpath "/.config/opencode")
    (home-subpath "/.cache/opencode")
    (home-subpath "/.local/share/opencode")
    (home-subpath "/.local/share/opentui")
    (home-subpath "/.local/state/opencode")
    (home-literal "/.opencode.json")                ;; Home-dir config file.
)

;; GitHub Copilot token read for auth
(allow file-read*
    (home-subpath "/.config/github-copilot")
)
__SAFEHOUSE_EMBEDDED_profiles_60_agents_opencode_sb__
      ;;
    "profiles/60-agents/pi.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_60_agents_pi_sb__'
;; ---------------------------------------------------------------------------
;; Agent: PI
;; PI CLI binary, state, and config paths.
;; Source: 60-agents/pi.sb
;; ---------------------------------------------------------------------------

;; - npm global install path follows package-manager prefix/bin
;; - ~/.local/bin is the common user-level target and fallback
;; - local state/config
;; - package updates are package-manager driven via node toolchain paths

(allow file-read* file-write*
    (home-prefix "/.local/bin/pi")
    (home-subpath "/.pi")
)
__SAFEHOUSE_EMBEDDED_profiles_60_agents_pi_sb__
      ;;
    "profiles/65-apps/claude-app.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_65_apps_claude_app_sb__'
;; ---------------------------------------------------------------------------
;; App: Claude Desktop
;; Claude for Desktop (Electron) app bundle, preferences, and data paths.
;; Source: 65-apps/claude-app.sb
;; $$require=55-integrations-optional/keychain.sb,55-integrations-optional/macos-gui.sb,55-integrations-optional/electron.sb$$
;; ---------------------------------------------------------------------------

;; Requires: 55-integrations-optional/macos-gui.sb   (window server, AppKit, input, accessibility)
;;           55-integrations-optional/electron.sb     (GPU, Metal, crashpad, WebView)

(allow file-read* file-write*
    (home-subpath "/Library/Application Support/Claude")
    (home-subpath "/Library/Logs/Claude")
    (home-subpath "/Library/HTTPStorages/com.anthropic.claudefordesktop")
    (home-subpath "/Library/Caches/Claude")
    (home-prefix "/Library/Caches/com.anthropic.claudefordesktop")
    (home-subpath "/Library/Saved Application State/com.anthropic.claudefordesktop.savedState")
)

(allow file-read*
    (subpath "/Applications/Claude.app")
    (home-literal "/Library/Preferences/com.anthropic.claudefordesktop.plist")
)

;; Claude Desktop persists app preferences via cfprefsd under its own domain.
(allow user-preference-read user-preference-write
    (preference-domain "com.anthropic.claudefordesktop")
)

;; Background Task Management: login item status query (SMAppService.mainApp.status).
;; Without this, SMAppService silently returns .notFound, causing the
;; "isStartupOnLoginEnabled failed to pass validation" Electron IPC error.
;; File chooser/open panel dialogs use this AppKit XPC service.
;; powerlog logger service is probed by Claude Desktop on startup.
;; File coordination and syspolicy services are queried by AppKit/LaunchServices
;; flows during file operations and app trust checks.
;; Electron MachPortRendezvousServer IPC (PID-suffixed, app-specific bundle ID).
(allow mach-lookup
    (global-name "com.apple.backgroundtaskmanagementagent")
    (global-name "com.apple.appkit.xpc.openAndSavePanelService")
    (global-name "com.apple.powerlog.plxpclogger.xpc")
    (global-name "com.apple.FileCoordination")
    (global-name "com.apple.security.syspolicy")
    (global-name "com.apple.security.syspolicy.exec")
    (global-name-regex #"^com\.anthropic\.claudefordesktop\.MachPortRendezvousServer\.")
)

(allow mach-register
    (global-name-regex #"^com\.anthropic\.claudefordesktop\.MachPortRendezvousServer\.")
)

;; HFSIOC_SET_HOTFILE_STATE is occasionally probed during Desktop app file flows.
(allow system-fsctl
    (fsctl-command (_IO "h" 47))
)
__SAFEHOUSE_EMBEDDED_profiles_65_apps_claude_app_sb__
      ;;
    "profiles/65-apps/vscode-app.sb")
      cat <<'__SAFEHOUSE_EMBEDDED_profiles_65_apps_vscode_app_sb__'
;; ---------------------------------------------------------------------------
;; App: Visual Studio Code
;; VS Code / VS Code Insiders desktop app bundle, preferences, and data paths,
;; including DeveloperTools state and optional extension pairing storage.
;; Source: 65-apps/vscode-app.sb
;; $$require=55-integrations-optional/keychain.sb,55-integrations-optional/macos-gui.sb,55-integrations-optional/electron.sb$$
;; ---------------------------------------------------------------------------

;; Requires: 55-integrations-optional/macos-gui.sb   (window server, AppKit, input, accessibility)
;;           55-integrations-optional/electron.sb     (GPU, Metal, crashpad, WebView)

(allow file-read* file-write*
    ;; Stable
    (home-subpath "/Library/Application Support/Code")
    (home-subpath "/Library/Logs/Code")
    (home-subpath "/Library/HTTPStorages/com.microsoft.VSCode")
    (home-subpath "/Library/Caches/com.microsoft.VSCode")
    (home-subpath "/Library/Caches/com.microsoft.VSCode.ShipIt")
    (home-subpath "/Library/Saved Application State/com.microsoft.VSCode.savedState")
    (home-subpath "/Library/Application Support/Microsoft/DeveloperTools")
    (home-subpath "/Library/Application Support/com.openai.chat/app_pairing_extensions")
    (home-subpath "/.vscode")

    ;; Direct plist writes/unlink probes used during some Electron preference sync flows.
    (home-literal "/Library/Preferences/com.microsoft.VSCode.plist")
    (home-literal "/Library/Preferences/com.microsoft.VSCodeInsiders.plist")

    ;; Insiders
    (home-subpath "/Library/Application Support/Code - Insiders")
    (home-subpath "/Library/Logs/Code - Insiders")
    (home-subpath "/Library/HTTPStorages/com.microsoft.VSCodeInsiders")
    (home-subpath "/Library/Caches/com.microsoft.VSCodeInsiders")
    (home-subpath "/Library/Caches/com.microsoft.VSCodeInsiders.ShipIt")
    (home-subpath "/Library/Saved Application State/com.microsoft.VSCodeInsiders.savedState")
    (home-subpath "/.vscode-insiders")
)

(allow file-read*
    ;; Common install locations
    (subpath "/Applications/Visual Studio Code.app")
    (subpath "/Applications/Visual Studio Code - Insiders.app")
)

;; VS Code persists app preferences via cfprefsd under these domains.
(allow user-preference-read user-preference-write
    (preference-domain "com.microsoft.VSCode")
    (preference-domain "com.microsoft.VSCodeInsiders")
)

;; Background Task Management: login item status query (SMAppService.mainApp.status).
;; File chooser/open panel dialogs use this AppKit XPC service.
;; powerlog logger service is probed by Electron on startup.
;; File coordination and syspolicy services are queried by AppKit/LaunchServices
;; flows during file operations and app trust checks.
;; Electron MachPortRendezvousServer IPC (PID-suffixed, app-specific bundle IDs).
(allow mach-lookup
    (global-name "com.apple.backgroundtaskmanagementagent")
    (global-name "com.apple.appkit.xpc.openAndSavePanelService")
    (global-name "com.apple.powerlog.plxpclogger.xpc")
    (global-name "com.apple.FileCoordination")
    (global-name "com.apple.security.syspolicy")
    (global-name "com.apple.security.syspolicy.exec")
    (global-name-regex #"^com\.microsoft\.VSCode\.MachPortRendezvousServer\.")
    (global-name-regex #"^com\.microsoft\.VSCodeInsiders\.MachPortRendezvousServer\.")
)

(allow mach-register
    (global-name-regex #"^com\.microsoft\.VSCode\.MachPortRendezvousServer\.")
    (global-name-regex #"^com\.microsoft\.VSCodeInsiders\.MachPortRendezvousServer\.")
)

;; HFSIOC_SET_HOTFILE_STATE is occasionally probed during Desktop app file flows.
(allow system-fsctl
    (fsctl-command (_IO "h" 47))
)
__SAFEHOUSE_EMBEDDED_profiles_65_apps_vscode_app_sb__
      ;;
    *)
      return 1
      ;;
  esac
}


SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
ROOT_DIR="$(cd "${SCRIPT_DIR}/.." && pwd -P)"
PROFILES_DIR="${ROOT_DIR}/profiles"
HOME_DIR_TEMPLATE_TOKEN="__SAFEHOUSE_REPLACE_ME_WITH_ABSOLUTE_HOME_DIR__"

home_dir="${HOME:-}"
enable_csv_list=""
enable_docker_integration=0
enable_kubectl_integration=0
enable_macos_gui_integration=0
enable_electron_integration=0
enable_ssh_integration=0
enable_spotlight_integration=0
enable_cleanshot_integration=0
enable_onepassword_integration=0
enable_cloud_credentials_integration=0
enable_browser_native_messaging_integration=0
optional_integration_features=(
  docker
  kubectl
  macos-gui
  electron
  ssh
  spotlight
  cleanshot
  1password
  cloud-credentials
  browser-native-messaging
)
supported_enable_features="docker, kubectl, macos-gui, electron, ssh, spotlight, cleanshot, 1password, cloud-credentials, browser-native-messaging, all-agents, wide-read"
enable_all_agents_profiles=0
enable_wide_read_access=0
output_path=""
add_dirs_ro_list_cli=""
add_dirs_list_cli=""
config_add_dirs_ro_list=""
config_add_dirs_list=""
combined_add_dirs_ro_list=""
combined_add_dirs_list=""
append_profile_paths=()
env_add_dirs_ro_list="${SAFEHOUSE_ADD_DIRS_RO:-}"
env_add_dirs_list="${SAFEHOUSE_ADD_DIRS:-}"
workdir_value=""
workdir_flag_set=0
workdir_env_value=""
workdir_env_set=0
invocation_cwd="$(pwd -P)"
effective_workdir=""
workdir_config_filename=".safehouse"
workdir_config_path=""
invoked_command_path=""
invoked_command_basename=""
invoked_command_app_bundle=""
selected_agent_profile_basenames=()
selected_agent_profiles_resolved=0
keychain_requirement_token="55-integrations-optional/keychain.sb"
macos_gui_requirement_token="55-integrations-optional/macos-gui.sb"
electron_requirement_token="55-integrations-optional/electron.sb"
selected_profiles_require_keychain=0
selected_profiles_require_keychain_resolved=0

readonly_paths=()
rw_paths=()
readonly_count=0
rw_count=0

stdout_policy=0

if [[ "${SAFEHOUSE_WORKDIR+x}" == "x" ]]; then
  workdir_env_set=1
  workdir_env_value="${SAFEHOUSE_WORKDIR}"
fi


preflight_runtime() {
  local os_name
  os_name="$(uname -s 2>/dev/null || printf 'unknown')"
  if [[ "$os_name" != "Darwin" ]]; then
    echo "safehouse requires macOS (Darwin) to execute commands under sandbox-exec." >&2
    echo "Detected platform: ${os_name}" >&2
    echo "Tip: run with no command (or --stdout) to generate policy output only." >&2
    exit 1
  fi

  if ! command -v sandbox-exec >/dev/null 2>&1; then
    echo "safehouse could not find sandbox-exec in PATH." >&2
    echo "Expected binary on macOS: /usr/bin/sandbox-exec" >&2
    echo "Run with no command (or --stdout) to inspect policy output without execution." >&2
    exit 1
  fi
}

detect_app_bundle() {
  local cmd_path="$1"
  local check_path="$cmd_path"

  while [[ "$check_path" != "/" && "$check_path" != "." && -n "$check_path" ]]; do
    if [[ "$check_path" == *.app ]]; then
      if [[ -d "$check_path" ]]; then
        printf '%s\n' "$check_path"
        return 0
      fi
    fi
    check_path="$(dirname "$check_path")"
  done
  return 1
}

trim_whitespace() {
  local s="$1"
  s="${s#"${s%%[![:space:]]*}"}"
  s="${s%"${s##*[![:space:]]}"}"
  printf '%s' "$s"
}

to_lowercase() {
  local value="$1"
  printf '%s' "$value" | tr '[:upper:]' '[:lower:]'
}

expand_tilde() {
  local p="$1"

  case "$p" in
    "~")
      printf '%s\n' "$home_dir"
      ;;
    "~/"*)
      printf '%s\n' "${home_dir}${p:1}"
      ;;
    *)
      printf '%s\n' "$p"
      ;;
  esac
}

append_colon_list() {
  local existing="$1"
  local addition="$2"

  if [[ -z "$addition" ]]; then
    printf '%s\n' "$existing"
    return
  fi

  if [[ -n "$existing" ]]; then
    printf '%s:%s\n' "$existing" "$addition"
  else
    printf '%s\n' "$addition"
  fi
}

strip_matching_quotes() {
  local value="$1"
  local value_len first_char last_char

  value_len="${#value}"
  if [[ "$value_len" -lt 2 ]]; then
    printf '%s' "$value"
    return
  fi

  first_char="${value:0:1}"
  last_char="${value:value_len-1:1}"

  if [[ "$first_char" == "\"" && "$last_char" == "\"" ]]; then
    printf '%s' "${value:1:value_len-2}"
    return
  fi

  if [[ "$first_char" == "'" && "$last_char" == "'" ]]; then
    printf '%s' "${value:1:value_len-2}"
    return
  fi

  printf '%s' "$value"
}

normalize_abs_path() {
  local input="$1"
  if command -v realpath >/dev/null 2>&1; then
    realpath "$input"
    return
  fi

  if [[ -d "$input" ]]; then
    (
      cd "$input"
      pwd -P
    )
    return
  fi

  local parent base
  parent="$(dirname "$input")"
  base="$(basename "$input")"
  if [[ ! -d "$parent" ]]; then
    echo "Cannot normalize path; parent directory does not exist: ${parent} (input: ${input})" >&2
    exit 1
  fi

  local parent_resolved
  parent_resolved="$(cd "$parent" && pwd -P)" || {
    echo "Cannot normalize path; failed to resolve parent directory: ${parent} (input: ${input})" >&2
    exit 1
  }
  printf '%s/%s\n' "$parent_resolved" "$base"
}

resolve_default_workdir() {
  local cwd="$1"
  local git_root=""

  if command -v git >/dev/null 2>&1; then
    git_root="$(git -C "$cwd" rev-parse --show-toplevel 2>/dev/null || true)"
    if [[ -n "$git_root" && -d "$git_root" ]]; then
      normalize_abs_path "$git_root"
      return
    fi
  fi

  printf '%s\n' "$cwd"
}

escape_for_sb() {
  local val="$1"
  val="${val//\\/\\\\}"
  val="${val//\"/\\\"}"
  printf '%s' "$val"
}

load_workdir_config() {
  local config_path="$1"
  local line trimmed key raw_value value
  local line_number=0

  [[ -f "$config_path" ]] || return 0

  while IFS= read -r line || [[ -n "$line" ]]; do
    line_number=$((line_number + 1))
    trimmed="$(trim_whitespace "$line")"
    [[ -n "$trimmed" ]] || continue
    if [[ "${trimmed:0:1}" == "#" || "${trimmed:0:1}" == ";" ]]; then
      continue
    fi

    if [[ "$trimmed" != *=* ]]; then
      echo "Invalid config line in ${config_path}:${line_number}: expected key=value" >&2
      exit 1
    fi

    key="$(trim_whitespace "${trimmed%%=*}")"
    raw_value="${trimmed#*=}"
    value="$(trim_whitespace "$raw_value")"
    value="$(strip_matching_quotes "$value")"

    case "$key" in
      add-dirs-ro|add_dirs_ro|SAFEHOUSE_ADD_DIRS_RO)
        config_add_dirs_ro_list="$(append_colon_list "$config_add_dirs_ro_list" "$value")"
        ;;
      add-dirs|add_dirs|SAFEHOUSE_ADD_DIRS)
        config_add_dirs_list="$(append_colon_list "$config_add_dirs_list" "$value")"
        ;;
      *)
        # Ignore unknown keys to keep config compatibility simple/forwards-safe.
        ;;
    esac
  done < "$config_path"
}

append_csv_values() {
  local csv="$1"
  local IFS=','
  local value trimmed
  local -a values=()

  read -r -a values <<< "$csv"
  for value in "${values[@]}"; do
    trimmed="$(trim_whitespace "$value")"
    [[ -n "$trimmed" ]] || continue

    if [[ -n "$enable_csv_list" ]]; then
      enable_csv_list+=",${trimmed}"
    else
      enable_csv_list="${trimmed}"
    fi
  done
}

parse_enabled_features() {
  local csv="$1"
  local IFS=','
  local value trimmed
  local -a values=()

  [[ -n "$csv" ]] || return 0

  read -r -a values <<< "$csv"
  for value in "${values[@]}"; do
    trimmed="$(trim_whitespace "$value")"
    [[ -n "$trimmed" ]] || continue

    if [[ "$trimmed" == "onepassword" ]]; then
      trimmed="1password"
    fi

    if is_known_optional_integration_feature "$trimmed"; then
      set_optional_integration_feature_enabled "$trimmed"
      continue
    fi

    case "$trimmed" in
      all-agents)
        enable_all_agents_profiles=1
        ;;
      wide-read)
        enable_wide_read_access=1
        ;;
      *)
        echo "Unknown feature in --enable: ${trimmed}" >&2
        echo "Supported features: ${supported_enable_features}" >&2
        exit 1
        ;;
    esac
  done
}

optional_integration_feature_flag_var() {
  local feature="$1"
  local normalized

  case "$feature" in
    1password)
      printf '%s\n' "enable_onepassword_integration"
      return 0
      ;;
    "")
      return 1
      ;;
  esac

  normalized="${feature//-/_}"
  printf 'enable_%s_integration\n' "$normalized"
}

set_optional_integration_feature_enabled() {
  local feature="$1"
  local var_name

  var_name="$(optional_integration_feature_flag_var "$feature")" || return 1
  printf -v "$var_name" '%s' "1"
}

optional_integration_feature_enabled() {
  local feature="$1"
  local var_name

  var_name="$(optional_integration_feature_flag_var "$feature")" || return 1
  [[ "${!var_name:-0}" -eq 1 ]]
}

is_known_optional_integration_feature() {
  local candidate="$1"
  local feature

  for feature in "${optional_integration_features[@]-}"; do
    if [[ "$feature" == "$candidate" ]]; then
      return 0
    fi
  done

  return 1
}

optional_integration_feature_from_profile_basename() {
  local profile_basename="$1"
  local feature

  [[ "$profile_basename" == *.sb ]] || return 1
  feature="${profile_basename%.sb}"

  if is_known_optional_integration_feature "$feature"; then
    printf '%s\n' "$feature"
    return 0
  fi

  return 1
}

optional_integration_profile_path_from_feature() {
  local feature="$1"

  if ! is_known_optional_integration_feature "$feature"; then
    return 1
  fi

  printf '%s/55-integrations-optional/%s.sb\n' "$PROFILES_DIR" "$feature"
}

optional_enabled_integrations_require_integration() {
  local integration="$1"
  local feature profile_path

  for feature in "${optional_integration_features[@]-}"; do
    optional_integration_feature_enabled "$feature" || continue

    profile_path="$(optional_integration_profile_path_from_feature "$feature")" || continue
    if profile_declares_requirement "$profile_path" "$integration"; then
      return 0
    fi
  done

  return 1
}

append_selected_agent_profile() {
  local candidate="$1"
  local selected

  for selected in "${selected_agent_profile_basenames[@]-}"; do
    if [[ "$selected" == "$candidate" ]]; then
      return 0
    fi
  done

  selected_agent_profile_basenames+=("$candidate")
}

resolve_selected_agent_profiles() {
  local cmd app_bundle_base

  if [[ "$selected_agent_profiles_resolved" -eq 1 ]]; then
    return 0
  fi
  selected_agent_profiles_resolved=1
  selected_agent_profile_basenames=()

  if [[ "$enable_all_agents_profiles" -eq 1 ]]; then
    return 0
  fi

  cmd="$(to_lowercase "${invoked_command_basename:-}")"
  app_bundle_base="$(to_lowercase "$(basename "${invoked_command_app_bundle:-}")")"

  case "$app_bundle_base" in
    claude.app)
      append_selected_agent_profile "claude-app.sb"
      ;;
    "visual studio code.app"|"visual studio code - insiders.app")
      append_selected_agent_profile "vscode-app.sb"
      ;;
  esac

  case "$cmd" in
    aider)
      append_selected_agent_profile "aider.sb"
      ;;
    amp)
      append_selected_agent_profile "amp.sb"
      ;;
    auggie)
      append_selected_agent_profile "auggie.sb"
      ;;
    claude)
      if [[ "$app_bundle_base" != "claude.app" ]]; then
        append_selected_agent_profile "claude-code.sb"
      fi
      ;;
    claude-code)
      append_selected_agent_profile "claude-code.sb"
      ;;
    cline)
      append_selected_agent_profile "cline.sb"
      ;;
    codex)
      append_selected_agent_profile "codex.sb"
      ;;
    cursor|cursor-agent|agent)
      append_selected_agent_profile "cursor-agent.sb"
      ;;
    droid)
      append_selected_agent_profile "droid.sb"
      ;;
    gemini)
      append_selected_agent_profile "gemini.sb"
      ;;
    goose)
      append_selected_agent_profile "goose.sb"
      ;;
    kilo|kilocode)
      append_selected_agent_profile "kilo-code.sb"
      ;;
    opencode)
      append_selected_agent_profile "opencode.sb"
      ;;
    pi)
      append_selected_agent_profile "pi.sb"
      ;;
  esac
}

should_include_agent_profile_file() {
  local file_path="$1"
  local selected_profile base_name

  if [[ "$enable_all_agents_profiles" -eq 1 ]]; then
    return 0
  fi

  resolve_selected_agent_profiles
  base_name="$(basename "$file_path")"

  for selected_profile in "${selected_agent_profile_basenames[@]-}"; do
    if [[ "$selected_profile" == "$base_name" ]]; then
      return 0
    fi
  done

  return 1
}

profile_declares_requirement() {
  local profile_path="$1"
  local required_integration="$2"
  local required_normalized line raw_requirements entry normalized_entry
  local -a requirement_entries=()

  if [[ ! -f "$profile_path" ]]; then
    return 1
  fi

  required_normalized="$(to_lowercase "$required_integration")"

  while IFS= read -r line; do
    [[ "$line" == *'$$require='*'$$'* ]] || continue
    raw_requirements="${line#*\$\$require=}"
    raw_requirements="${raw_requirements%%\$\$*}"
    raw_requirements="$(trim_whitespace "$raw_requirements")"
    [[ -n "$raw_requirements" ]] || continue

    IFS=',' read -r -a requirement_entries <<< "$raw_requirements"
    for entry in "${requirement_entries[@]}"; do
      normalized_entry="$(to_lowercase "$(trim_whitespace "$entry")")"
      [[ -n "$normalized_entry" ]] || continue
      if [[ "$normalized_entry" == "$required_normalized" ]]; then
        return 0
      fi
    done
  done < "$profile_path"

  return 1
}

selected_profiles_require_integration() {
  local integration="$1"
  local integration_normalized selected_profile profile_path file
  local keychain_requirement_normalized
  local requires_integration=0

  integration_normalized="$(to_lowercase "$integration")"
  keychain_requirement_normalized="$(to_lowercase "$keychain_requirement_token")"

  if [[ "$integration_normalized" == "$keychain_requirement_normalized" && "$selected_profiles_require_keychain_resolved" -eq 1 ]]; then
    [[ "$selected_profiles_require_keychain" -eq 1 ]]
    return
  fi

  if [[ "$enable_all_agents_profiles" -eq 1 ]]; then
    while IFS= read -r file; do
      [[ -n "$file" ]] || continue
      if profile_declares_requirement "$file" "$integration_normalized"; then
        requires_integration=1
        break
      fi
    done < <(find "${PROFILES_DIR}/60-agents" "${PROFILES_DIR}/65-apps" -maxdepth 1 -type f -name '*.sb' | LC_ALL=C sort)
  else
    resolve_selected_agent_profiles
    for selected_profile in "${selected_agent_profile_basenames[@]-}"; do
      profile_path="${PROFILES_DIR}/60-agents/${selected_profile}"
      if profile_declares_requirement "$profile_path" "$integration_normalized"; then
        requires_integration=1
        break
      fi

      profile_path="${PROFILES_DIR}/65-apps/${selected_profile}"
      if profile_declares_requirement "$profile_path" "$integration_normalized"; then
        requires_integration=1
        break
      fi
    done
  fi

  if [[ "$integration_normalized" == "$keychain_requirement_normalized" ]]; then
    selected_profiles_require_keychain="$requires_integration"
    selected_profiles_require_keychain_resolved=1
  fi

  [[ "$requires_integration" -eq 1 ]]
}

append_profile() {
  local target="$1"
  local source="$2"
  if [[ ! -f "$source" ]]; then
    echo "Missing profile module: ${source}" >&2
    exit 1
  fi
  cat "$source" >> "$target"
  echo "" >> "$target"
}

append_resolved_base_profile() {
  local target="$1"
  local source="$2"
  local escaped_home
  escaped_home="$(escape_for_sb "$home_dir")"

  if [[ ! -f "$source" ]]; then
    echo "Missing profile module: ${source}" >&2
    exit 1
  fi

  # HOME_DIR in 00-base.sb uses a literal replacement token; inline HOME here.
  awk -v home="$escaped_home" -v token="$HOME_DIR_TEMPLATE_TOKEN" '
    BEGIN { replaced = 0 }
    {
      line = $0
      count = gsub(token, home, line)
      if (count > 0) {
        replaced = 1
      }
      print line
    }
    END {
      if (replaced == 0) {
        exit 64
      }
    }
  ' "$source" >> "$target" || {
    echo "Failed to resolve HOME_DIR placeholder in base profile: ${source}" >&2
    echo "Expected HOME_DIR placeholder token: ${HOME_DIR_TEMPLATE_TOKEN}" >&2
    exit 1
  }
  echo "" >> "$target"
}

append_all_module_profiles() {
  local target="$1"
  local base_dir="$2"
  local file
  local found_any=0
  local appended_any=0
  local is_scoped_profile_dir=0
  local emit_no_match_note=0

  case "$base_dir" in
    "${PROFILES_DIR}/60-agents"|"profiles/60-agents")
      is_scoped_profile_dir=1
      emit_no_match_note=1
      ;;
    "${PROFILES_DIR}/65-apps"|"profiles/65-apps")
      is_scoped_profile_dir=1
      ;;
  esac

  while IFS= read -r file; do
    [[ -n "$file" ]] || continue
    found_any=1

    if [[ "$is_scoped_profile_dir" -eq 1 ]] && ! should_include_agent_profile_file "$file"; then
      continue
    fi

    appended_any=1
    append_profile "$target" "$file"
  done < <(find "$base_dir" -maxdepth 1 -type f -name '*.sb' | LC_ALL=C sort)

  if [[ "$found_any" -eq 0 ]]; then
    echo "No module profiles found in: ${base_dir}" >&2
    exit 1
  fi

  if [[ "$is_scoped_profile_dir" -eq 1 ]]; then
    if [[ "$enable_all_agents_profiles" -eq 1 ]]; then
      return 0
    fi

    if [[ "$appended_any" -eq 0 && "$emit_no_match_note" -eq 1 ]]; then
      resolve_selected_agent_profiles
      if [[ "${#selected_agent_profile_basenames[@]}" -eq 0 ]]; then
        {
          echo ";; No command-matched app/agent profile selected; skipping 60-agents and 65-apps modules."
          echo ";; Use --enable=all-agents to restore legacy all-profile behavior."
          echo ""
        } >> "$target"
      fi
    fi
    return 0
  fi

  if [[ "$appended_any" -eq 0 ]]; then
    echo "No module profiles selected in: ${base_dir}" >&2
    exit 1
  fi
}

emit_integration_preamble() {
  local target="$1"
  local feature

  local -a opt_in_integrations=()
  for feature in "${optional_integration_features[@]-}"; do
    if ! optional_integration_feature_enabled "$feature"; then
      opt_in_integrations+=("$feature")
    fi
  done

  if [[ "${#opt_in_integrations[@]}" -gt 0 ]]; then
    echo ";; Opt-in integrations not enabled: ${opt_in_integrations[*]}" >> "$target"
    echo ";; Use --enable=<feature> (comma-separated) to include them." >> "$target"
    echo ";; Note: --enable=electron also enables macos-gui." >> "$target"
    echo ";; Note: selected app/agent profiles can auto-inject integration modules via \$\$require=<integration-profile-path>\$\$ metadata." >> "$target"
    echo "" >> "$target"
  fi

  echo ";; Threat-model note: blocking exfiltration/C2 is explicitly NOT a goal for this sandbox." >> "$target"
  echo "" >> "$target"
}

should_include_optional_integration_profile() {
  local profile_basename="$1"
  local feature integration_token

  integration_token="55-integrations-optional/${profile_basename}"

  case "$profile_basename" in
    keychain.sb)
      selected_profiles_require_integration "$integration_token" \
        || optional_enabled_integrations_require_integration "$integration_token"
      return
      ;;
  esac

  feature="$(optional_integration_feature_from_profile_basename "$profile_basename")" || {
    echo "Unknown optional integration profile: ${profile_basename}" >&2
    exit 1
  }

  optional_integration_feature_enabled "$feature" \
    || selected_profiles_require_integration "$integration_token" \
    || optional_enabled_integrations_require_integration "$integration_token"
}

append_optional_integration_profiles() {
  local target="$1"
  local base_dir="$2"
  local file
  local found_any=0

  while IFS= read -r file; do
    [[ -n "$file" ]] || continue
    found_any=1

    local base_name
    base_name="$(basename "$file")"
    should_include_optional_integration_profile "$base_name" || continue

    append_profile "$target" "$file"
  done < <(find "$base_dir" -maxdepth 1 -type f -name '*.sb' | LC_ALL=C sort)

  if [[ "$found_any" -eq 0 ]]; then
    echo "No optional integration profiles found in: ${base_dir}" >&2
    exit 1
  fi
}

emit_path_ancestor_literals() {
  local path="$1"
  local label="$2"

  {
    echo ";; Generated ancestor directory literals for ${label}: ${path}"
    echo ";;"
    echo ";; Why file-read* (not file-read-metadata) with literal (not subpath):"
    echo ";; Agents (notably Claude Code) call readdir() on every ancestor of the working"
    echo ";; directory during startup. If only file-read-metadata (stat) is granted, the"
    echo ";; agent cannot list directory contents, which causes it to blank PATH and break."
    echo ";; Using 'literal' (not 'subpath') keeps this safe: it grants read access to the"
    echo ";; directory entry itself (i.e. listing its immediate children), but does NOT"
    echo ";; grant recursive read access to files or subdirectories under it."
    echo "(allow file-read*"
    echo "    (literal \"/\")"

    local trimmed cur IFS part escaped_cur
    local -a parts=()
    trimmed="${path#/}"
    if [[ -n "$trimmed" ]]; then
      cur=""
      IFS='/'
      read -r -a parts <<< "$trimmed"
      for part in "${parts[@]}"; do
        [[ -z "$part" ]] && continue
        cur+="/${part}"
        escaped_cur="$(escape_for_sb "$cur")"
        echo "    (literal \"${escaped_cur}\")"
      done
    fi

    echo ")"
    echo ""
  }
}

emit_extra_access_rules() {
  local target="$1"
  local path escaped

  if [[ "$readonly_count" -eq 0 && "$rw_count" -eq 0 ]]; then
    return
  fi

  {
    echo ";; #safehouse-test-id:dynamic-cli-grants# Additional dynamic path grants from config/env/CLI."
    echo ";; NOTE: appended profile denies (--append-profile) may still block sensitive paths."
    echo ";; Emission order here is: add-dirs-ro sources first, then add-dirs sources."
    echo ""
  } >> "$target"

  if [[ "$readonly_count" -gt 0 ]]; then
    # Emit read-only extras first.
    for path in "${readonly_paths[@]}"; do
      emit_path_ancestor_literals "$path" "extra read-only path" >> "$target"
      escaped="$(escape_for_sb "$path")"
      if [[ -d "$path" ]]; then
        echo "(allow file-read* (subpath \"${escaped}\"))" >> "$target"
      else
        echo "(allow file-read* (literal \"${escaped}\"))" >> "$target"
      fi
      echo "" >> "$target"
    done
  fi

  if [[ "$rw_count" -gt 0 ]]; then
    # Emit read/write extras after read-only extras.
    for path in "${rw_paths[@]}"; do
      emit_path_ancestor_literals "$path" "extra read/write path" >> "$target"
      escaped="$(escape_for_sb "$path")"
      if [[ -d "$path" ]]; then
        echo "(allow file-read* file-write* (subpath \"${escaped}\"))" >> "$target"
      else
        echo "(allow file-read* file-write* (literal \"${escaped}\"))" >> "$target"
      fi
      echo "" >> "$target"
    done
  fi
}

emit_wide_read_access() {
  local target="$1"

  if [[ "$enable_wide_read_access" -ne 1 ]]; then
    return 0
  fi

  {
    echo ";; #safehouse-test-id:wide-read# Broad read-only visibility across the full filesystem."
    echo ";; Added by --enable=wide-read. This emits a recursive read grant on /."
    echo ";; WARNING: because this rule is emitted late, it can override earlier deny file-read* rules."
    echo ";; Use --append-profile deny rules if you must keep specific paths unreadable."
    echo "(allow file-read* (subpath \"/\"))"
    echo ""
  } >> "$target"
}

emit_workdir_access() {
  local target="$1"
  local path="$2"
  local escaped

  if [[ -z "$path" ]]; then
    return 0
  fi

  {
    echo ";; #safehouse-test-id:workdir-grant# Allow read/write access to the selected workdir."
  } >> "$target"

  emit_path_ancestor_literals "$path" "selected workdir" >> "$target"
  escaped="$(escape_for_sb "$path")"
  if [[ -d "$path" ]]; then
    echo "(allow file-read* file-write* (subpath \"${escaped}\"))" >> "$target"
  else
    echo "(allow file-read* file-write* (literal \"${escaped}\"))" >> "$target"
  fi
  echo "" >> "$target"
}

append_colon_paths() {
  local path_list="$1"
  local mode="$2"
  local IFS=':'
  local part trimmed expanded resolved
  local -a parts=()

  read -r -a parts <<< "$path_list"
  for part in "${parts[@]}"; do
    trimmed="$(trim_whitespace "$part")"
    [[ -n "$trimmed" ]] || continue

    expanded="$(expand_tilde "$trimmed")"

    if [[ ! -e "$expanded" ]]; then
      echo "Path does not exist: ${trimmed}" >&2
      exit 1
    fi

    resolved="$(normalize_abs_path "$expanded")"
    if [[ "$mode" == "readonly" ]]; then
      readonly_paths+=("$resolved")
      readonly_count=$((readonly_count + 1))
    else
      rw_paths+=("$resolved")
      rw_count=$((rw_count + 1))
    fi
  done
}

append_cli_profiles() {
  local target="$1"
  local source

  [[ "${#append_profile_paths[@]}" -gt 0 ]] || return 0

  for source in "${append_profile_paths[@]}"; do
    {
      echo ";; #safehouse-test-id:append-profile# Appended profile from --append-profile: ${source}"
      echo ""
    } >> "$target"
    append_profile "$target" "$source"
  done
}

build_profile() {
  local tmp

  if [[ -n "$output_path" ]]; then
    mkdir -p "$(dirname "$output_path")"
    tmp="$(mktemp "${output_path}.XXXXXX")"
  else
    local tmp_dir
    tmp_dir="${TMPDIR:-/tmp}"
    if [[ ! -d "$tmp_dir" ]]; then
      tmp_dir="/tmp"
    fi
    tmp="$(mktemp "${tmp_dir%/}/agent-sandbox-policy.XXXXXX")"
  fi

  trap 'rm -f "$tmp"' EXIT

  append_resolved_base_profile "$tmp" "${PROFILES_DIR}/00-base.sb"
  append_profile "$tmp" "${PROFILES_DIR}/10-system-runtime.sb"
  append_profile "$tmp" "${PROFILES_DIR}/20-network.sb"

  append_all_module_profiles "$tmp" "${PROFILES_DIR}/30-toolchains"
  append_all_module_profiles "$tmp" "${PROFILES_DIR}/40-shared"
  emit_integration_preamble "$tmp"
  append_all_module_profiles "$tmp" "${PROFILES_DIR}/50-integrations-core"
  append_optional_integration_profiles "$tmp" "${PROFILES_DIR}/55-integrations-optional"
  append_all_module_profiles "$tmp" "${PROFILES_DIR}/60-agents"
  append_all_module_profiles "$tmp" "${PROFILES_DIR}/65-apps"

  # Path-grant order:
  # 1) add-dirs-ro sources merged in precedence order (config, ENV, CLI) (RO)
  # 2) add-dirs sources merged in precedence order (config, ENV, CLI) (RW)
  # 3) optional --enable=wide-read grant (RO, recursive /)
  # 4) selected workdir (RW; omitted when disabled via --workdir= or SAFEHOUSE_WORKDIR=)
  # 5) appended profile(s) from --append-profile (final extension point)
  # Keep the selected workdir grant late among grants so it can take precedence over
  # add-dirs/add-dirs-ro if order matters. --append-profile rules are appended last.
  emit_extra_access_rules "$tmp"
  emit_wide_read_access "$tmp"
  emit_workdir_access "$tmp" "$effective_workdir"
  append_cli_profiles "$tmp"

  if [[ -n "$output_path" ]]; then
    mv "$tmp" "$output_path"
    trap - EXIT
    printf '%s\n' "$output_path"
  else
    trap - EXIT
    printf '%s\n' "$tmp"
  fi
}

generate_policy_file() {
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --enable)
        [[ $# -ge 2 ]] || { echo "Missing value for $1" >&2; exit 1; }
        append_csv_values "$2"
        shift 2
        ;;
      --enable=*)
        append_csv_values "${1#*=}"
        shift
        ;;
      --add-dirs-ro)
        [[ $# -ge 2 ]] || { echo "Missing value for $1" >&2; exit 1; }
        if [[ -n "$add_dirs_ro_list_cli" ]]; then
          add_dirs_ro_list_cli+=":${2}"
        else
          add_dirs_ro_list_cli="$2"
        fi
        shift 2
        ;;
      --add-dirs-ro=*)
        if [[ -n "$add_dirs_ro_list_cli" ]]; then
          add_dirs_ro_list_cli+=":${1#*=}"
        else
          add_dirs_ro_list_cli="${1#*=}"
        fi
        shift
        ;;
      --add-dirs)
        [[ $# -ge 2 ]] || { echo "Missing value for $1" >&2; exit 1; }
        if [[ -n "$add_dirs_list_cli" ]]; then
          add_dirs_list_cli+=":${2}"
        else
          add_dirs_list_cli="$2"
        fi
        shift 2
        ;;
      --add-dirs=*)
        if [[ -n "$add_dirs_list_cli" ]]; then
          add_dirs_list_cli+=":${1#*=}"
        else
          add_dirs_list_cli="${1#*=}"
        fi
        shift
        ;;
      --workdir)
        [[ $# -ge 2 ]] || { echo "Missing value for $1" >&2; exit 1; }
        workdir_value="$2"
        workdir_flag_set=1
        shift 2
        ;;
      --workdir=*)
        workdir_value="${1#*=}"
        workdir_flag_set=1
        shift
        ;;
      --append-profile)
        [[ $# -ge 2 ]] || { echo "Missing value for $1" >&2; exit 1; }
        append_profile_paths+=("$2")
        shift 2
        ;;
      --append-profile=*)
        append_profile_paths+=("${1#*=}")
        shift
        ;;
      --output)
        [[ $# -ge 2 ]] || { echo "Missing value for $1" >&2; exit 1; }
        output_path="$2"
        shift 2
        ;;
      --output=*)
        output_path="${1#*=}"
        shift
        ;;
      -h|--help)
        usage
        exit 0
        ;;
      *)
        echo "Unknown option: $1" >&2
        usage >&2
        exit 1
        ;;
    esac
  done

  if [[ -z "$home_dir" ]]; then
    echo "HOME is not set; set HOME in the environment before running this script." >&2
    exit 1
  fi

  if [[ ! -d "$home_dir" ]]; then
    echo "HOME does not exist or is not a directory: $home_dir" >&2
    exit 1
  fi

  home_dir="$(normalize_abs_path "$home_dir")"

  if [[ -n "$output_path" ]]; then
    output_path="$(expand_tilde "$output_path")"
  fi

  if [[ ! -d "$invocation_cwd" ]]; then
    echo "Invocation CWD does not exist or is not a directory: $invocation_cwd" >&2
    exit 1
  fi

  if [[ "${#append_profile_paths[@]}" -gt 0 ]]; then
    local raw_profile_path expanded_profile_path resolved_profile_path
    local -a normalized_append_profile_paths=()

    for raw_profile_path in "${append_profile_paths[@]}"; do
      if [[ -z "$raw_profile_path" ]]; then
        echo "Appended profile path cannot be empty." >&2
        exit 1
      fi
      expanded_profile_path="$(expand_tilde "$raw_profile_path")"
      if [[ ! -e "$expanded_profile_path" ]]; then
        echo "Appended profile path does not exist: ${raw_profile_path}" >&2
        exit 1
      fi
      if [[ ! -f "$expanded_profile_path" ]]; then
        echo "Appended profile path is not a regular file: ${raw_profile_path}" >&2
        exit 1
      fi
      if [[ ! -r "$expanded_profile_path" ]]; then
        echo "Appended profile file is not readable: ${raw_profile_path}" >&2
        exit 1
      fi

      resolved_profile_path="$(normalize_abs_path "$expanded_profile_path")"
      normalized_append_profile_paths+=("$resolved_profile_path")
    done

    append_profile_paths=("${normalized_append_profile_paths[@]}")
  fi

  if [[ "$workdir_flag_set" -eq 1 ]]; then
    if [[ -n "$workdir_value" ]]; then
      local resolved_workdir_value
      resolved_workdir_value="$(expand_tilde "$workdir_value")"
      if [[ ! -d "$resolved_workdir_value" ]]; then
        echo "Workdir does not exist or is not a directory: $workdir_value" >&2
        exit 1
      fi
      effective_workdir="$(normalize_abs_path "$resolved_workdir_value")"
    else
      effective_workdir=""
    fi
  elif [[ "$workdir_env_set" -eq 1 ]]; then
    if [[ -n "$workdir_env_value" ]]; then
      local resolved_workdir_env_value
      resolved_workdir_env_value="$(expand_tilde "$workdir_env_value")"
      if [[ ! -d "$resolved_workdir_env_value" ]]; then
        echo "Workdir from SAFEHOUSE_WORKDIR does not exist or is not a directory: $workdir_env_value" >&2
        exit 1
      fi
      effective_workdir="$(normalize_abs_path "$resolved_workdir_env_value")"
    else
      effective_workdir=""
    fi
  else
    effective_workdir="$(resolve_default_workdir "$invocation_cwd")"
  fi

  parse_enabled_features "$enable_csv_list"

  if [[ -n "$effective_workdir" ]]; then
    workdir_config_path="${effective_workdir%/}/${workdir_config_filename}"
    if [[ -e "$workdir_config_path" && ! -f "$workdir_config_path" ]]; then
      echo "Workdir config path exists but is not a regular file: $workdir_config_path" >&2
      exit 1
    fi
    if [[ -f "$workdir_config_path" && ! -r "$workdir_config_path" ]]; then
      echo "Workdir config file is not readable: $workdir_config_path" >&2
      exit 1
    fi
    load_workdir_config "$workdir_config_path"
  fi

  combined_add_dirs_ro_list="$(append_colon_list "$combined_add_dirs_ro_list" "$config_add_dirs_ro_list")"
  combined_add_dirs_ro_list="$(append_colon_list "$combined_add_dirs_ro_list" "$env_add_dirs_ro_list")"
  combined_add_dirs_ro_list="$(append_colon_list "$combined_add_dirs_ro_list" "$add_dirs_ro_list_cli")"

  combined_add_dirs_list="$(append_colon_list "$combined_add_dirs_list" "$config_add_dirs_list")"
  combined_add_dirs_list="$(append_colon_list "$combined_add_dirs_list" "$env_add_dirs_list")"
  combined_add_dirs_list="$(append_colon_list "$combined_add_dirs_list" "$add_dirs_list_cli")"

  if [[ -n "$combined_add_dirs_ro_list" ]]; then
    append_colon_paths "$combined_add_dirs_ro_list" "readonly"
  fi

  if [[ -n "$combined_add_dirs_list" ]]; then
    append_colon_paths "$combined_add_dirs_list" "rw"
  fi

  build_profile
}

usage() {
  cat <<USAGE
Usage:
  $(basename "$0") [policy options]
  $(basename "$0") [policy options] [--] <command> [args...]

Summary:
  Agent Safehouse is a macOS sandbox toolkit for coding agents and CLIs.
  It composes a deny-by-default sandbox-exec policy with scoped allows.

How to use this CLI:
  1) Policy mode (no command):
     Generates a policy file and prints the filename.
     Use --stdout to print the policy text instead.
     You can pass that file to your own sandbox-exec invocation.
  2) Execute mode (command provided):
     Generates a policy and runs the command inside that policy.

Common examples:
  # Generate policy file path
  $(basename "$0")

  # Print policy text to stdout
  $(basename "$0") --stdout

  # Generate policy path and run your own sandbox-exec command
  sandbox-exec -f "\$($(basename "$0"))" -- /usr/bin/true

  # Run a command under Safehouse policy
  $(basename "$0") -- claude --dangerously-skip-permissions
  $(basename "$0") --enable=docker -- docker ps

Policy scope options:
  --enable FEATURES
  --enable=FEATURES
      Comma-separated optional features to enable
      Supported values: ${supported_enable_features}
      Note: electron implies macos-gui
      Note: all-agents restores legacy behavior by loading every 60-agents and 65-apps profile
      Note: wide-read grants read-only visibility across / (broad; use cautiously)

  --add-dirs-ro PATHS
  --add-dirs-ro=PATHS
      Colon-separated paths to grant read-only access

  --add-dirs PATHS
  --add-dirs=PATHS
      Colon-separated paths to grant read/write access

  --workdir DIR
  --workdir=DIR
      Main directory to grant read/write access
      Empty string disables automatic workdir grants

  --append-profile PATH
  --append-profile=PATH
      Append an additional sandbox profile file after generated rules
      Repeatable; files are appended in argument order

  --output PATH
  --output=PATH
      Write policy to a specific file path

Output options:
  --stdout
      Print policy text to stdout (do not execute command)

General:
  -h, --help
      Show this help

Environment:
  SAFEHOUSE_ADD_DIRS_RO
      Colon-separated read-only paths (same format as --add-dirs-ro)

  SAFEHOUSE_ADD_DIRS
      Colon-separated read/write paths (same format as --add-dirs)

  SAFEHOUSE_WORKDIR
      Workdir override (same behavior as --workdir, including empty string)

Config file:
  <workdir>/.safehouse (optional, auto-loaded if present)
      Supports keys:
        add-dirs-ro=PATHS
        add-dirs=PATHS
USAGE
}

policy_args_include_output() {
  local arg
  for arg in "$@"; do
    case "$arg" in
      --output|--output=*)
        return 0
        ;;
    esac
  done
  return 1
}

main() {
  local -a policy_args=()
  local -a command_args=()
  local policy_path=""
  local keep_policy_file=0
  local detected_app_bundle=""
  local status=0

  while [[ $# -gt 0 ]]; do
    case "$1" in
      -h|--help)
        usage
        exit 0
        ;;
      --stdout)
        stdout_policy=1
        shift
        ;;
      --)
        shift
        command_args=("$@")
        break
        ;;
      --enable|--add-dirs-ro|--add-dirs|--workdir|--append-profile|--output)
        [[ $# -ge 2 ]] || { echo "Missing value for $1" >&2; exit 1; }
        policy_args+=("$1" "$2")
        shift 2
        ;;
      --enable=*|--add-dirs-ro=*|--add-dirs=*|--workdir=*|--append-profile=*|--output=*)
        policy_args+=("$1")
        shift
        ;;
      --*)
        echo "Unknown option: $1" >&2
        echo "If this is a command argument, pass it after --" >&2
        exit 1
        ;;
      *)
        command_args=("$@")
        break
        ;;
    esac
  done

  if [[ "$stdout_policy" -eq 0 && "${#command_args[@]}" -gt 0 ]]; then
    preflight_runtime
  fi

  # Auto-detect .app bundle from the command and grant read-only access to the bundle.
  if [[ "${#command_args[@]}" -gt 0 ]]; then
    detected_app_bundle="$(detect_app_bundle "${command_args[0]}")" || true
    if [[ -n "${detected_app_bundle:-}" ]]; then
      policy_args+=("--add-dirs-ro=${detected_app_bundle}")
    fi
  fi

  invoked_command_path=""
  invoked_command_basename=""
  invoked_command_app_bundle=""
  selected_agent_profile_basenames=()
  selected_agent_profiles_resolved=0
  if [[ "${#command_args[@]}" -gt 0 ]]; then
    invoked_command_path="${command_args[0]}"
    invoked_command_basename="$(basename "${command_args[0]}")"
    invoked_command_app_bundle="${detected_app_bundle:-}"
  fi

  if [[ "${#policy_args[@]}" -gt 0 ]]; then
    policy_path="$(generate_policy_file "${policy_args[@]}")"
  else
    policy_path="$(generate_policy_file)"
  fi
  if [[ ! -f "$policy_path" ]]; then
    echo "Generator returned non-existent policy file: ${policy_path}" >&2
    exit 1
  fi

  if [[ "${#policy_args[@]}" -gt 0 ]] && policy_args_include_output "${policy_args[@]}"; then
    keep_policy_file=1
  fi

  if [[ "$stdout_policy" -eq 1 ]]; then
    cat "$policy_path"
    if [[ "$keep_policy_file" -ne 1 ]]; then
      rm -f "$policy_path"
    fi
    exit 0
  fi

  if [[ "${#command_args[@]}" -eq 0 ]]; then
    printf '%s\n' "$policy_path"
    exit 0
  fi

  set +e
  sandbox-exec -f "$policy_path" -- "${command_args[@]}"
  status=$?
  set -e

  if [[ "$keep_policy_file" -ne 1 ]]; then
    rm -f "$policy_path"
  fi

  exit "$status"
}

profile_key_from_source() {
  local source="$1"

  if [[ "$source" == profiles/* ]]; then
    printf '%s\n' "$source"
    return
  fi

  if [[ -n "${PROFILES_DIR:-}" && "$source" == "${PROFILES_DIR}/"* ]]; then
    printf 'profiles/%s\n' "${source#"${PROFILES_DIR}/"}"
    return
  fi

  printf '%s\n' "$source"
}

profile_declares_requirement() {
  local profile_path="$1"
  local required_integration="$2"
  local required_normalized line raw_requirements entry normalized_entry profile_key
  local -a requirement_entries=()

  required_normalized="$(to_lowercase "$required_integration")"
  profile_key="$(profile_key_from_source "$profile_path")"

  if embedded_profile_body "$profile_key" >/dev/null 2>&1; then
    while IFS= read -r line; do
      [[ "$line" == *'$$require='*'$$'* ]] || continue
      raw_requirements="${line#*\$\$require=}"
      raw_requirements="${raw_requirements%%\$\$*}"
      raw_requirements="$(trim_whitespace "$raw_requirements")"
      [[ -n "$raw_requirements" ]] || continue

      IFS=',' read -r -a requirement_entries <<< "$raw_requirements"
      for entry in "${requirement_entries[@]}"; do
        normalized_entry="$(to_lowercase "$(trim_whitespace "$entry")")"
        [[ -n "$normalized_entry" ]] || continue
        if [[ "$normalized_entry" == "$required_normalized" ]]; then
          return 0
        fi
      done
    done < <(embedded_profile_body "$profile_key")
    return 1
  fi

  if [[ ! -f "$profile_path" ]]; then
    return 1
  fi

  while IFS= read -r line; do
    [[ "$line" == *'$$require='*'$$'* ]] || continue
    raw_requirements="${line#*\$\$require=}"
    raw_requirements="${raw_requirements%%\$\$*}"
    raw_requirements="$(trim_whitespace "$raw_requirements")"
    [[ -n "$raw_requirements" ]] || continue

    IFS=',' read -r -a requirement_entries <<< "$raw_requirements"
    for entry in "${requirement_entries[@]}"; do
      normalized_entry="$(to_lowercase "$(trim_whitespace "$entry")")"
      [[ -n "$normalized_entry" ]] || continue
      if [[ "$normalized_entry" == "$required_normalized" ]]; then
        return 0
      fi
    done
  done < "$profile_path"

  return 1
}

selected_profiles_require_integration() {
  local integration="$1"
  local integration_normalized selected_profile profile_path profile_key
  local keychain_requirement_normalized
  local requires_integration=0

  integration_normalized="$(to_lowercase "$integration")"
  keychain_requirement_normalized="$(to_lowercase "$keychain_requirement_token")"

  if [[ "$integration_normalized" == "$keychain_requirement_normalized" && "$selected_profiles_require_keychain_resolved" -eq 1 ]]; then
    [[ "$selected_profiles_require_keychain" -eq 1 ]]
    return
  fi

  if [[ "$enable_all_agents_profiles" -eq 1 ]]; then
    for profile_key in "${PROFILE_KEYS[@]}"; do
      case "$profile_key" in
        profiles/60-agents/*.sb|profiles/65-apps/*.sb)
          if profile_declares_requirement "$profile_key" "$integration_normalized"; then
            requires_integration=1
            break
          fi
          ;;
      esac
    done
  else
    resolve_selected_agent_profiles
    for selected_profile in "${selected_agent_profile_basenames[@]-}"; do
      profile_path="${PROFILES_DIR}/60-agents/${selected_profile}"
      if profile_declares_requirement "$profile_path" "$integration_normalized"; then
        requires_integration=1
        break
      fi

      profile_path="${PROFILES_DIR}/65-apps/${selected_profile}"
      if profile_declares_requirement "$profile_path" "$integration_normalized"; then
        requires_integration=1
        break
      fi
    done
  fi

  if [[ "$integration_normalized" == "$keychain_requirement_normalized" ]]; then
    selected_profiles_require_keychain="$requires_integration"
    selected_profiles_require_keychain_resolved=1
  fi

  [[ "$requires_integration" -eq 1 ]]
}

append_profile() {
  local target="$1"
  local source="$2"
  local key

  key="$(profile_key_from_source "$source")"
  if embedded_profile_body "$key" >> "$target"; then
    echo "" >> "$target"
    return
  fi

  # Fallback: read from disk (needed for --append-profile with external files).
  if [[ -f "$source" ]]; then
    cat "$source" >> "$target"
    echo "" >> "$target"
    return
  fi

  echo "Missing profile module: ${source}" >&2
  exit 1
}

append_resolved_base_profile() {
  local target="$1"
  local source="$2"
  local escaped_home key

  escaped_home="$(escape_for_sb "$home_dir")"
  key="$(profile_key_from_source "$source")"

  if ! embedded_profile_body "$key" | awk -v home="$escaped_home" -v token="$HOME_DIR_TEMPLATE_TOKEN" '
    BEGIN { replaced = 0 }
    {
      line = $0
      count = gsub(token, home, line)
      if (count > 0) {
        replaced = 1
      }
      print line
    }
    END {
      if (replaced == 0) {
        exit 64
      }
    }
  ' >> "$target"; then
    echo "Failed to resolve HOME_DIR placeholder in base profile: ${source}" >&2
    echo "Expected HOME_DIR placeholder token: ${HOME_DIR_TEMPLATE_TOKEN}" >&2
    exit 1
  fi

  echo "" >> "$target"
}

append_all_module_profiles() {
  local target="$1"
  local base_dir="$2"
  local found_any=0
  local appended_any=0
  local is_scoped_profile_dir=0
  local emit_no_match_note=0
  local key profile_prefix

  case "$base_dir" in
    "${PROFILES_DIR}/30-toolchains"|"profiles/30-toolchains")
      profile_prefix="profiles/30-toolchains/"
      ;;
    "${PROFILES_DIR}/40-shared"|"profiles/40-shared")
      profile_prefix="profiles/40-shared/"
      ;;
    "${PROFILES_DIR}/50-integrations-core"|"profiles/50-integrations-core")
      profile_prefix="profiles/50-integrations-core/"
      ;;
    "${PROFILES_DIR}/60-agents"|"profiles/60-agents")
      profile_prefix="profiles/60-agents/"
      is_scoped_profile_dir=1
      emit_no_match_note=1
      ;;
    "${PROFILES_DIR}/65-apps"|"profiles/65-apps")
      profile_prefix="profiles/65-apps/"
      is_scoped_profile_dir=1
      ;;
    *)
      echo "No module profiles found in: ${base_dir}" >&2
      exit 1
      ;;
  esac

  for key in "${PROFILE_KEYS[@]}"; do
    [[ "$key" == "${profile_prefix}"* ]] || continue
    found_any=1

    if [[ "$is_scoped_profile_dir" -eq 1 ]] && ! should_include_agent_profile_file "$key"; then
      continue
    fi
    appended_any=1
    append_profile "$target" "$key"
  done

  if [[ "$found_any" -eq 0 ]]; then
    echo "No module profiles found in: ${base_dir}" >&2
    exit 1
  fi

  if [[ "$is_scoped_profile_dir" -eq 1 ]]; then
    if [[ "$enable_all_agents_profiles" -eq 1 ]]; then
      return 0
    fi

    if [[ "$appended_any" -eq 0 && "$emit_no_match_note" -eq 1 ]]; then
      resolve_selected_agent_profiles
      if [[ "${#selected_agent_profile_basenames[@]}" -eq 0 ]]; then
        {
          echo ";; No command-matched app/agent profile selected; skipping 60-agents and 65-apps modules."
          echo ";; Use --enable=all-agents to restore legacy all-profile behavior."
          echo ""
        } >> "$target"
      fi
    fi
    return 0
  fi

  if [[ "$appended_any" -eq 0 ]]; then
    echo "No module profiles selected in: ${base_dir}" >&2
    exit 1
  fi
}

append_optional_integration_profiles() {
  local target="$1"
  local base_dir="$2"
  local key base_name
  local found_any=0

  case "$base_dir" in
    "${PROFILES_DIR}/55-integrations-optional"|"profiles/55-integrations-optional")
      ;;
    *)
      echo "No optional integration profiles found in: ${base_dir}" >&2
      exit 1
      ;;
  esac

  for key in "${PROFILE_KEYS[@]}"; do
    [[ "$key" == "profiles/55-integrations-optional/"* ]] || continue
    found_any=1

    base_name="$(basename "$key")"
    should_include_optional_integration_profile "$base_name" || continue

    append_profile "$target" "$key"
  done

  if [[ "$found_any" -eq 0 ]]; then
    echo "No optional integration profiles found in: ${base_dir}" >&2
    exit 1
  fi
}

main "$@"
