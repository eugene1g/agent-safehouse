<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Policy Builder ¬∑ Agent Safehouse</title>
  <meta name="description" content="Build a custom Agent Safehouse sandbox policy from repo profile modules.">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0e1a;
      --surface: #111827;
      --surface-2: #1a2235;
      --border: #1e2a3a;
      --border-2: #2a3a50;
      --text: #dfe5ef;
      --text-bright: #f0f3f9;
      --text-muted: #8494ad;
      --amber: #d4a017;
      --amber-bright: #f5c842;
      --green: #4ade80;
      --red: #ef5350;
      --mono: 'JetBrains Mono', Menlo, monospace;
      --body: 'DM Sans', system-ui, sans-serif;
      --display: 'DM Serif Display', Georgia, serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--body);
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    a {
      color: var(--amber);
      text-decoration: none;
    }

    a:hover { color: var(--amber-bright); }

    .container {
      max-width: 1120px;
      margin: 0 auto;
      padding: 0 24px;
    }

    nav {
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(10, 14, 26, 0.9);
      backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--border);
    }

    nav .container {
      height: 58px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .logo {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      color: var(--text-bright);
      font-family: var(--mono);
      font-size: 0.875rem;
      font-weight: 600;
    }

    .logo img { width: 20px; height: 20px; }

    .links {
      display: inline-flex;
      gap: 8px;
    }

    .links a {
      font-size: 0.8rem;
      color: var(--text-muted);
      padding: 6px 10px;
      border-radius: 6px;
    }

    .links a:hover {
      color: var(--text-bright);
      background: var(--surface);
    }

    .links a.active {
      color: var(--amber);
      background: rgba(212, 160, 23, 0.08);
      border: 1px solid rgba(212, 160, 23, 0.22);
    }

    main {
      padding: 44px 0 72px;
    }

    .eyebrow {
      font-family: var(--mono);
      font-size: 0.625rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: #a67c00;
      font-weight: 700;
      margin-bottom: 8px;
    }

    h1 {
      font-family: var(--display);
      font-size: 2.58rem;
      font-weight: 400;
      color: var(--text-bright);
      line-height: 1.1;
      margin-bottom: 10px;
    }

    .intro {
      max-width: 920px;
      color: var(--text-muted);
      font-size: 0.96rem;
      line-height: 1.7;
      margin-bottom: 22px;
    }

    .intro code,
    .hint code,
    .notes code {
      font-family: var(--mono);
      font-size: 0.75rem;
      color: var(--amber);
      background: rgba(212, 160, 23, 0.09);
      border: 1px solid rgba(212, 160, 23, 0.18);
      border-radius: 4px;
      padding: 1px 6px;
    }

    .flow {
      display: grid;
      gap: 12px;
    }

    .step {
      position: relative;
      margin-left: 28px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px 16px 14px;
    }

    .step-number {
      position: absolute;
      left: -32px;
      top: 14px;
      width: 56px;
      height: 56px;
      border-radius: 16px;
      border: 1px solid rgba(212, 160, 23, 0.38);
      background: linear-gradient(135deg, rgba(212, 160, 23, 0.28), rgba(212, 160, 23, 0.08));
      color: var(--amber-bright);
      font-family: var(--mono);
      font-size: 1.5rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 24px rgba(212, 160, 23, 0.18);
      pointer-events: none;
      user-select: none;
    }

    .step h2 {
      font-size: 1.42rem;
      color: var(--text-bright);
      font-weight: 700;
      line-height: 1.2;
      margin-bottom: 4px;
      letter-spacing: -0.2px;
    }

    .hint {
      font-size: 0.84rem;
      color: var(--text-muted);
      margin-bottom: 10px;
      line-height: 1.65;
    }

    .bulk {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .bulk button {
      background: var(--bg);
      border: 1px solid var(--border-2);
      color: var(--text);
      font-family: var(--mono);
      font-size: 0.68rem;
      padding: 6px 9px;
      border-radius: 6px;
      cursor: pointer;
    }

    .bulk button:hover {
      border-color: #a67c00;
      color: var(--amber);
    }

    .hidden {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    /* 1) agents grid */
    .agent-grid {
      display: grid;
      grid-template-columns: repeat(7, 72px);
      justify-content: space-between;
      gap: 18px 0;
    }

    .agent {
      width: 72px;
      display: block;
      cursor: pointer;
    }

    .agent-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      position: relative;
      transition: transform 0.16s;
    }

    .agent:hover .agent-box { transform: translateY(-2px); }

    .avatar-wrap {
      position: relative;
      width: 72px;
      height: 72px;
      border-radius: 16px;
      border: 1px solid transparent;
      background: var(--surface-2);
      overflow: hidden;
      transition: all 0.16s;
    }

    .avatar {
      width: 72px;
      height: 72px;
      display: block;
      object-fit: cover;
      border-radius: 16px;
      background: var(--surface-2);
    }

    .agent-name {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-align: center;
      line-height: 1.35;
    }

    .check {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.72rem;
      font-weight: 700;
      color: transparent;
      background: rgba(10, 14, 26, 0.88);
      border: 1px solid var(--border-2);
      transition: all 0.16s;
    }

    .agent .hidden:checked + .agent-box .avatar-wrap {
      border-color: var(--amber);
      box-shadow: 0 0 0 2px rgba(212, 160, 23, 0.15);
    }

    .agent .hidden:checked + .agent-box .agent-name {
      color: var(--text-bright);
    }

    .agent .hidden:checked + .agent-box .check {
      color: #0a0e1a;
      background: var(--amber);
      border-color: var(--amber);
    }

    /* shared selectable cards */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
    }

    .apps {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 10px;
    }

    .card {
      display: block;
      position: relative;
      cursor: pointer;
    }

    .card-box {
      display: grid;
      grid-template-columns: 30px 1fr;
      gap: 8px;
      align-items: center;
      min-height: 62px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 9px;
      transition: 0.16s;
    }

    .card:hover .card-box {
      border-color: var(--border-2);
      transform: translateY(-1px);
    }

    .icon {
      width: 30px;
      height: 30px;
      border-radius: 7px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.86rem;
      font-weight: 700;
      color: var(--amber);
      font-family: var(--mono);
      overflow: hidden;
      background: transparent;
      border: none;
    }

    .icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: transparent;
    }

    .label {
      display: block;
      font-size: 0.84rem;
      font-weight: 600;
      color: var(--text-bright);
      line-height: 1.3;
      margin-bottom: 0;
    }

    .meta {
      display: block;
      font-size: 0.69rem;
      color: var(--text-muted);
      line-height: 1.35;
      margin-top: 1px;
    }

    .card .hidden:checked + .card-box {
      border-color: var(--amber);
      box-shadow: 0 0 0 2px rgba(212, 160, 23, 0.13);
      background: var(--surface-2);
    }

    .card .hidden:disabled + .card-box {
      opacity: 0.88;
      cursor: default;
    }

    .group-title {
      margin-top: 4px;
      margin-bottom: 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
      font-weight: 600;
      letter-spacing: 0.2px;
      line-height: 1.5;
    }

    .fields {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field.full { grid-column: 1 / -1; }

    .field label {
      font-family: var(--mono);
      font-size: 0.62rem;
      letter-spacing: 1.2px;
      text-transform: uppercase;
      color: var(--text-muted);
      font-weight: 700;
    }

    .field input,
    .field textarea {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border-2);
      border-radius: 8px;
      color: var(--text-bright);
      font-family: var(--mono);
      font-size: 0.78rem;
      padding: 10px 12px;
      line-height: 1.5;
    }

    .field textarea {
      min-height: 92px;
      resize: vertical;
    }

    .field input:focus,
    .field textarea:focus {
      outline: none;
      border-color: #a67c00;
      box-shadow: 0 0 0 2px rgba(212, 160, 23, 0.12);
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 11px 18px;
      border-radius: 8px;
      font-size: 0.84rem;
      font-weight: 600;
      border: 1px solid transparent;
      cursor: pointer;
      transition: 0.16s;
    }

    .btn.primary {
      background: var(--amber);
      color: #0a0e1a;
    }

    .btn.primary:hover {
      background: var(--amber-bright);
      transform: translateY(-1px);
    }

    .btn.secondary {
      background: var(--bg);
      color: var(--text);
      border-color: var(--border-2);
    }

    .btn.secondary:hover {
      border-color: #a67c00;
      color: var(--text-bright);
    }

    .btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      transform: none;
    }

    .notes {
      margin: 12px 0 0 18px;
      display: grid;
      gap: 4px;
      color: var(--text-muted);
      font-size: 0.81rem;
    }

    .status {
      margin-top: 10px;
      min-height: 1.2rem;
      font-size: 0.81rem;
      color: var(--text-muted);
    }

    .status.success { color: var(--green); }
    .status.error { color: var(--red); }

    .module-count {
      margin-top: 6px;
      font-size: 0.74rem;
      color: var(--text-muted);
      font-family: var(--mono);
    }

    .out-title {
      margin: 16px 0 8px;
      color: var(--text-bright);
      font-size: 0.93rem;
      font-weight: 600;
    }

    pre {
      margin: 0;
      background: #0d1120;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 15px;
      max-height: 350px;
      overflow: auto;
      font-family: var(--mono);
      font-size: 0.74rem;
      line-height: 1.65;
    }

    footer {
      border-top: 1px solid var(--border);
      padding: 26px 0 32px;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.78rem;
    }

    @media (max-width: 1024px) {
      .agent-grid {
        grid-template-columns: repeat(6, 72px);
        justify-content: space-around;
      }
    }

    @media (max-width: 920px) {
      .fields { grid-template-columns: 1fr; }
      .grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
    }

    @media (max-width: 760px) {
      h1 { font-size: 2rem; }

      .step {
        margin-left: 0;
        padding-top: 18px;
      }

      .step-number {
        position: static;
        margin-bottom: 10px;
      }

      .step h2 { font-size: 1.28rem; }

      .agent-grid {
        grid-template-columns: repeat(4, 72px);
        justify-content: space-between;
      }

      .actions {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }
    }

    @media (max-width: 520px) {
      .container { padding: 0 16px; }
      main { padding-top: 28px; }
      .step { padding: 14px; }
      .agent-grid {
        grid-template-columns: repeat(3, 72px);
        justify-content: space-around;
      }
    }
  </style>
</head>
<body>
  <nav>
    <div class="container">
      <a href="index.html" class="logo"><img src="favicon.svg" alt="Agent Safehouse">Agent Safehouse</a>
      <div class="links">
        <a href="index.html">Home</a>
        <a href="policy-builder.html" class="active">Policy Builder</a>
        <a href="https://github.com/eugene1g/agent-safehouse">GitHub</a>
      </div>
    </div>
  </nav>

  <main>
    <div class="container">
      <div class="eyebrow">Interactive wizard</div>
      <h1>Build your own Safehouse policy</h1>
      <p class="intro">
        This page assembles policies from real <code>profiles/*.sb</code> modules in Safehouse‚Äôs generation order. Choose your
        agents, stack, integrations, and filesystem grants, then export a ready-to-run <code>.sb</code> file.
        <a href="https://github.com/eugene1g/agent-safehouse/tree/main/profiles" target="_blank" rel="noopener noreferrer">View policy modules on GitHub</a>.
      </p>

      <div class="flow">
        <section class="step">
          <span class="step-number">1</span>
          <h2>Your Clankers</h2>
          <p class="hint">Same visual layout as the home page, but selectable.</p>
          <div class="bulk">
            <button id="agents-all" type="button">Select all</button>
            <button id="agents-none" type="button">Clear all</button>
          </div>
          <div id="agents-grid" class="agent-grid"></div>
        </section>

        <section class="step">
          <span class="step-number">2</span>
          <h2>Your coding stack</h2>
          <div class="bulk">
            <button id="toolchains-all" type="button">Select all</button>
            <button id="toolchains-none" type="button">Clear all</button>
          </div>
          <div id="toolchains-grid" class="grid"></div>
        </section>

        <section class="step">
          <span class="step-number">3</span>
          <h2>Things you want your agents to access</h2>

          <p class="group-title">Always-on core integrations</p>
          <div id="integrations-default-grid" class="grid"></div>

          <p class="group-title">Optional integrations</p>
          <div id="integrations-extra-grid" class="grid"></div>

          <p class="group-title" style="margin-top:12px">Desktop app profiles</p>
          <div id="apps-grid" class="apps"></div>
        </section>

        <section class="step">
          <span class="step-number">4</span>
          <h2>Your file system</h2>
          <p class="hint">Configure HOME, workdir, extra path grants, and optional appended overlay rules.</p>
          <div class="fields">
            <div class="field">
              <label for="home-dir">HOME_DIR value</label>
              <input id="home-dir" type="text" value="/Users/you">
            </div>
            <div class="field">
              <label for="workdir">Workdir (read/write; optional)</label>
              <input id="workdir" type="text" value="/Users/you/projects/my-app">
            </div>
            <div class="field full">
              <label for="add-ro">Extra read-only directories (one per line)</label>
              <textarea id="add-ro" placeholder="/Users/you/mywork&#10;/Users/you/docs"></textarea>
            </div>
            <div class="field full">
              <label for="add-rw">Extra read/write directories (one per line)</label>
              <textarea id="add-rw" placeholder="/Users/you/scratch"></textarea>
            </div>
            <div class="field full">
              <label for="append-profile">Appended profile text (optional, loaded last)</label>
              <textarea id="append-profile" placeholder=";; Example deny overlay&#10;(deny file-read* (home-subpath \"/.aws\"))"></textarea>
            </div>
          </div>
        </section>

        <section class="step">
          <span class="step-number">5</span>
          <h2>Get your policy document</h2>
          <p class="hint">Generate, inspect, copy, and download your <code>.sb</code> policy.</p>
          <div class="actions">
            <button id="generate" type="button" class="btn primary">Generate policy</button>
            <button id="copy" type="button" class="btn secondary" disabled>Copy policy</button>
            <button id="download" type="button" class="btn secondary" disabled>Download .sb</button>
            <button id="download-launchers" type="button" class="btn secondary" disabled>Download desktop launcher setup (.command)</button>
          </div>

          <ul class="notes">
            <li>Save the output as <code>my-safehouse.sb</code>.</li>
            <li>Run: <code>sandbox-exec -f my-safehouse.sb -- &lt;command&gt;</code>.</li>
            <li>macOS app shortcuts: run the downloaded launcher setup script with <code>bash /path/to/create-safehouse-desktop-launchers.command</code>.</li>
            <li>Compare with CLI output via <code>safehouse --stdout</code> if needed.</li>
          </ul>

          <p id="status" class="status">Ready. Select options and click ‚ÄúGenerate policy‚Äù.</p>
          <p id="module-count" class="module-count">Included modules: ‚Äî</p>

          <h3 class="out-title">Command helper snippet</h3>
          <pre><code id="command-output"># Choose options, then click "Generate policy".</code></pre>

          <h3 class="out-title">Generated policy preview</h3>
          <pre><code id="policy-output">;; Policy output will appear here.</code></pre>
        </section>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">Agent Safehouse ¬∑ Policy Builder</div>
  </footer>

  <script>
    (function () {
      var HOME_TOKEN = '__SAFEHOUSE_REPLACE_ME_WITH_ABSOLUTE_HOME_DIR__';
      var BASES = ['https://raw.githubusercontent.com/eugene1g/agent-safehouse/main', '..', '.'];

      var BASE_MODULES = ['profiles/00-base.sb', 'profiles/10-system-runtime.sb', 'profiles/20-network.sb'];
      var SHARED_MODULES = ['profiles/40-shared/agent-common.sb'];

      var AGENTS = [
        { key: 'claude-code', label: 'Claude Code', profile: 'claude-code.sb', command: 'claude --dangerously-skip-permissions', logo: 'https://github.com/anthropics.png?size=256', on: true },
        { key: 'codex', label: 'Codex', profile: 'codex.sb', command: 'codex --dangerously-bypass-approvals-and-sandbox', logo: 'https://github.com/openai.png?size=256', on: true },
        { key: 'opencode', label: 'OpenCode', profile: 'opencode.sb', command: 'OPENCODE_PERMISSION=\'{"*":"allow"}\' opencode', logo: 'https://github.com/opencode-ai.png?size=256', on: true },
        { key: 'amp', label: 'Amp', profile: 'amp.sb', command: 'amp --dangerously-allow-all', logo: 'https://github.com/ampcode-com.png?size=256' },
        { key: 'gemini', label: 'Gemini CLI', profile: 'gemini.sb', command: 'NO_BROWSER=true gemini --yolo', logo: 'https://geminicli.com/icon.png' },
        { key: 'aider', label: 'Aider', profile: 'aider.sb', command: 'aider', logo: 'https://github.com/Aider-AI.png?size=256' },
        { key: 'goose', label: 'Goose', profile: 'goose.sb', command: 'goose', logo: 'https://block.github.io/goose/img/logo_dark.png' },
        { key: 'auggie', label: 'Auggie', profile: 'auggie.sb', command: 'auggie', logo: 'https://www.augmentcode.com/favicon.svg' },
        { key: 'pi', label: 'Pi', profile: 'pi.sb', command: 'pi', logo: 'https://pi.dev/logo.svg' },
        { key: 'cursor-agent', label: 'Cursor Agent', profile: 'cursor-agent.sb', command: 'cursor-agent', logo: 'https://github.com/cursor.png?size=256' },
        { key: 'cline', label: 'Cline', profile: 'cline.sb', command: 'cline', logo: 'https://github.com/cline.png?size=256' },
        { key: 'kilo-code', label: 'Kilo Code', profile: 'kilo-code.sb', command: 'kilo', logo: 'https://raw.githubusercontent.com/Kilo-Org/kilocode/main/src/assets/icons/kilo-dark.png' },
        { key: 'droid', label: 'Droid', profile: 'droid.sb', command: 'droid', logo: 'https://github.com/Factory-AI.png?size=256' }
      ];

      var TOOLCHAINS = [
        { key: 'bun', label: 'Bun', profile: 'bun.sb', logo: 'https://bun.sh/logo.svg', on: true },
        { key: 'deno', label: 'Deno', profile: 'deno.sb', logo: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/denojs/denojs-original.svg', on: true },
        { key: 'go', label: 'Go', profile: 'go.sb', logo: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/go/go-original.svg', on: true },
        { key: 'java', label: 'Java', profile: 'java.sb', logo: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/java/java-original.svg', on: true },
        { key: 'node', label: 'Node.js', profile: 'node.sb', logo: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/nodejs/nodejs-original.svg', on: true },
        { key: 'perl', label: 'Perl', profile: 'perl.sb', logo: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/perl/perl-original.svg', on: false },
        { key: 'php', label: 'PHP', profile: 'php.sb', logo: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/php/php-original.svg', on: false },
        { key: 'python', label: 'Python', profile: 'python.sb', logo: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/python/python-original.svg', on: true },
        { key: 'ruby', label: 'Ruby', profile: 'ruby.sb', logo: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/ruby/ruby-original.svg', on: true },
        { key: 'runtime-managers', label: 'Runtime managers', profile: 'runtime-managers.sb', logo: 'https://github.com/asdf-vm.png?size=96', on: true },
        { key: 'rust', label: 'Rust', profile: 'rust.sb', logo: 'https://cdn.simpleicons.org/rust/F74C00', on: true }
      ];

      var INTEGRATIONS = [
        { key: 'git', label: 'Git', path: 'profiles/50-integrations-core/git.sb', group: 'default', logo: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/git/git-original.svg', on: true },
        { key: 'scm-clis', label: 'SCM CLIs', path: 'profiles/50-integrations-core/scm-clis.sb', group: 'default', logo: 'https://github.com/github.png?size=96', on: true },
        { key: '1password', label: '1Password', path: 'profiles/55-integrations-optional/1password.sb', group: 'extra', feature: '1password', logo: 'https://github.com/1Password.png?size=96', on: false },
        { key: 'browser-native-messaging', label: 'Browser native messaging', path: 'profiles/55-integrations-optional/browser-native-messaging.sb', group: 'extra', feature: 'browser-native-messaging', logo: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/chrome/chrome-original.svg', on: false },
        { key: 'cleanshot', label: 'CleanShot', path: 'profiles/55-integrations-optional/cleanshot.sb', group: 'extra', feature: 'cleanshot', glyph: 'üì∏', on: false },
        { key: 'cloud-credentials', label: 'Cloud credentials', path: 'profiles/55-integrations-optional/cloud-credentials.sb', group: 'extra', feature: 'cloud-credentials', logo: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/amazonwebservices/amazonwebservices-original-wordmark.svg', on: false },
        { key: 'docker', label: 'Docker', path: 'profiles/55-integrations-optional/docker.sb', group: 'extra', feature: 'docker', logo: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/docker/docker-original.svg', on: false },
        { key: 'electron', label: 'Electron', path: 'profiles/55-integrations-optional/electron.sb', group: 'extra', feature: 'electron', logo: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/electron/electron-original.svg', on: false },
        { key: 'keychain', label: 'Keychain', path: 'profiles/55-integrations-optional/keychain.sb', group: 'extra', glyph: 'üîê', on: false },
        { key: 'macos-gui', label: 'macOS GUI', path: 'profiles/55-integrations-optional/macos-gui.sb', group: 'extra', feature: 'macosGui', glyph: 'Ô£ø', on: false },
        { key: 'spotlight', label: 'Spotlight', path: 'profiles/55-integrations-optional/spotlight.sb', group: 'extra', feature: 'spotlight', glyph: 'üîé', on: false },
        { key: 'ssh', label: 'SSH', path: 'profiles/55-integrations-optional/ssh.sb', group: 'extra', feature: 'ssh', glyph: '>_', on: false },
        { key: 'wide-read', label: 'Wide read', group: 'extra', feature: 'wideRead', glyph: 'üëÅ', on: false }
      ];

      var APPS = [
        { key: 'claude-app', label: 'Claude.app', profile: 'claude-app.sb', logo: 'https://github.com/anthropics.png?size=96', desc: 'Desktop Claude bundle profile' },
        { key: 'vscode-app', label: 'Visual Studio Code.app', profile: 'vscode-app.sb', logo: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/vscode/vscode-original.svg', desc: 'Desktop VS Code bundle profile' }
      ];

      var ORD = {
        toolchains: TOOLCHAINS.map(function (x) { return x.profile; }).slice().sort(),
        agents: AGENTS.map(function (x) { return x.profile; }).slice().sort(),
        apps: APPS.map(function (x) { return x.profile; }).slice().sort()
      };

      var cache = {};
      var resolvedBase = null;
      var lastPolicy = '';

      var el = {
        agentsGrid: document.getElementById('agents-grid'),
        toolchainsGrid: document.getElementById('toolchains-grid'),
        integrationsDefaultGrid: document.getElementById('integrations-default-grid'),
        integrationsExtraGrid: document.getElementById('integrations-extra-grid'),
        appsGrid: document.getElementById('apps-grid'),

        home: document.getElementById('home-dir'),
        workdir: document.getElementById('workdir'),
        ro: document.getElementById('add-ro'),
        rw: document.getElementById('add-rw'),
        append: document.getElementById('append-profile'),

        status: document.getElementById('status'),
        moduleCount: document.getElementById('module-count'),
        command: document.getElementById('command-output'),
        policy: document.getElementById('policy-output'),

        gen: document.getElementById('generate'),
        copy: document.getElementById('copy'),
        dl: document.getElementById('download'),
        launchers: document.getElementById('download-launchers')
      };

      function setStatus(msg, cls) {
        el.status.textContent = msg || '';
        el.status.classList.remove('success', 'error');
        if (cls) el.status.classList.add(cls);
      }

      function uniq(arr) {
        var seen = {};
        var out = [];
        arr.forEach(function (v) {
          if (!seen[v]) {
            seen[v] = true;
            out.push(v);
          }
        });
        return out;
      }

      function esc(v) {
        return String(v || '').replace(/\\/g, '\\\\').replace(/"/g, '\\"');
      }

      function norm(raw, home) {
        var p = String(raw || '').trim();
        if (!p) return '';
        if (p === '~') p = home;
        else if (p.indexOf('~/') === 0) p = home + p.slice(1);
        p = p.replace(/\/{2,}/g, '/');
        if (p.length > 1 && p.slice(-1) === '/') p = p.slice(0, -1);
        return p;
      }

      function assertAbs(p, label) {
        if (p && p.charAt(0) !== '/') {
          throw new Error(label + ' must be absolute: ' + p);
        }
      }

      function parseList(raw, home, label) {
        var out = [];
        String(raw || '').split(/\r?\n/).forEach(function (line) {
          var t = line.trim();
          if (!t || t.indexOf('#') === 0 || t.indexOf(';') === 0) return;
          var p = norm(t, home);
          if (!p) return;
          assertAbs(p, label);
          out.push(p);
        });
        return uniq(out);
      }

      function emitAnc(path, label) {
        var l = [];
        l.push(';; Generated ancestor directory literals for ' + label + ': ' + path);
        l.push(';;');
        l.push(';; Why file-read* (not file-read-metadata) with literal (not subpath):');
        l.push(';; Agents (notably Claude Code) call readdir() on every ancestor of the working');
        l.push(';; directory during startup. If only file-read-metadata (stat) is granted, the');
        l.push(';; agent cannot list directory contents, which causes it to blank PATH and break.');
        l.push(';; Using literal (not subpath) keeps this safe: it grants read access to the');
        l.push(';; directory entry itself, but does NOT grant recursive read access below it.');
        l.push('(allow file-read*');
        l.push('    (literal "/")');

        var t = path.replace(/^\/+/, '');
        var cur = '';
        if (t) {
          t.split('/').forEach(function (part) {
            if (!part) return;
            cur += '/' + part;
            l.push('    (literal "' + esc(cur) + '")');
          });
        }

        l.push(')');
        l.push('');
        return l.join('\n');
      }

      function emitGrant(path, label, mode) {
        var l = [emitAnc(path, label)];
        if (mode === 'rw') l.push('(allow file-read* file-write* (subpath "' + esc(path) + '"))');
        else l.push('(allow file-read* (subpath "' + esc(path) + '"))');
        l.push('');
        return l.join('\n');
      }

      function emitIntPreamble(s) {
        var l = [];

        if (s.disabledDefaultIntegrationLabels.length) {
          l.push(';; Builder note: default-enabled integrations disabled by user: ' + s.disabledDefaultIntegrationLabels.join(', '));
          l.push('');
        }

        var offOpt = [];
        if (!s.docker) offOpt.push('docker');
        if (!s.macosGui) offOpt.push('macos-gui');
        if (!s.electron) offOpt.push('electron');
        if (!s.ssh) offOpt.push('ssh');
        if (!s.spotlight) offOpt.push('spotlight');
        if (!s.cleanshot) offOpt.push('cleanshot');
        if (!s.onepassword) offOpt.push('1password');
        if (!s.cloudCredentials) offOpt.push('cloud-credentials');
        if (!s.browserNativeMessaging) offOpt.push('browser-native-messaging');

        if (offOpt.length) {
          l.push(';; Optional integrations not enabled: ' + offOpt.join(' '));
          l.push(';; Note: electron implies macos-gui when enabled.');
          l.push('');
        }

        l.push(';; Threat-model note: blocking exfiltration/C2 is explicitly NOT a goal for this sandbox.');
        l.push('');
        return l.join('\n');
      }

      function buildUrl(base, p) {
        return String(base || '').replace(/\/+$/, '') + '/' + p;
      }

      async function getProfile(path) {
        if (cache[path]) return cache[path];

        var candidates = resolvedBase ? [resolvedBase] : BASES.slice();
        if (resolvedBase) {
          BASES.forEach(function (b) {
            if (b !== resolvedBase) candidates.push(b);
          });
        }

        var err = null;
        for (var i = 0; i < candidates.length; i += 1) {
          var url = buildUrl(candidates[i], path);
          try {
            var r = await fetch(url);
            if (!r.ok) throw new Error('HTTP ' + r.status + ' for ' + url);
            var t = await r.text();
            cache[path] = t;
            resolvedBase = candidates[i];
            return t;
          } catch (e) {
            err = e;
          }
        }

        throw new Error('Failed to fetch profile module: ' + path + (err ? ' (' + err.message + ')' : ''));
      }

      function selected(items, prefix) {
        return items.filter(function (x) {
          var i = document.getElementById(prefix + x.key);
          return i && i.checked;
        });
      }

      function ordered(prefix, list, order) {
        var s = {};
        list.forEach(function (p) { s[p] = 1; });
        var out = [];
        order.forEach(function (p) {
          if (s[p]) out.push(prefix + p);
        });
        return out;
      }

      function collect() {
        var home = norm(el.home.value, '/Users/you');
        if (!home) throw new Error('HOME_DIR value is required.');
        assertAbs(home, 'HOME_DIR value');

        var work = norm(el.workdir.value, home);
        if (work) assertAbs(work, 'Workdir');

        var selAgents = selected(AGENTS, 'agent-');
        var selTools = selected(TOOLCHAINS, 'toolchain-');
        var selApps = selected(APPS, 'app-');
        var selInts = selected(INTEGRATIONS, 'integration-');

        var byKey = {};
        selInts.forEach(function (i) { byKey[i.key] = true; });

        var electron = !!byKey['electron'];
        var macosGui = !!byKey['macos-gui'] || electron;
        var docker = !!byKey['docker'];
        var ssh = !!byKey['ssh'];
        var spotlight = !!byKey['spotlight'];
        var cleanshot = !!byKey['cleanshot'];
        var onepassword = !!byKey['1password'];
        var cloudCredentials = !!byKey['cloud-credentials'];
        var browserNativeMessaging = !!byKey['browser-native-messaging'];
        var keychain = !!byKey['keychain'];
        var wideRead = !!byKey['wide-read'];

        if (electron) {
          byKey['macos-gui'] = true;
        }

        var selectedIntegrationModulePaths = selInts
          .filter(function (i) { return i.path; })
          .map(function (i) { return i.path; });

        if (electron && selectedIntegrationModulePaths.indexOf('profiles/55-integrations-optional/macos-gui.sb') === -1) {
          selectedIntegrationModulePaths.push('profiles/55-integrations-optional/macos-gui.sb');
        }

        var disabledDefault = INTEGRATIONS
          .filter(function (i) { return i.group === 'default' && !byKey[i.key]; })
          .map(function (i) { return i.label; });

        return {
          home: home,
          work: work,
          ro: parseList(el.ro.value, home, 'Read-only path'),
          rw: parseList(el.rw.value, home, 'Read/write path'),
          append: String(el.append.value || '').trim(),

          agents: selAgents,
          tools: selTools,
          apps: selApps,

          agentProfiles: uniq(selAgents.map(function (a) { return a.profile; })),
          toolProfiles: uniq(selTools.map(function (t) { return t.profile; })),
          appProfiles: uniq(selApps.map(function (a) { return a.profile; })),

          selectedIntegrationModulePaths: uniq(selectedIntegrationModulePaths),
          disabledDefaultIntegrationLabels: disabledDefault,

          docker: docker,
          electron: electron,
          macosGui: macosGui,
          ssh: ssh,
          spotlight: spotlight,
          cleanshot: cleanshot,
          onepassword: onepassword,
          cloudCredentials: cloudCredentials,
          browserNativeMessaging: browserNativeMessaging,
          keychain: keychain,
          wideRead: wideRead
        };
      }

      function cmdSnippet(s) {
        var l = [];
        l.push('# Save generated policy to my-safehouse.sb');
        l.push('# Run selected agents under that policy:');

        if (s.agents.length) {
          s.agents.forEach(function (a) {
            l.push('sandbox-exec -f my-safehouse.sb -- ' + a.command);
          });
        } else {
          l.push('sandbox-exec -f my-safehouse.sb -- claude --dangerously-skip-permissions');
        }

        l.push('');
        l.push('# Closest safehouse CLI equivalent for grants/integrations:');

        var feats = [];
        if (s.docker) feats.push('docker');
        if (s.electron) feats.push('electron');
        if (!s.electron && s.macosGui) feats.push('macos-gui');
        if (s.ssh) feats.push('ssh');
        if (s.spotlight) feats.push('spotlight');
        if (s.cleanshot) feats.push('cleanshot');
        if (s.onepassword) feats.push('1password');
        if (s.cloudCredentials) feats.push('cloud-credentials');
        if (s.browserNativeMessaging) feats.push('browser-native-messaging');
        if (s.wideRead) feats.push('wide-read');

        var flags = [];
        if (feats.length) flags.push('--enable=' + feats.join(','));
        if (s.work) flags.push('--workdir="' + s.work.replace(/"/g, '\\"') + '"');
        if (s.ro.length) flags.push('--add-dirs-ro="' + s.ro.join(':').replace(/"/g, '\\"') + '"');
        if (s.rw.length) flags.push('--add-dirs="' + s.rw.join(':').replace(/"/g, '\\"') + '"');

        l.push('safehouse ' + (flags.length ? flags.join(' ') + ' ' : '') + '--stdout -- <agent-command>');
        l.push('# safehouse CLI auto-selects 60-agents/65-apps by command basename.');

        if (s.toolProfiles.length !== TOOLCHAINS.length) {
          l.push('# Note: wizard can narrow toolchains; CLI includes all toolchains by default.');
        }

        if (s.disabledDefaultIntegrationLabels.length) {
          l.push('# Note: disabled default integrations are specific to this static policy output.');
        }
        if (s.keychain) {
          l.push('# Note: keychain is selectable in the builder policy; safehouse CLI injects keychain automatically for keychain-dependent agent/app profiles.');
        }

        return l.join('\n');
      }

      async function buildPolicy(s) {
        var toolPaths = ordered('profiles/30-toolchains/', s.toolProfiles, ORD.toolchains);
        var agentPaths = ordered('profiles/60-agents/', s.agentProfiles, ORD.agents);
        var appPaths = ordered('profiles/65-apps/', s.appProfiles, ORD.apps);

        var integrationPaths = s.selectedIntegrationModulePaths.slice().sort();

        var fetches = uniq(
          BASE_MODULES
            .concat(toolPaths)
            .concat(SHARED_MODULES)
            .concat(integrationPaths)
            .concat(agentPaths)
            .concat(appPaths)
        );

        var texts = await Promise.all(fetches.map(getProfile));
        var by = {};
        fetches.forEach(function (p, i) { by[p] = texts[i]; });

        var parts = [];
        var included = [];

        function add(path, replaceHome) {
          var c = by[path];
          if (typeof c !== 'string') throw new Error('Missing loaded profile content: ' + path);
          if (replaceHome) c = c.split(HOME_TOKEN).join(esc(s.home));
          c = c.replace(/\n+$/, '');
          parts.push(c);
          parts.push('');
          included.push(path);
        }

        add(BASE_MODULES[0], true);
        add(BASE_MODULES[1], false);
        add(BASE_MODULES[2], false);

        if (toolPaths.length) toolPaths.forEach(function (p) { add(p, false); });
        else {
          parts.push(';; No toolchain modules selected in wizard (profiles/30-toolchains skipped).');
          parts.push('');
        }

        SHARED_MODULES.forEach(function (p) { add(p, false); });

        parts.push(emitIntPreamble(s));

        integrationPaths.forEach(function (p) { add(p, false); });

        if (!agentPaths.length && !appPaths.length) {
          parts.push(';; No command-matched app/agent profile selected; skipping 60-agents and 65-apps modules.');
          parts.push(';; Use --enable=all-agents in safehouse CLI to load all app/agent profiles.');
          parts.push('');
        } else {
          agentPaths.forEach(function (p) { add(p, false); });
          appPaths.forEach(function (p) { add(p, false); });
        }

        if (s.ro.length || s.rw.length) {
          parts.push(';; #safehouse-test-id:dynamic-cli-grants# Additional dynamic path grants from wizard input.');
          parts.push(';; Emission order: add-dirs-ro first, then add-dirs.');
          parts.push('');

          s.ro.forEach(function (p) {
            parts.push(emitGrant(p, 'extra read-only path', 'ro'));
          });

          s.rw.forEach(function (p) {
            parts.push(emitGrant(p, 'extra read/write path', 'rw'));
          });
        }

        if (s.wideRead) {
          parts.push(';; #safehouse-test-id:wide-read# Broad read-only visibility across the full filesystem.');
          parts.push(';; Added by --enable=wide-read. This emits a recursive read grant on /.');
          parts.push(';; WARNING: because this rule is emitted late, it can override earlier deny file-read* rules.');
          parts.push('(allow file-read* (subpath "/"))');
          parts.push('');
        }

        if (s.work) {
          parts.push(';; #safehouse-test-id:workdir-grant# Allow read/write access to the selected workdir.');
          parts.push(emitGrant(s.work, 'selected workdir', 'rw'));
        }

        if (s.append) {
          parts.push(';; #safehouse-test-id:append-profile# Appended policy from wizard overlay.');
          parts.push('');
          parts.push(s.append.replace(/\n+$/, ''));
          parts.push('');
        }

        var policy = parts.join('\n').replace(/\n{3,}/g, '\n\n').trim() + '\n';
        return { policy: policy, included: included };
      }

      function iconNode(item) {
        var i = document.createElement('span');
        i.className = 'icon';
        if (item.logo) {
          var img = document.createElement('img');
          img.src = item.logo;
          img.alt = item.label + ' icon';
          img.loading = 'lazy';
          i.appendChild(img);
        } else {
          i.textContent = item.glyph || item.label.charAt(0).toUpperCase();
        }
        return i;
      }

      function makeAgent(agent) {
        var label = document.createElement('label');
        label.className = 'agent';

        var input = document.createElement('input');
        input.type = 'checkbox';
        input.className = 'hidden';
        input.id = 'agent-' + agent.key;
        input.checked = !!agent.on;

        var box = document.createElement('span');
        box.className = 'agent-box';

        var wrap = document.createElement('span');
        wrap.className = 'avatar-wrap';

        var img = document.createElement('img');
        img.className = 'avatar';
        img.src = agent.logo;
        img.alt = agent.label + ' logo';
        img.loading = 'lazy';

        var chk = document.createElement('span');
        chk.className = 'check';
        chk.textContent = '‚úì';

        wrap.appendChild(img);
        wrap.appendChild(chk);

        var name = document.createElement('span');
        name.className = 'agent-name';
        name.textContent = agent.label;

        box.appendChild(wrap);
        box.appendChild(name);

        label.appendChild(input);
        label.appendChild(box);

        return label;
      }

      function makeCard(item, prefix, checked, disabled) {
        var label = document.createElement('label');
        label.className = 'card';

        var input = document.createElement('input');
        input.type = 'checkbox';
        input.className = 'hidden';
        input.id = prefix + item.key;
        input.checked = !!checked;
        if (disabled) input.disabled = true;

        var box = document.createElement('span');
        box.className = 'card-box';

        var body = document.createElement('span');

        var title = document.createElement('span');
        title.className = 'label';
        title.textContent = item.label;

        body.appendChild(title);

        if (item.desc) {
          var meta = document.createElement('span');
          meta.className = 'meta';
          meta.textContent = item.desc;
          body.appendChild(meta);
        }

        box.appendChild(iconNode(item));
        box.appendChild(body);

        label.appendChild(input);
        label.appendChild(box);

        return label;
      }

      function render() {
        AGENTS.forEach(function (a) {
          el.agentsGrid.appendChild(makeAgent(a));
        });

        TOOLCHAINS.forEach(function (t) {
          el.toolchainsGrid.appendChild(makeCard({
            key: t.key,
            label: t.label,
            logo: t.logo
          }, 'toolchain-', !!t.on, false));
        });

        INTEGRATIONS.forEach(function (i) {
          var targetGrid = i.group === 'default' ? el.integrationsDefaultGrid : el.integrationsExtraGrid;
          targetGrid.appendChild(makeCard(i, 'integration-', !!i.on, false));
        });

        APPS.forEach(function (a) {
          el.appsGrid.appendChild(makeCard({
            key: a.key,
            label: a.label,
            logo: a.logo,
            desc: a.desc
          }, 'app-', false, false));
        });
      }

      function setGroup(items, prefix, val) {
        items.forEach(function (x) {
          var i = document.getElementById(prefix + x.key);
          if (i && !i.disabled) i.checked = val;
        });
      }

      function syncElectron() {
        var e = document.getElementById('integration-electron');
        var m = document.getElementById('integration-macos-gui');
        if (!e || !m) return;
        if (e.checked) {
          m.checked = true;
          m.disabled = true;
        } else {
          m.disabled = false;
        }
      }

      async function generate() {
        syncElectron();

        var old = el.gen.textContent;
        el.gen.disabled = true;
        el.copy.disabled = true;
        el.dl.disabled = true;
        el.launchers.disabled = true;
        el.gen.textContent = 'Generating...';

        setStatus('Loading and composing profile modules...', null);

        try {
          var s = collect();
          var out = await buildPolicy(s);

          lastPolicy = out.policy;
          el.policy.textContent = out.policy;
          el.command.textContent = cmdSnippet(s);
          el.moduleCount.textContent = 'Included modules: ' + out.included.length;

          el.copy.disabled = false;
          el.dl.disabled = false;
          el.launchers.disabled = false;
          setStatus('Generated policy from ' + out.included.length + ' modules.', 'success');
        } catch (err) {
          console.error(err);
          setStatus(err && err.message ? err.message : String(err), 'error');
          el.moduleCount.textContent = 'Included modules: ‚Äî';
        } finally {
          el.gen.disabled = false;
          el.gen.textContent = old;
        }
      }

      function fallbackCopy(text) {
        var ta = document.createElement('textarea');
        ta.value = text;
        ta.setAttribute('readonly', '');
        ta.style.position = 'absolute';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
      }

      async function copyPolicy() {
        if (!lastPolicy) {
          setStatus('Generate a policy first.', 'error');
          return;
        }

        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(lastPolicy);
          } else {
            fallbackCopy(lastPolicy);
          }
          setStatus('Policy copied to clipboard.', 'success');
        } catch (_) {
          setStatus('Copy failed. Use Download instead.', 'error');
        }
      }

      function downloadTextFile(filename, text, mimeType) {
        var blob = new Blob([text], { type: mimeType || 'text/plain;charset=utf-8' });
        var url = URL.createObjectURL(blob);

        var a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function downloadPolicy() {
        if (!lastPolicy) {
          setStatus('Generate a policy first.', 'error');
          return;
        }

        downloadTextFile('safehouse.custom.generated.sb', lastPolicy, 'text/plain;charset=utf-8');
        setStatus('Downloaded safehouse.custom.generated.sb.', 'success');
      }

      function buildLauncherSetupScript(policyText) {
        var policyBody = String(policyText || '')
          .replace(/\r\n/g, '\n')
          .replace(/\r/g, '\n')
          .replace(/\n+$/, '');

        var marker = 'SAFEHOUSE_POLICY_' + Date.now().toString(36).toUpperCase();
        while (policyBody.indexOf(marker) !== -1) marker += '_X';

        var l = [];
        l.push('#!/usr/bin/env bash');
        l.push('set -euo pipefail');
        l.push('');
        l.push('output_dir="${SAFEHOUSE_LAUNCHER_OUTPUT_DIR:-$HOME/Desktop}"');
        l.push('');
        l.push('write_policy_file() {');
        l.push('  local target="$1"');
        l.push("  cat > \"$target\" <<'" + marker + "'");
        l.push(policyBody);
        l.push(marker);
        l.push('}');
        l.push('');
        l.push('copy_native_icon() {');
        l.push('  local app_bundle="$1"');
        l.push('  local out_icns="$2"');
        l.push('  local icon_name=""');
        l.push('');
        l.push('  icon_name=$(/usr/libexec/PlistBuddy -c "Print :CFBundleIconFile" "$app_bundle/Contents/Info.plist" 2>/dev/null || true)');
        l.push('  [[ -n "$icon_name" ]] || icon_name="AppIcon"');
        l.push('  [[ "$icon_name" == *.icns ]] || icon_name="${icon_name}.icns"');
        l.push('');
        l.push('  if [[ -f "$app_bundle/Contents/Resources/$icon_name" ]]; then');
        l.push('    cp "$app_bundle/Contents/Resources/$icon_name" "$out_icns"');
        l.push('    return 0');
        l.push('  fi');
        l.push('');
        l.push('  local first_icns');
        l.push('  first_icns=$(/bin/ls "$app_bundle/Contents/Resources"/*.icns 2>/dev/null | head -n 1 || true)');
        l.push('  if [[ -n "$first_icns" ]]; then');
        l.push('    cp "$first_icns" "$out_icns"');
        l.push('  fi');
        l.push('}');
        l.push('');
        l.push('resolve_app_bundle() {');
        l.push('  local app_name="$1"');
        l.push('  local candidate');
        l.push('');
        l.push('  for candidate in "/Applications/$app_name" "$HOME/Applications/$app_name"; do');
        l.push('    if [[ -d "$candidate" ]]; then');
        l.push('      printf "%s\\n" "$candidate"');
        l.push('      return 0');
        l.push('    fi');
        l.push('  done');
        l.push('');
        l.push('  return 1');
        l.push('}');
        l.push('');
        l.push('make_launcher_app() {');
        l.push('  local display_name="$1"');
        l.push('  local bundle_id="$2"');
        l.push('  local app_name="$3"');
        l.push('  local app_rel_binary="$4"');
        l.push('  local app_bundle app_binary launcher');
        l.push('');
        l.push('  if ! app_bundle="$(resolve_app_bundle "$app_name")"; then');
        l.push('    echo "Skipping ${display_name}: ${app_name} not found in /Applications or ~/Applications."');
        l.push('    return 0');
        l.push('  fi');
        l.push('');
        l.push('  app_binary="$app_bundle/$app_rel_binary"');
        l.push('  if [[ ! -x "$app_binary" ]]; then');
        l.push('    echo "Skipping ${display_name}: binary missing at ${app_binary}"');
        l.push('    return 0');
        l.push('  fi');
        l.push('');
        l.push('  launcher="$output_dir/${display_name}.app"');
        l.push('  rm -rf "$launcher"');
        l.push('  mkdir -p "$launcher/Contents/MacOS" "$launcher/Contents/Resources"');
        l.push('');
        l.push('  write_policy_file "$launcher/Contents/Resources/policy.sb"');
        l.push('');
        l.push('  cat > "$launcher/Contents/MacOS/launch" <<LAUNCH');
        l.push('#!/usr/bin/env bash');
        l.push('set -euo pipefail');
        l.push('exec /usr/bin/sandbox-exec -f "\\${BASH_SOURCE[0]%/*}/../Resources/policy.sb" -- "$app_binary" --no-sandbox "\\$@"');
        l.push('LAUNCH');
        l.push('  chmod 0755 "$launcher/Contents/MacOS/launch"');
        l.push('');
        l.push('  cat > "$launcher/Contents/Info.plist" <<PLIST');
        l.push('<?xml version="1.0" encoding="UTF-8"?>');
        l.push('<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">');
        l.push('<plist version="1.0">');
        l.push('<dict>');
        l.push('  <key>CFBundleName</key><string>${display_name}</string>');
        l.push('  <key>CFBundleDisplayName</key><string>${display_name}</string>');
        l.push('  <key>CFBundleIdentifier</key><string>${bundle_id}</string>');
        l.push('  <key>CFBundleExecutable</key><string>launch</string>');
        l.push('  <key>CFBundlePackageType</key><string>APPL</string>');
        l.push('  <key>CFBundleIconFile</key><string>AppIcon</string>');
        l.push('  <key>CFBundleVersion</key><string>1</string>');
        l.push('  <key>CFBundleShortVersionString</key><string>1.0</string>');
        l.push('</dict>');
        l.push('</plist>');
        l.push('PLIST');
        l.push('');
        l.push('  copy_native_icon "$app_bundle" "$launcher/Contents/Resources/AppIcon.icns" || true');
        l.push('  /usr/bin/touch "$launcher"');
        l.push('  echo "Created: $launcher"');
        l.push('}');
        l.push('');
        l.push('main() {');
        l.push('  if ! command -v sandbox-exec >/dev/null 2>&1; then');
        l.push('    echo "sandbox-exec was not found in PATH." >&2');
        l.push('    exit 1');
        l.push('  fi');
        l.push('');
        l.push('  mkdir -p "$output_dir"');
        l.push('');
        l.push('  make_launcher_app "Claude (Sandboxed)" "dev.agent-safehouse.launcher.claude" "Claude.app" "Contents/MacOS/Claude"');
        l.push('  make_launcher_app "VS Code (Sandboxed)" "dev.agent-safehouse.launcher.vscode" "Visual Studio Code.app" "Contents/MacOS/Electron"');
        l.push('');
        l.push('  echo ""');
        l.push('  echo "Done. Desktop launchers are in: $output_dir"');
        l.push('  echo "Tip: drag them to your Dock."');
        l.push('}');
        l.push('');
        l.push('main "$@"');

        return l.join('\n') + '\n';
      }

      function downloadLauncherSetupScript() {
        if (!lastPolicy) {
          setStatus('Generate a policy first.', 'error');
          return;
        }

        var fileName = 'create-safehouse-desktop-launchers.command';
        var script = buildLauncherSetupScript(lastPolicy);
        downloadTextFile(fileName, script, 'text/x-shellscript;charset=utf-8');
        setStatus('Downloaded ' + fileName + '. Run it with: bash /path/to/' + fileName, 'success');
      }

      render();
      syncElectron();

      document.getElementById('agents-all').addEventListener('click', function () { setGroup(AGENTS, 'agent-', true); });
      document.getElementById('agents-none').addEventListener('click', function () { setGroup(AGENTS, 'agent-', false); });
      document.getElementById('toolchains-all').addEventListener('click', function () { setGroup(TOOLCHAINS, 'toolchain-', true); });
      document.getElementById('toolchains-none').addEventListener('click', function () { setGroup(TOOLCHAINS, 'toolchain-', false); });

      document.getElementById('integration-electron').addEventListener('change', syncElectron);

      el.gen.addEventListener('click', generate);
      el.copy.addEventListener('click', copyPolicy);
      el.dl.addEventListener('click', downloadPolicy);
      el.launchers.addEventListener('click', downloadLauncherSetupScript);
    })();
  </script>
</body>
</html>
