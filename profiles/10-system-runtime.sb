;; ---------------------------------------------------------------------------
;; System Runtime
;; Process execution, tmp/dev access, system binaries, and baseline mach services.
;; Source: 10-system-runtime.sb
;; ---------------------------------------------------------------------------

;; Local LLM agents spawn shells, VCS tooling, package managers, compilers, and test runners.
;; This module keeps the minimum broad runtime surface needed for those local workflows to function.

(allow file-read*
    (subpath "/usr")                                                  ;; Core system binaries and libraries required by most spawned tools.
    (subpath "/bin")                                                  ;; POSIX userland binaries used by shell/task orchestration.
    (subpath "/sbin")                                                 ;; System utilities some build/test flows invoke.
    (subpath "/opt")                                                  ;; Homebrew and other package-manager install roots.
    (subpath "/System/Library")                                       ;; macOS runtime frameworks/resources; excludes broader /System/Volumes data paths.
    (subpath "/System/Volumes/Preboot")                               ;; Some dyld/framework lookups resolve through Preboot symlinks on modern macOS.
    (subpath "/Library/Apple")                                        ;; Apple private frameworks touched by Node/Bun/JVM/native toolchains.
    (subpath "/Library/Frameworks")                                   ;; Global framework lookup path for language runtimes and CLIs.
    (subpath "/Library/Java")                                         ;; JVM runtime and helper assets.
    (subpath "/Library/Fonts")                                        ;; Font reads used by headless renderers/PDF/image tasks.
    (subpath "/Library/Filesystems/NetFSPlugins")                     ;; Path resolution may load NetFS plugins during filesystem lookups.
    (subpath "/Library/Preferences/Logging")                          ;; macOS logging stack reads prefs during process init.
    (literal "/Library/Preferences/.GlobalPreferences.plist")         ;; Locale/time/user defaults queried by runtimes.
    (literal "/Library/Preferences/com.apple.networkd.plist")         ;; DNS/network bootstrap reads networkd config.
    (literal "/dev")                                                  ;; /dev directory listing; shells enumerate it during initialization.
)

;; Metadata-only traversal on system roots needed during binary/framework discovery for spawned local-agent tools.
(allow file-read-metadata
   (subpath "/System")                                                ;; stat/readdir traversal across /System during loader/framework path resolution.
   (subpath "/private/var/run")                                      ;; Metadata traversal for /private/var/run socket namespace.
)

;; /etc and /var are symlinks into /private/* on macOS; keep this scoped to baseline local-agent runtime needs.
(allow file-read*
    (literal "/private")                                              ;; Required for symlink traversal under macOS /private namespace.
    (literal "/private/var")                                          ;; Required for symlink traversal to /var-backed paths.
    (subpath "/private/var/db/timezone")                              ;; Timezone DB reads used by language date/time formatting.
    (literal "/private/var/select/sh")                                ;; /bin/sh selector used by macOS shell launch behavior.
    (literal "/private/var/select/developer_dir")                     ;; xcode-select developer dir pointer used by build CLIs.
    (literal "/var/select/developer_dir")                             ;; Compatibility alias for developer dir pointer.
    (literal "/private/var/db/xcode_select_link")                     ;; xcode-select link lookup used by toolchain discovery.
    (literal "/var/db/xcode_select_link")                             ;; Compatibility alias for xcode-select link lookup.
    (literal "/private/etc/hosts")                                    ;; Host override file consulted by resolver stack.
    (literal "/private/etc/resolv.conf")                              ;; DNS resolver configuration used by network clients.
    (literal "/private/etc/services")                                 ;; Service name-to-port mappings used by libc lookups.
    (literal "/private/etc/protocols")                                ;; Protocol metadata used by socket/libc helpers.
    (literal "/private/etc/profile")                                  ;; Shell startup file read by login-shell invocations.
    (literal "/private/etc/bashrc")                                   ;; Bash startup file read by spawned bash sessions.
    (literal "/private/etc/zprofile")                                 ;; Zsh startup file read by login zsh sessions.
    (literal "/private/etc/zshrc")                                    ;; Zsh startup file read by interactive zsh sessions.
    (literal "/private/etc/paths")                                    ;; PATH defaults used by shell command resolution.
    (subpath "/private/etc/paths.d")                                  ;; Additional PATH fragment directory used by macOS shells.
    (literal "/private/etc/shells")                                   ;; Valid shell list read by shell/auth tooling.
    (subpath "/private/etc/ssl")                                      ;; TLS CA bundles/certs used by HTTP and package clients.
    (literal "/private/etc/localtime")                                ;; Localtime symlink read by date/time libraries.
    ;; (subpath "/private/etc")                      ;; Compatibility fallback if a tool needs broader /etc reads.
    (literal "/etc")                                                  ;; Compatibility symlink root for tools hardcoding /etc.
    (literal "/var")                                                  ;; Compatibility symlink root for tools hardcoding /var.
)

;; Metadata-only traversal for common XDG/home probe paths used by local LLM tooling during startup.
(allow file-read-metadata
    (literal "/home")                                                 ;; Probed during path resolution by some runtimes.
    (literal "/private/etc")                                          ;; Directory traversal for /etc path resolution.
    (subpath "/dev")                                                  ;; Metadata (stat) on /dev entries; readdir() on /dev triggers this for every node.
    (home-literal "/.config")                                         ;; XDG config root traversal needed by many tools (mise, gh, git, etc.).
    (home-literal "/.cache")                                          ;; XDG cache root traversal needed by tools probing cache locations.
    (home-literal "/.local")                                          ;; XDG data root traversal needed by tools probing ~/.local paths.
    (home-literal "/.local/share")                                    ;; XDG data share dir traversal needed by tools probing data locations.
    (home-literal "/.local/bin")                                      ;; Agents stat this before installing binaries into ~/.local/bin.
)

;; User preference and shell startup reads needed when local agents launch interactive/login shells and CLI runtimes.
(allow file-read*
    (home-prefix "/Library/Preferences/.GlobalPreferences")           ;; User-level locale/defaults plist variants read by many frameworks.
    (home-prefix "/Library/Preferences/com.apple.GlobalPreferences")  ;; Apple namespaced variant of user GlobalPreferences.
    (home-subpath "/Library/Preferences/ByHost")                      ;; Per-host preferences read by security CLI and system frameworks.
    (home-literal "/.CFUserTextEncoding")                             ;; User text encoding prefs; read by many processes for correct string handling.
    (home-literal "/.zshenv")                                         ;; Zsh environment file read on every zsh invocation (incl. non-interactive).
    (home-literal "/.zprofile")                                       ;; Zsh profile file read by login zsh sessions.
    (home-literal "/.zshrc")                                          ;; Zsh interactive startup file read by interactive zsh sessions.
    (home-literal "/.zcompdump")                                      ;; Zsh completion dump cache used by compinit.
    (home-prefix "/.zcompdump")                                       ;; Versioned variants like .zcompdump-hostname-5.9.
    (home-literal "/.config")                                         ;; XDG config root directory listing for tool discovery.
    (home-literal "/.cache")                                          ;; XDG cache root directory listing for tool discovery.
)

;; We intentionally do NOT block broad process primitives by default: agent workflows frequently chain many subprocesses.
(allow process-exec)                                                  ;; Required to execute toolchain binaries, shells, and repo tools.
(allow process-fork)                                                  ;; Required for normal child-process trees in CLI agents.
(allow sysctl-read)                                                   ;; Runtime/process introspection used by many CLIs at startup.
(allow process-info-pidinfo)                                          ;; Process status polling for child supervision and cleanup.
(allow process-info-setcontrol)                                       ;; Process control metadata updates used by CLI runtimes.
(allow process-info* (target same-sandbox))                           ;; Allow process introspection within the same sandbox.
(allow signal (target same-sandbox))                                  ;; Allow signalling child processes for cancellation/termination.
(allow mach-priv-task-port (target same-sandbox))                     ;; Required by some runtimes for same-sandbox process controls.
(allow pseudo-tty)                                                    ;; Required for interactive terminal sessions and PTY allocation.

;; Temporary file and socket locations used by local agent subprocesses, package managers, and compilers.
(allow file-read* file-write*
    (subpath "/tmp")                                                  ;; Primary temp dir for transient files and IPC sockets.
    (subpath "/private/tmp")                                          ;; macOS backing path for /tmp.
    (subpath "/var/folders")                                          ;; macOS per-user temp/cache roots used by many CLIs.
    (subpath "/private/var/folders")                                  ;; macOS backing path for /var/folders.
)

;; Defense-in-depth: keep launchd-managed per-user listener sockets opt-in by specific integration profiles.
(deny file-read* file-write*
    (regex #"^/private/tmp/com\.apple\.launchd\.[^/]+/Listeners$")   ;; Real tmp namespace for launchd listener sockets (SSH agent, pasteboard, etc.).
    (regex #"^/tmp/com\.apple\.launchd\.[^/]+/Listeners$")           ;; Symlinked /tmp view of the same launchd listener sockets.
)

;; Device nodes needed for shell I/O, PTYs, and descriptor plumbing in local LLM agent terminal workflows.
(allow file-read* file-write*
    (subpath "/dev/fd")                                               ;; Process substitution and file-descriptor access (bash <(...), /dev/fd/N).
    (literal "/dev/stdout")                                           ;; Standard output stream device.
    (literal "/dev/stderr")                                           ;; Standard error stream device.
    (literal "/dev/null")                                             ;; Null sink/source device used by scripts/tools.
    (literal "/dev/tty")                                              ;; Controlling terminal device for interactive sessions.
    (literal "/dev/ptmx")                                             ;; PTY multiplexer required for pseudo-terminal allocation.
    (literal "/dev/dtracehelper")                                     ;; Compatibility for dyld/runtime startup probes on some binaries.
    (regex #"^/dev/tty")                                              ;; Dynamic tty device names created for terminal sessions.
    (regex #"^/dev/ttys")                                             ;; Alternate tty naming pattern on macOS.
    (regex #"^/dev/pty")                                              ;; Legacy PTY naming pattern used by some tools.
)

;; Read-only entropy and system probe devices touched by many runtimes spawned by local agents.
(allow file-read*
    (literal "/dev/zero")                                             ;; Zero-filled source used by some runtimes/tests.
    (literal "/dev/autofs_nowait")                                    ;; Automount readiness check probed by most CLI processes at startup.
    (literal "/dev/dtracehelper")                                     ;; DTrace helper probed by dyld at process start; harmless read avoids log noise.
    (literal "/dev/urandom")                                          ;; Non-blocking entropy source used by crypto/token generation.
    (literal "/dev/random")                                           ;; Blocking entropy source used by some security-sensitive tools.
)

;; Restrict ioctl to terminal devices plus dtracehelper probe compatibility.
(allow file-ioctl
    (literal "/dev/dtracehelper")                                     ;; Some runtimes issue ioctl probes here during startup.
    (literal "/dev/tty")                                              ;; TTY mode/attribute ioctls needed by interactive shells.
    (literal "/dev/ptmx")                                             ;; PTY master control ioctls for spawned terminal subprocesses.
    (regex #"^/dev/tty")                                              ;; Dynamic /dev/ttyN paths created for active terminal sessions.
    (regex #"^/dev/ttys")                                             ;; Alternate macOS dynamic TTY naming.
    (regex #"^/dev/pty")                                              ;; Legacy PTY naming used by some terminal libraries.
)

;; Baseline mach services commonly touched by local-agent runtimes (logging, DNS, trust, file events, identity lookups).
(allow mach-lookup
    (global-name "com.apple.system.notification_center")              ;; Notification center lookup done by some CLIs.
    (global-name "com.apple.system.opendirectoryd.libinfo")           ;; User/group resolution via opendirectory.
    (global-name "com.apple.logd")                                    ;; logd connection used by unified logging APIs.
    (global-name "com.apple.FSEvents")                                ;; File event stream access used by watchers.
    (global-name "com.apple.SystemConfiguration.configd")             ;; System network/config queries for resolver bootstrap.
    (global-name "com.apple.SystemConfiguration.DNSConfiguration")    ;; Node/c-ares DNS bootstrap XPC dependency.
    (global-name "com.apple.trustd.agent")                            ;; Baseline trust evaluation service for CFNetwork/URLSession HTTPS.
    (global-name "com.apple.diagnosticd")                             ;; Unified logging diagnosticd backend used by many system frameworks.
    (global-name "com.apple.analyticsd")                              ;; Analytics subsystem queried during runtime initializations.
    (global-name "com.apple.dnssd.service")                           ;; DNS-SD (Bonjour) service used for DNS resolution by ssh, curl, etc.
    (global-name "com.apple.CoreServices.coreservicesd")              ;; Core Services daemon for UTI type resolution and file type identification.
    (global-name "com.apple.DiskArbitration.diskarbitrationd")        ;; Disk metadata queries probed by some frameworks during init.
    (global-name "com.apple.analyticsd.messagetracer")                ;; Analytics message tracer probed by frameworks during init.
    (global-name "com.apple.system.logger")                           ;; Legacy system logger endpoint used by some CLIs.
    (global-name "com.apple.coreservices.launchservicesd")            ;; Launch Services daemon for app registration and UTI resolution.
)

(allow system-socket)                                                 ;; AF_SYSTEM sockets used by network stack for kernel event monitoring.

;; Shared-memory segment read used by NotificationCenter plumbing that some CLI frameworks touch during startup.
(allow ipc-posix-shm-read-data
    (ipc-posix-name "apple.shm.notification_center")                  ;; Notification center shared memory segment read by system frameworks.
)
