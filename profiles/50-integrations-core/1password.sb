;; ---------------------------------------------------------------------------
;; Integration: 1Password
;; 1Password desktop app and CLI agent socket access.
;; Source: 50-integrations-core/1password.sb
;; ---------------------------------------------------------------------------

(allow file-read* file-write*
    (home-subpath "/.config/op")                               ;; 1Password CLI (op) config and session tokens.
    (home-subpath "/.1password")                               ;; 1Password SSH agent symlink dir (includes ~/.1password/agent.sock).
    (subpath "/Users/Shared/.1password")                       ;; Some installs use shared path for SSH agent socket.
    (regex (string-append "^" HOME_DIR "/Library/Group Containers/[A-Za-z0-9]+\\.com\\.1password/t(/.*)?$"))       ;; 1Password SSH agent socket directory (team prefix varies).
    (regex (string-append "^" DATA_HOME_DIR "/Library/Group Containers/[A-Za-z0-9]+\\.com\\.1password/t(/.*)?$"))  ;; Data-volume variant for APFS firmlink traversal.
)

;; 1Password SSH agent config
(allow file-read*
    (home-subpath "/.config/1Password")  ;; ssh/agent.toml â€” controls which keys are offered.
)

(allow mach-lookup
    (global-name-regex #"^([A-Z0-9]+\\.)?com\\.1password\\.")  ;; 1Password app/service IPC endpoints.
    (global-name-regex #"^com\\.agilebits\\.")                 ;; Legacy AgileBits service names still used by some installs.
)
