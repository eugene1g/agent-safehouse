;; ---------------------------------------------------------------------------
;; Integration: Electron
;; Chromium/Electron runtime: GPU, Metal shaders, crashpad, and WebView.
;; Source: 55-integrations-optional/electron.sb
;; $$require=55-integrations-optional/macos-gui.sb$$
;; #safehouse-test-id:electron-integration#
;; ---------------------------------------------------------------------------

;; Chromium/Electron attempts to initialize an internal sandbox for helper
;; processes (GPU, Renderer, Utility, Network). Under safehouse, the process
;; tree is already inside macOS Seatbelt via sandbox-exec.
;;
;; Re-initializing Seatbelt from inside an existing Seatbelt sandbox is blocked
;; by the OS (sandbox_init returns EPERM / "Operation not permitted"). This is
;; not fixable with additional allow rules in this profile.
;;
;; Primary workaround under Safehouse: launch Electron with --no-sandbox.
;; Compatibility fallback: ELECTRON_DISABLE_SANDBOX=1.
;; Safehouse's outer sandbox still applies to the full process tree.

;; -- GPU / Metal shader compilation --------------------------------------------
;; #safehouse-test-id:electron-gpu-metal#

(allow mach-lookup
    (global-name "com.apple.MTLCompilerService")
    (global-name "com.apple.SafariPlatformSupport.Helper")
)

(allow iokit-open
    (iokit-user-client-class "IOSurfaceRootUserClient")
    (iokit-user-client-class "AGXDeviceUserClient")
)

(allow file-read-metadata
    (literal "/private/var/db/.AppleSetupDone")
)

;; -- Chromium crashpad crash reporting -----------------------------------------
;; #safehouse-test-id:electron-crashpad#
;; #safehouse-test-id:electron-crashpad-lookup#

(allow mach-lookup
    (global-name-regex #"^org\.chromium\.crashpad\.child_port_handshake\.")
)

;; #safehouse-test-id:electron-crashpad-register#
(allow mach-register
    (global-name-regex #"^org\.chromium\.crashpad\.child_port_handshake\.")
)
