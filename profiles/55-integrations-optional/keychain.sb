;; ---------------------------------------------------------------------------
;; Integration: Keychain
;; macOS Keychain and Security framework for agent authentication/credential storage.
;; Source: 55-integrations-optional/keychain.sb
;; ---------------------------------------------------------------------------

;; Auto-injected when a selected app/agent profile declares $$require=55-integrations-optional/keychain.sb$$.

(allow file-read* file-write*
    (home-subpath "/Library/Keychains")                        ;; Keychain DB/files for CLI login sessions using macOS credentials.
    (home-literal "/Library/Preferences/com.apple.security.plist")   ;; User security preferences read by some auth flows.
)

(allow file-read*
    (literal "/Library/Preferences/com.apple.security.plist")  ;; Security preferences read by security CLI.
    (literal "/Library/Keychains/System.keychain")             ;; System keychain read for security CLI operations.
    (subpath "/private/var/db/mds")                            ;; MDS message store; hosts se_SecurityMessages used by securityd IPC.
)

(allow file-read-metadata
    (home-literal "/Library")                                  ;; Restrict home traversal to the Library root only.
    (home-literal "/Library/Keychains")                        ;; User keychain directory metadata for login/session lookups.
    (literal "/Library")                                       ;; System Library traversal for system keychain access.
    (literal "/Library/Keychains")                             ;; System keychain directory metadata.
)

(allow mach-lookup
    (global-name "com.apple.SecurityServer")                   ;; Keychain operations depend on SecurityServer IPC.
    (global-name "com.apple.security.agent")                   ;; Login prompts/token unlock dialogs route through this service.
    (global-name "com.apple.securityd.xpc")                    ;; securityd backend needed for certificate/key queries.
    (global-name "com.apple.security.authhost")                ;; Auth host service for interactive credential flows.
    (global-name "com.apple.secd")                             ;; Secure enclave/credential mediation used by macOS security APIs.
    (global-name "com.apple.trustd")                           ;; Additional trustd backend used by some keychain/security flows.
)

(allow ipc-posix-shm-read-data ipc-posix-shm-write-create ipc-posix-shm-write-data
    (ipc-posix-name "com.apple.AppleDatabaseChanged")          ;; Keychain database change notifications via shared memory.
)
